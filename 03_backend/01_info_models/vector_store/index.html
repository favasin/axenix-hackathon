<!doctype html><html><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.124.1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Схема, стратегия chunking, HNSW-параметры и similarity-запросы для RAG-пайплайна."><title>Векторное хранилище (Qdrant)</title>
<link rel=icon href="/images/favicon.png?v=1772344967" type=image/x-icon><link rel=stylesheet rel=preload type=text/css href=/css/main.css><link rel=stylesheet type=text/css href=/css/external/all.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-thin.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-solid.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-regular.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-light.min.css><link rel=stylesheet type=text/css href=/css/external/sorttable/sorttable.min.css><link rel=stylesheet type=text/css href=/css/external/tippy/light-border.min.css><link rel=stylesheet type=text/css href=/css/external/techradar/radar.min.css><link rel=stylesheet type=text/css href=/css/external/form-js/form-js.min.css><link rel=stylesheet type=text/css href=/css/external/overlay-scrollbars/overlayscrollbars.min.css><link rel=stylesheet type=text/css href=/css/external/simplesearch/simplesearch.min.css></head><body onload=browserCompatibility()><div id=navbarInfo class="is-hidden modal-container"><div class="modal-content-box modal-text-box"><div class="card modal-title is-radiusless"><div class=card-header><p class="card-header-title is-marginless">About</p></div></div><div class=modal-content-container><div class="modal-content-block is-block"></div></div></div></div><div id=navbarShortcuts class="is-hidden modal-container"><div class="modal-content-box modal-text-box"><div class="card modal-title is-radiusless"><div class=card-header><p class="card-header-title is-marginless">Keyboard shortcuts</p></div></div><div class=modal-content-container><div class=modal-content-block><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>q</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show current page QR code</p></div><div class=modal-content><kbd>Escape</kbd></div><div class=modal-content><p class=has-text-weight-normal>Close modals</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>i</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show website information</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>k</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show shortcuts</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>h</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to homepage</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>f</kbd></div><div class=modal-content><p class=has-text-weight-normal>Find on website</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>m</kbd></div><div class=modal-content><p class=has-text-weight-normal>Collapse/Uncollapse sidebar</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>t</kbd></div><div class=modal-content><p class=has-text-weight-normal>Collapse/Uncollapse table of contents</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>↑</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to the top of the page</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>↓</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to the bottom of the page</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>p</kbd></div><div class=modal-content><p class=has-text-weight-normal>Print current page</p></div></div></div></div></div><div id=modalContainer class="is-hidden modal-container"><div id=modal class=modal-content-box></div></div><nav id=navbar class=navbar role=navigation aria-label="main navigation"><div id=navbarItemsContainer class=navbar-brand><div id=globalLogoContainer class=is-flex><a id=globalLogo class="navbar-item navbar-item-standard is-paddingless" href=/><img id=globalLogoImg alt=Homepage src="/images/logo.png?v=1772344967"><div class=logo-header-container><span>Сервис генерации презентаций</span></div></a><a id=globalTouchLogo class="navbar-item navbar-item-standard is-paddingless" href=/><img alt=Homepage src="/images/logoTouch.png?v=1772344967"></a></div><div id=navbarItems class=is-flex><div id=navbarItemsStart class=is-flex></div><div id=navbarItemsEnd class=is-flex><div class=navbar-item><a id=listDocuments class="button navbar-item-standard" href=/listdocuments/><span class=icon><i class="fa-solid fa-list"></i>
</span><span class=icon-text>&nbsp;Список документов</span></a></div><div class=navbar-item><a id=searchButton class="button navbar-item-standard" href=/search/><span class=icon><i class="fa-solid fa-magnifying-glass"></i>
</span><span class=icon-text>&nbsp;Поиск</span></a></div><div class=navbar-item><a id=printButton class="button navbar-item-standard"><span class=icon-text>Print</span>
<span class=icon><i class="fa-solid fa-print fa-lg"></i></span></a></div></div></div></div></nav><div id=navbarOverlay></div><div class="columns is-mobile is-paddingless is-marginless" id=mainContainer><div id=sidebarContainer class="column is-narrow is-paddingless is-marginless"><div id=sidebarWrapper class=is-fixed><div id=sidebar class=is-marginless><aside class="menu is-paddingless is-marginless"><ul class="menu-list is-marginless is-paddingless"><div class="card is-fs-expandable-icon"><div class=card-header><a href=/00_overview/ class=card-header-title><i class='fa-solid fa-circle-info fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/00_overview/ class=card-header-title title='Описание и артефакты анализа'><i class='fa-solid fa-circle-info fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Описание и артефакты анализа</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/00_overview/01_br/ class=card-header-title title=Требования><i class='fa-solid fa-folder-open'></i><p class="pt-0 pb-0 pr-2 pl-1">Требования</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/01_br/ class=card-header-title title='Бизнес-контекст и БТ'><i class='fa-solid fa-circle-info'></i><p class="pt-0 pb-0 pr-2 pl-1">Бизнес-контекст и БТ</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/02_actors/ class=card-header-title title='Акторы и границы системы'><i class='fa-solid fa-users'></i><p class="pt-0 pb-0 pr-2 pl-1">Акторы и границы системы</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/03_fr_documents/ class=card-header-title title='FR_01: Загрузка и индексация документов'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_01: Загрузка и индексация документов</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/04_fr_rag/ class=card-header-title title='FR_02: RAG-поиск и генерация презентаций'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_02: RAG-поиск и генерация презентаций</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/05_fr_users/ class=card-header-title title='FR_03: Управление пользователями'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_03: Управление пользователями</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/06_fr_admin/ class=card-header-title title='FR_04: Администрирование'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_04: Администрирование</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/07_nonfunctional/ class=card-header-title title='Нефункциональные требования'><i class='fa-solid fa-gauge-high'></i><p class="pt-0 pb-0 pr-2 pl-1">Нефункциональные требования</p></a></div></div></li></div></div></ul></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/02_constraints/ class=card-header-title title='Ограничения и допущения'><i class='fa-solid fa-lock'></i><p class="pt-0 pb-0 pr-2 pl-1">Ограничения и допущения</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/03_interfaces/ class=card-header-title title=Интерфейсы><i class='fa-solid fa-plug'></i><p class="pt-0 pb-0 pr-2 pl-1">Интерфейсы</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/04_quality_metrics/ class=card-header-title title='Метрики качества и итоговая сводка'><i class='fa-solid fa-chart-bar'></i><p class="pt-0 pb-0 pr-2 pl-1">Метрики качества и итоговая сводка</p></a></div></div></li></div></div></ul></li></div></div><div class="card is-fs-expandable-icon"><div class="card-header is-single-link"><a href=/01_architecture/ class=card-header-title><i class='fa-solid fa-diagram-project fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/01_architecture/ class=card-header-title title=Архитектура><i class='fa-solid fa-diagram-project fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Архитектура</p></a></div></div></li></div></div><div class="card is-fs-expandable-icon is-sidebar-active"><div class=card-header><a href=/03_backend/ class=card-header-title><i class='fa-solid fa-server fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class="is-marginless is-tree-active is-entries-expandable is-entries-expanded"><div class=card><div class=card-header><a href=/03_backend/ class=card-header-title title=Backend><i class='fa-solid fa-server fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Backend</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-expanded"><span class=icon></span></a></div></div><ul class="is-marginless is-tree-active"><div><div><li class="is-marginless is-entries-expandable is-entries-expanded"><div class=card><div class=card-header><a href=/03_backend/01_info_models/ class=card-header-title title='Модель данных и базы данных'><i class='fa-solid fa-database'></i><p class="pt-0 pb-0 pr-2 pl-1">Модель данных и базы данных</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-expanded"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/relational/ class=card-header-title title='Реляционные таблицы (PostgreSQL)'><i class='fa-solid fa-table'></i><p class="pt-0 pb-0 pr-2 pl-1">Реляционные таблицы (PostgreSQL)</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/documents/ class=card-header-title title='Документные коллекции'><i class='fa-solid fa-file-code'></i><p class="pt-0 pb-0 pr-2 pl-1">Документные коллекции</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class="card is-sidebar-active" id=sidebarActiveEntry><div class="card-header is-single-link"><a href=/03_backend/01_info_models/vector_store/ class=card-header-title title='Векторное хранилище (Qdrant)'><i class='fa-solid fa-magnifying-glass-chart'></i><p class="pt-0 pb-0 pr-2 pl-1">Векторное хранилище (Qdrant)</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/cache/ class=card-header-title title='Кэш и очереди (Redis)'><i class='fa-solid fa-bolt'></i><p class="pt-0 pb-0 pr-2 pl-1">Кэш и очереди (Redis)</p></a></div></div></li></div></div></ul></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/ class=card-header-title title='REST API'><i class='fa-solid fa-route'></i><p class="pt-0 pb-0 pr-2 pl-1">REST API</p></a></div></div></li></div></div></ul></li></div></div><div class="card is-fs-expandable-icon"><div class="card-header is-single-link"><a href=/02_frontend/ class=card-header-title><i class='fa-solid fa-display fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/ class=card-header-title title=Frontend><i class='fa-solid fa-display fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Frontend</p></a></div></div></li></div></div></ul></aside></div><div id=sidebarCollapsible class=is-marginless><div class="card is-uncollapse-action"><div id=sidebarUncollapse class="card-header is-single-link" title="Collapse/Uncollapse sidebar"><a class=card-header-title><i class="fa-solid fa-angles-right fa-lg"></i></a></div></div><div class="card is-collapse-action"><div id=sidebarCollapse class="card-header is-single-link" title="Collapse/Uncollapse sidebar"><a class=card-header-title><i class="fa-solid fa-angles-left fa-lg"></i><p>Collapse sidebar</p></a></div></div></div></div></div><div id=sidebarMobileWrapper class="column is-narrow is-hidden-desktop"></div><div class="columns is-mobile is-marginless is-scroll-smooth has-toc is-toc-collapsed" id=contentContainer><div class=column id=content data-pagefind-body><style>ul.breadcrumb{padding:10px 15px;list-style:none;background-color:#eee}ul.breadcrumb li{display:inline;font-size:14px}ul.breadcrumb li+li:before{padding:8px;color:#000;content:"/\00a0"}ul.breadcrumb li a{color:#0275d8;text-decoration:none}ul.breadcrumb li a:hover{color:#01447e;text-decoration:underline}</style><ul id=breadcrumbs class=breadcrumb><li><a href=/>Промпт-инжиниринг</a></li><li><a href=/03_backend/>Backend</a></li><li><a href=/03_backend/01_info_models/>Модель данных и базы данных</a></li><li><a href=/03_backend/01_info_models/vector_store/>Векторное хранилище (Qdrant)</a></li></ul><div id=contentTitle>Векторное хранилище (Qdrant)</div><h1 id=векторное-хранилище-qdrant>Векторное хранилище: Qdrant<a href=#%d0%b2%d0%b5%d0%ba%d1%82%d0%be%d1%80%d0%bd%d0%be%d0%b5-%d1%85%d1%80%d0%b0%d0%bd%d0%b8%d0%bb%d0%b8%d1%89%d0%b5-qdrant class=anchor>#</a></h1><blockquote><p><strong>Версия Qdrant:</strong> 1.9+
<strong>Модель эмбеддингов:</strong> <code>text-embedding-3-large</code> (OpenAI) / <code>BGE-M3</code> (on-premise)
<strong>Размерность вектора:</strong> 3072 (text-embedding-3-large) / 1024 (BGE-M3)
<strong>Метрика расстояния:</strong> Cosine similarity</p></blockquote><hr><h2 id=архитектура-коллекций>Архитектура коллекций<a href=#%d0%b0%d1%80%d1%85%d0%b8%d1%82%d0%b5%d0%ba%d1%82%d1%83%d1%80%d0%b0-%d0%ba%d0%be%d0%bb%d0%bb%d0%b5%d0%ba%d1%86%d0%b8%d0%b9 class=anchor>#</a></h2><p>Изоляция тенантов реализована через <strong>отдельную коллекцию на организацию</strong>:</p><pre tabindex=0><code>org_{organization_id}_docs   — документы организации
</code></pre><p>Это обеспечивает:</p><ul><li>Полную изоляцию данных (Enterprise требование)</li><li>Независимое масштабирование коллекций</li><li>Возможность удаления всех данных тенанта одной операцией</li></ul><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph TD
    subgraph Qdrant
        C1[&#34;org_018e9a1f_docs\nTenant A&#34;]
        C2[&#34;org_029f0b2e_docs\nTenant B&#34;]
        C3[&#34;org_03a1c3f0_docs\nTenant C (Enterprise)&#34;]
    end

    subgraph &#34;RAG Service&#34;
        RS[&#34;Retrieval\nService&#34;]
        ING[&#34;Ingestion\nService&#34;]
    end

    ING --&gt;|&#34;upsert vectors&#34;| C1
    ING --&gt;|&#34;upsert vectors&#34;| C2
    RS --&gt;|&#34;search(collection=org_{id})&#34;| C1
    RS --&gt;|&#34;search(collection=org_{id})&#34;| C2
</code></pre><hr><h2 id=схема-записи-векторачанка>Схема записи (вектора/чанка)<a href=#%d1%81%d1%85%d0%b5%d0%bc%d0%b0-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d0%b8-%d0%b2%d0%b5%d0%ba%d1%82%d0%be%d1%80%d0%b0%d1%87%d0%b0%d0%bd%d0%ba%d0%b0 class=anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>DocumentChunk</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Идентификатор записи в Qdrant
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;                     <span style=color:#75715e>// UUID v4, совпадает с chunk_id в метаданных Qdrant
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Вектор
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>vector</span>: <span style=color:#66d9ef>number</span>[];               <span style=color:#75715e>// float32[3072] — text-embedding-3-large
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Payload (метаданные, фильтруемые при поиске)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>payload</span>: <span style=color:#66d9ef>ChunkPayload</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ChunkPayload</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Привязка к источнику
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>source_document_id</span>: <span style=color:#66d9ef>string</span>;     <span style=color:#75715e>// UUID → source_documents.id в PostgreSQL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>organization_id</span>: <span style=color:#66d9ef>string</span>;        <span style=color:#75715e>// UUID тенанта (дублирование для быстрой фильтрации)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>presentation_ids</span>: <span style=color:#66d9ef>string</span>[];     <span style=color:#75715e>// UUID[] — в каких презентациях используется
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Содержимое чанка
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>text</span>: <span style=color:#66d9ef>string</span>;                   <span style=color:#75715e>// Исходный текст чанка (до 512 токенов)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>text_length</span>: <span style=color:#66d9ef>number</span>;            <span style=color:#75715e>// Длина в символах
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>token_count</span>: <span style=color:#66d9ef>number</span>;            <span style=color:#75715e>// Примерное количество токенов
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Локализация в документе
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>chunk_index</span>: <span style=color:#66d9ef>number</span>;            <span style=color:#75715e>// Порядковый номер чанка в документе (0-based)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>chunk_total</span>: <span style=color:#66d9ef>number</span>;            <span style=color:#75715e>// Общее количество чанков в документе
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>page_number?</span>: <span style=color:#66d9ef>number</span>;           <span style=color:#75715e>// Номер страницы (для PDF/DOCX)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>page_total?</span>: <span style=color:#66d9ef>number</span>;            <span style=color:#75715e>// Всего страниц
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>section_title?</span>: <span style=color:#66d9ef>string</span>;         <span style=color:#75715e>// Заголовок раздела/секции (если распознан)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>table_index?</span>: <span style=color:#66d9ef>number</span>;           <span style=color:#75715e>// Номер таблицы (для Excel/CSV чанков)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Метаданные источника
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>source_filename</span>: <span style=color:#66d9ef>string</span>;        <span style=color:#75715e>// Оригинальное имя файла
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>file_type</span>: <span style=color:#66d9ef>string</span>;              <span style=color:#75715e>// &#39;pdf&#39; | &#39;docx&#39; | &#39;xlsx&#39; | &#39;csv&#39; | &#39;pptx&#39; | &#39;url&#39; | &#39;image&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>source_url?</span>: <span style=color:#66d9ef>string</span>;            <span style=color:#75715e>// URL (для web-источников)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>language</span>: <span style=color:#66d9ef>string</span>;               <span style=color:#75715e>// BCP 47: &#39;ru&#39;, &#39;en-US&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Временные метки
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>extracted_at</span>: <span style=color:#66d9ef>string</span>;           <span style=color:#75715e>// ISO 8601 — время извлечения из документа
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>indexed_at</span>: <span style=color:#66d9ef>string</span>;             <span style=color:#75715e>// ISO 8601 — время индексации в Qdrant
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>source_modified_at?</span>: <span style=color:#66d9ef>string</span>;    <span style=color:#75715e>// Дата изменения исходного файла
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Контентные теги (для точной фильтрации)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>contains_numbers</span>: <span style=color:#66d9ef>boolean</span>;      <span style=color:#75715e>// Есть ли числовые данные
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>contains_table</span>: <span style=color:#66d9ef>boolean</span>;        <span style=color:#75715e>// Является ли табличными данными
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>content_type</span>: <span style=color:#66d9ef>string</span>;           <span style=color:#75715e>// &#39;text&#39; | &#39;table&#39; | &#39;chart_data&#39; | &#39;heading&#39; | &#39;list&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>embedding_model</span>: <span style=color:#66d9ef>string</span>;        <span style=color:#75715e>// &#39;text-embedding-3-large&#39; | &#39;bge-m3&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><hr><h2 id=диаграмма-структуры>Диаграмма структуры<a href=#%d0%b4%d0%b8%d0%b0%d0%b3%d1%80%d0%b0%d0%bc%d0%bc%d0%b0-%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%82%d1%83%d1%80%d1%8b class=anchor>#</a></h2><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR
    subgraph &#34;Ingestion Pipeline&#34;
        DOC[&#34;Source Document\n(PDF/DOCX/XLSX/URL)&#34;]
        PARSE[&#34;Parser\n(Tika/unstructured.io)&#34;]
        CHUNK[&#34;Chunker\n512 tok, overlap 64&#34;]
        EMBED[&#34;Embedder\ntext-embedding-3-large&#34;]
        META[&#34;Metadata\nEnricher&#34;]
    end

    subgraph &#34;Qdrant Collection: org_{id}_docs&#34;
        direction TB
        VEC[&#34;Vector\nfloat32[3072]&#34;]
        PAY[&#34;Payload\nChunkPayload&#34;]
        IDX_H[&#34;HNSW Index\nm=16, ef=200&#34;]
        IDX_F[&#34;Filterable Fields\nsource_document_id\nfile_type\ncontains_numbers\ncontent_type&#34;]
    end

    subgraph &#34;Retrieval Pipeline&#34;
        QUERY[&#34;User Query /\nSlide Context&#34;]
        E2[&#34;Query Embedder&#34;]
        SEARCH[&#34;Similarity Search\ntop_k=8, threshold=0.75&#34;]
        RERANK[&#34;Cross-Encoder\nRe-ranker&#34;]
        RESULT[&#34;Ranked Chunks\nwith Attribution&#34;]
    end

    DOC --&gt; PARSE --&gt; CHUNK --&gt; EMBED --&gt; META
    META --&gt;|&#34;upsert&#34;| VEC
    META --&gt;|&#34;upsert&#34;| PAY
    VEC --&gt; IDX_H
    PAY --&gt; IDX_F

    QUERY --&gt; E2 --&gt; SEARCH
    SEARCH --&gt;|&#34;vector similarity&#34;| IDX_H
    SEARCH --&gt;|&#34;payload filter&#34;| IDX_F
    SEARCH --&gt; RERANK --&gt; RESULT
</code></pre><hr><h2 id=стратегия-chunking>Стратегия Chunking<a href=#%d1%81%d1%82%d1%80%d0%b0%d1%82%d0%b5%d0%b3%d0%b8%d1%8f-chunking class=anchor>#</a></h2><h3 id=параметры>Параметры<a href=#%d0%bf%d0%b0%d1%80%d0%b0%d0%bc%d0%b5%d1%82%d1%80%d1%8b class=anchor>#</a></h3><table><thead><tr><th>Параметр</th><th>Значение</th><th>Обоснование</th></tr></thead><tbody><tr><td>Размер чанка</td><td>512 токенов</td><td>Баланс между контекстом и точностью поиска</td></tr><tr><td>Overlap</td><td>64 токена</td><td>~12.5% перекрытия для сохранения контекста на границе</td></tr><tr><td>Метод разбиения</td><td>Рекурсивный по разделителям</td><td>Учёт структуры документа</td></tr></tbody></table><h3 id=алгоритм-рекурсивного-разбиения>Алгоритм рекурсивного разбиения<a href=#%d0%b0%d0%bb%d0%b3%d0%be%d1%80%d0%b8%d1%82%d0%bc-%d1%80%d0%b5%d0%ba%d1%83%d1%80%d1%81%d0%b8%d0%b2%d0%bd%d0%be%d0%b3%d0%be-%d1%80%d0%b0%d0%b7%d0%b1%d0%b8%d0%b5%d0%bd%d0%b8%d1%8f class=anchor>#</a></h3><p>Разделители применяются в порядке приоритета:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>SEPARATORS <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n\n\n</span><span style=color:#e6db74>&#34;</span>,   <span style=color:#75715e># 1. Разрыв между секциями (3+ пустые строки)</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>,     <span style=color:#75715e># 2. Параграфы</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,       <span style=color:#75715e># 3. Строки</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;. &#34;</span>,       <span style=color:#75715e># 4. Предложения</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34; &#34;</span>,        <span style=color:#75715e># 5. Слова (крайний случай)</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><h3 id=специальная-обработка-по-типам>Специальная обработка по типам<a href=#%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d1%8c%d0%bd%d0%b0%d1%8f-%d0%be%d0%b1%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%ba%d0%b0-%d0%bf%d0%be-%d1%82%d0%b8%d0%bf%d0%b0%d0%bc class=anchor>#</a></h3><table><thead><tr><th>Тип файла</th><th>Стратегия</th></tr></thead><tbody><tr><td><strong>PDF/DOCX</strong></td><td>Разбивка по параграфам, заголовки сохраняются как <code>section_title</code>. Каждая страница — отдельный семантический блок</td></tr><tr><td><strong>XLSX/CSV</strong></td><td>Каждая таблица как единый чанк (до 512 токен), иначе — по строкам с заголовком. <code>contains_table = true</code></td></tr><tr><td><strong>PPTX</strong></td><td>Каждый слайд — отдельный чанк. Заголовок слайда → <code>section_title</code></td></tr><tr><td><strong>URL</strong></td><td>HTML-to-markdown → рекурсивное разбиение. Мета-теги → <code>section_title</code></td></tr><tr><td><strong>Изображения</strong></td><td>OCR-текст → стандартное разбиение. <code>content_type = 'ocr_text'</code></td></tr></tbody></table><h3 id=обработка-перекрытий>Обработка перекрытий<a href=#%d0%be%d0%b1%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%ba%d0%b0-%d0%bf%d0%b5%d1%80%d0%b5%d0%ba%d1%80%d1%8b%d1%82%d0%b8%d0%b9 class=anchor>#</a></h3><pre tabindex=0><code>[Chunk 1: tokens 0-511  ]
                  [Chunk 2: tokens 448-959]
                                    [Chunk 3: tokens 896-1407]
         ← 64 tok →       ← 64 tok →
            overlap           overlap
</code></pre><hr><h2 id=параметры-hnsw-индекса>Параметры HNSW-индекса<a href=#%d0%bf%d0%b0%d1%80%d0%b0%d0%bc%d0%b5%d1%82%d1%80%d1%8b-hnsw-%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d0%b0 class=anchor>#</a></h2><table><thead><tr><th>Параметр</th><th>Значение</th><th>Описание</th></tr></thead><tbody><tr><td><code>m</code></td><td>16</td><td>Количество bi-directional связей на узел. При 16 — оптимальный баланс качество/память</td></tr><tr><td><code>ef_construction</code></td><td>200</td><td>Размер динамического списка при построении. Больше = точнее индекс, медленнее построение</td></tr><tr><td><code>ef_search</code> (runtime)</td><td>128</td><td>Размер beam при поиске. Рекомендуется ef ≥ top_k × 4</td></tr><tr><td><code>full_scan_threshold</code></td><td>10 000</td><td>До этого числа векторов — брутфорс точнее HNSW</td></tr><tr><td><code>on_disk</code></td><td>true</td><td>Векторы хранятся на диске (mmap) при > 1M векторов</td></tr><tr><td>Метрика</td><td>Cosine</td><td>Оптимальна для text embeddings; нормализация включена</td></tr></tbody></table><h3 id=конфигурация-коллекции-qdrant-api>Конфигурация коллекции (Qdrant API)<a href=#%d0%ba%d0%be%d0%bd%d1%84%d0%b8%d0%b3%d1%83%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d0%ba%d0%be%d0%bb%d0%bb%d0%b5%d0%ba%d1%86%d0%b8%d0%b8-qdrant-api class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> qdrant_client <span style=color:#f92672>import</span> QdrantClient
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> qdrant_client.models <span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    VectorParams, Distance, HnswConfigDiff,
</span></span><span style=display:flex><span>    OptimizersConfigDiff, PayloadSchemaType
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> QdrantClient(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://qdrant:6333&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>create_collection(
</span></span><span style=display:flex><span>    collection_name<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;org_</span><span style=color:#e6db74>{</span>organization_id<span style=color:#e6db74>}</span><span style=color:#e6db74>_docs&#34;</span>,
</span></span><span style=display:flex><span>    vectors_config<span style=color:#f92672>=</span>VectorParams(
</span></span><span style=display:flex><span>        size<span style=color:#f92672>=</span><span style=color:#ae81ff>3072</span>,                      <span style=color:#75715e># text-embedding-3-large</span>
</span></span><span style=display:flex><span>        distance<span style=color:#f92672>=</span>Distance<span style=color:#f92672>.</span>COSINE,
</span></span><span style=display:flex><span>        on_disk<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,                   <span style=color:#75715e># Хранение на диске для больших коллекций</span>
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    hnsw_config<span style=color:#f92672>=</span>HnswConfigDiff(
</span></span><span style=display:flex><span>        m<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>,
</span></span><span style=display:flex><span>        ef_construct<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>        full_scan_threshold<span style=color:#f92672>=</span><span style=color:#ae81ff>10_000</span>,
</span></span><span style=display:flex><span>        on_disk<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    optimizers_config<span style=color:#f92672>=</span>OptimizersConfigDiff(
</span></span><span style=display:flex><span>        deleted_threshold<span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span>,          <span style=color:#75715e># Перестроить при 20% удалённых</span>
</span></span><span style=display:flex><span>        vacuum_min_vector_number<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>        default_segment_number<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>        max_segment_size<span style=color:#f92672>=</span><span style=color:#ae81ff>200_000</span>,       <span style=color:#75715e># ~200k векторов на сегмент</span>
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Создать индексы по payload-полям для фильтрации</span>
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>create_payload_index(
</span></span><span style=display:flex><span>    collection_name<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;org_</span><span style=color:#e6db74>{</span>organization_id<span style=color:#e6db74>}</span><span style=color:#e6db74>_docs&#34;</span>,
</span></span><span style=display:flex><span>    field_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;source_document_id&#34;</span>,
</span></span><span style=display:flex><span>    field_schema<span style=color:#f92672>=</span>PayloadSchemaType<span style=color:#f92672>.</span>KEYWORD,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>create_payload_index(
</span></span><span style=display:flex><span>    collection_name<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;org_</span><span style=color:#e6db74>{</span>organization_id<span style=color:#e6db74>}</span><span style=color:#e6db74>_docs&#34;</span>,
</span></span><span style=display:flex><span>    field_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;file_type&#34;</span>,
</span></span><span style=display:flex><span>    field_schema<span style=color:#f92672>=</span>PayloadSchemaType<span style=color:#f92672>.</span>KEYWORD,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>create_payload_index(
</span></span><span style=display:flex><span>    collection_name<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;org_</span><span style=color:#e6db74>{</span>organization_id<span style=color:#e6db74>}</span><span style=color:#e6db74>_docs&#34;</span>,
</span></span><span style=display:flex><span>    field_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;contains_numbers&#34;</span>,
</span></span><span style=display:flex><span>    field_schema<span style=color:#f92672>=</span>PayloadSchemaType<span style=color:#f92672>.</span>BOOL,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>create_payload_index(
</span></span><span style=display:flex><span>    collection_name<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;org_</span><span style=color:#e6db74>{</span>organization_id<span style=color:#e6db74>}</span><span style=color:#e6db74>_docs&#34;</span>,
</span></span><span style=display:flex><span>    field_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;content_type&#34;</span>,
</span></span><span style=display:flex><span>    field_schema<span style=color:#f92672>=</span>PayloadSchemaType<span style=color:#f92672>.</span>KEYWORD,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><hr><h2 id=пример-similarity-запроса-с-фильтрами>Пример similarity-запроса с фильтрами<a href=#%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%80-similarity-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d0%b0-%d1%81-%d1%84%d0%b8%d0%bb%d1%8c%d1%82%d1%80%d0%b0%d0%bc%d0%b8 class=anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> qdrant_client <span style=color:#f92672>import</span> QdrantClient
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> qdrant_client.models <span style=color:#f92672>import</span> Filter, FieldCondition, MatchValue, SearchRequest
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> openai <span style=color:#f92672>import</span> OpenAI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openai_client <span style=color:#f92672>=</span> OpenAI()
</span></span><span style=display:flex><span>qdrant_client <span style=color:#f92672>=</span> QdrantClient(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://qdrant:6333&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>retrieve_chunks_for_slide</span>(
</span></span><span style=display:flex><span>    query_text: str,
</span></span><span style=display:flex><span>    organization_id: str,
</span></span><span style=display:flex><span>    source_document_ids: list[str],  <span style=color:#75715e># Фильтр по загруженным документам презентации</span>
</span></span><span style=display:flex><span>    top_k: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>    score_threshold: float <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.72</span>,
</span></span><span style=display:flex><span>    prefer_numeric: bool <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>,    <span style=color:#75715e># Для fact-check запросов</span>
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> list[dict]:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Similarity-поиск чанков с фильтрацией по документам и приоритизацией числовых данных.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 1. Получить embedding запроса</span>
</span></span><span style=display:flex><span>    embedding_response <span style=color:#f92672>=</span> openai_client<span style=color:#f92672>.</span>embeddings<span style=color:#f92672>.</span>create(
</span></span><span style=display:flex><span>        model<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text-embedding-3-large&#34;</span>,
</span></span><span style=display:flex><span>        input<span style=color:#f92672>=</span>query_text,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    query_vector <span style=color:#f92672>=</span> embedding_response<span style=color:#f92672>.</span>data[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>embedding
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 2. Построить фильтр</span>
</span></span><span style=display:flex><span>    must_conditions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        FieldCondition(
</span></span><span style=display:flex><span>            key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;source_document_id&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>match</span><span style=color:#f92672>=</span>MatchValue(any<span style=color:#f92672>=</span>source_document_ids)  <span style=color:#75715e># Только документы презентации</span>
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Если ищем числовые факты — приоритизировать чанки с числами</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> prefer_numeric:
</span></span><span style=display:flex><span>        must_conditions<span style=color:#f92672>.</span>append(
</span></span><span style=display:flex><span>            FieldCondition(key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;contains_numbers&#34;</span>, <span style=color:#66d9ef>match</span><span style=color:#f92672>=</span>MatchValue(value<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>))
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    query_filter <span style=color:#f92672>=</span> Filter(must<span style=color:#f92672>=</span>must_conditions)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 3. Выполнить similarity search</span>
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> qdrant_client<span style=color:#f92672>.</span>search(
</span></span><span style=display:flex><span>        collection_name<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;org_</span><span style=color:#e6db74>{</span>organization_id<span style=color:#e6db74>}</span><span style=color:#e6db74>_docs&#34;</span>,
</span></span><span style=display:flex><span>        query_vector<span style=color:#f92672>=</span>query_vector,
</span></span><span style=display:flex><span>        query_filter<span style=color:#f92672>=</span>query_filter,
</span></span><span style=display:flex><span>        limit<span style=color:#f92672>=</span>top_k <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>,               <span style=color:#75715e># Берём больше для re-ranking</span>
</span></span><span style=display:flex><span>        score_threshold<span style=color:#f92672>=</span>score_threshold,
</span></span><span style=display:flex><span>        with_payload<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>        with_vectors<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,            <span style=color:#75715e># Векторы не нужны в ответе</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 4. Re-ranking (cross-encoder) при наличии достаточно результатов</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(results) <span style=color:#f92672>&gt;</span> top_k:
</span></span><span style=display:flex><span>        results <span style=color:#f92672>=</span> cross_encoder_rerank(query_text, results, top_k)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 5. Форматировать для LLM-контекста</span>
</span></span><span style=display:flex><span>    chunks <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> point <span style=color:#f92672>in</span> results:
</span></span><span style=display:flex><span>        payload <span style=color:#f92672>=</span> point<span style=color:#f92672>.</span>payload
</span></span><span style=display:flex><span>        chunks<span style=color:#f92672>.</span>append({
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;chunk_id&#34;</span>: str(point<span style=color:#f92672>.</span>id),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;text&#34;</span>: payload[<span style=color:#e6db74>&#34;text&#34;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;similarity_score&#34;</span>: point<span style=color:#f92672>.</span>score,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;source&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;source_document_id&#34;</span>: payload[<span style=color:#e6db74>&#34;source_document_id&#34;</span>],
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;filename&#34;</span>: payload[<span style=color:#e6db74>&#34;source_filename&#34;</span>],
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;page_number&#34;</span>: payload<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;page_number&#34;</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;section_title&#34;</span>: payload<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;section_title&#34;</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;file_type&#34;</span>: payload[<span style=color:#e6db74>&#34;file_type&#34;</span>],
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;contains_numbers&#34;</span>: payload[<span style=color:#e6db74>&#34;contains_numbers&#34;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;content_type&#34;</span>: payload[<span style=color:#e6db74>&#34;content_type&#34;</span>],
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> chunks
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Пример вызова</span>
</span></span><span style=display:flex><span>chunks <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> retrieve_chunks_for_slide(
</span></span><span style=display:flex><span>    query_text<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Какой объём рынка AI-презентаций и темп роста?&#34;</span>,
</span></span><span style=display:flex><span>    organization_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345680&#34;</span>,
</span></span><span style=display:flex><span>    source_document_ids<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345682&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345683&#34;</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    top_k<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>    prefer_numeric<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,  <span style=color:#75715e># Ищем числовые данные о рынке</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=пример-ответа>Пример ответа<a href=#%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%80-%d0%be%d1%82%d0%b2%d0%b5%d1%82%d0%b0 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;chunk_id&#34;</span>: <span style=color:#e6db74>&#34;chunk_a1b2c3d4-e5f6-7890-abcd-ef0123456789&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;Глобальный рынок AI-инструментов для создания презентаций оценивается в $2.1 млрд в 2026 году. Ожидаемый CAGR составляет 35% в период 2024–2028...&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;similarity_score&#34;</span>: <span style=color:#ae81ff>0.942</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;source&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;source_document_id&#34;</span>: <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345682&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;market_research_2026.pdf&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;page_number&#34;</span>: <span style=color:#ae81ff>12</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;section_title&#34;</span>: <span style=color:#e6db74>&#34;Анализ рынка&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;file_type&#34;</span>: <span style=color:#e6db74>&#34;pdf&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contains_numbers&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;content_type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;chunk_id&#34;</span>: <span style=color:#e6db74>&#34;chunk_b2c3d4e5-f6a7-8901-bcde-f01234567890&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;| Год | Объём рынка ($B) | YoY рост |\n|-----|----------------|----------|\n| 2024 | 1.15 | — |\n| 2025 | 1.56 | 35.6% |\n| 2026 | 2.11 | 35.3% |&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;similarity_score&#34;</span>: <span style=color:#ae81ff>0.891</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;source&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;source_document_id&#34;</span>: <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345682&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;market_research_2026.pdf&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;page_number&#34;</span>: <span style=color:#ae81ff>14</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;section_title&#34;</span>: <span style=color:#e6db74>&#34;Динамика рынка&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;file_type&#34;</span>: <span style=color:#e6db74>&#34;pdf&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contains_numbers&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;content_type&#34;</span>: <span style=color:#e6db74>&#34;table&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><hr><h2 id=стратегия-обновления-чанков-при-изменении-источника>Стратегия обновления чанков при изменении источника<a href=#%d1%81%d1%82%d1%80%d0%b0%d1%82%d0%b5%d0%b3%d0%b8%d1%8f-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f-%d1%87%d0%b0%d0%bd%d0%ba%d0%be%d0%b2-%d0%bf%d1%80%d0%b8-%d0%b8%d0%b7%d0%bc%d0%b5%d0%bd%d0%b5%d0%bd%d0%b8%d0%b8-%d0%b8%d1%81%d1%82%d0%be%d1%87%d0%bd%d0%b8%d0%ba%d0%b0 class=anchor>#</a></h2><h3 id=сценарий-пользователь-повторно-загружает-обновлённую-версию-документа>Сценарий: пользователь повторно загружает обновлённую версию документа<a href=#%d1%81%d1%86%d0%b5%d0%bd%d0%b0%d1%80%d0%b8%d0%b9-%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d1%82%d0%b5%d0%bb%d1%8c-%d0%bf%d0%be%d0%b2%d1%82%d0%be%d1%80%d0%bd%d0%be-%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b6%d0%b0%d0%b5%d1%82-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d1%91%d0%bd%d0%bd%d1%83%d1%8e-%d0%b2%d0%b5%d1%80%d1%81%d0%b8%d1%8e-%d0%b4%d0%be%d0%ba%d1%83%d0%bc%d0%b5%d0%bd%d1%82%d0%b0 class=anchor>#</a></h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart TD
    A[&#34;Пользователь загружает\nновую версию файла&#34;] --&gt; B[&#34;Вычислить SHA-256\nнового файла&#34;]
    B --&gt; C{&#34;Хеш совпадает\nс существующим?&#34;}
    C --&gt;|&#34;Да — дубликат&#34;| D[&#34;Вернуть существующий\nsource_document_id&#34;]
    C --&gt;|&#34;Нет — изменён&#34;| E[&#34;Создать новую запись\nв source_documents&#34;]
    E --&gt; F[&#34;Запустить ingestion job\nдля нового документа&#34;]
    F --&gt; G[&#34;Удалить старые чанки\nиз Qdrant&#34;]
    G --&gt; H[&#34;Вставить новые чанки\nс новыми embeddings&#34;]
    H --&gt; I[&#34;Обновить source_document_id\nв presentation_sources&#34;]
    I --&gt; J[&#34;Уведомить пользователя:\n&#39;Источник обновлён&#39;&#34;]
</code></pre><h3 id=алгоритм-атомарного-обновления-чанков>Алгоритм атомарного обновления чанков<a href=#%d0%b0%d0%bb%d0%b3%d0%be%d1%80%d0%b8%d1%82%d0%bc-%d0%b0%d1%82%d0%be%d0%bc%d0%b0%d1%80%d0%bd%d0%be%d0%b3%d0%be-%d0%be%d0%b1%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f-%d1%87%d0%b0%d0%bd%d0%ba%d0%be%d0%b2 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>update_document_chunks</span>(
</span></span><span style=display:flex><span>    old_source_document_id: str,
</span></span><span style=display:flex><span>    new_source_document_id: str,
</span></span><span style=display:flex><span>    organization_id: str,
</span></span><span style=display:flex><span>    new_chunks: list[ChunkPayload],
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    collection <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;org_</span><span style=color:#e6db74>{</span>organization_id<span style=color:#e6db74>}</span><span style=color:#e6db74>_docs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 1. Найти все старые чанки документа</span>
</span></span><span style=display:flex><span>    old_chunk_ids <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    offset <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        results, offset <span style=color:#f92672>=</span> qdrant_client<span style=color:#f92672>.</span>scroll(
</span></span><span style=display:flex><span>            collection_name<span style=color:#f92672>=</span>collection,
</span></span><span style=display:flex><span>            scroll_filter<span style=color:#f92672>=</span>Filter(must<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>                FieldCondition(key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;source_document_id&#34;</span>,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>match</span><span style=color:#f92672>=</span>MatchValue(value<span style=color:#f92672>=</span>old_source_document_id))
</span></span><span style=display:flex><span>            ]),
</span></span><span style=display:flex><span>            limit<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>            with_payload<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,
</span></span><span style=display:flex><span>            offset<span style=color:#f92672>=</span>offset,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        old_chunk_ids<span style=color:#f92672>.</span>extend([str(r<span style=color:#f92672>.</span>id) <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> results])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> offset <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 2. Вставить новые чанки (upsert)</span>
</span></span><span style=display:flex><span>    qdrant_client<span style=color:#f92672>.</span>upsert(
</span></span><span style=display:flex><span>        collection_name<span style=color:#f92672>=</span>collection,
</span></span><span style=display:flex><span>        points<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>            PointStruct(
</span></span><span style=display:flex><span>                id<span style=color:#f92672>=</span>chunk[<span style=color:#e6db74>&#34;chunk_id&#34;</span>],
</span></span><span style=display:flex><span>                vector<span style=color:#f92672>=</span>chunk[<span style=color:#e6db74>&#34;vector&#34;</span>],
</span></span><span style=display:flex><span>                payload<span style=color:#f92672>=</span>chunk[<span style=color:#e6db74>&#34;payload&#34;</span>],
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> chunk <span style=color:#f92672>in</span> new_chunks
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 3. Удалить старые чанки батчами</span>
</span></span><span style=display:flex><span>    BATCH_SIZE <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(old_chunk_ids), BATCH_SIZE):
</span></span><span style=display:flex><span>        qdrant_client<span style=color:#f92672>.</span>delete(
</span></span><span style=display:flex><span>            collection_name<span style=color:#f92672>=</span>collection,
</span></span><span style=display:flex><span>            points_selector<span style=color:#f92672>=</span>old_chunk_ids[i:i <span style=color:#f92672>+</span> BATCH_SIZE],
</span></span><span style=display:flex><span>        )
</span></span></code></pre></div><h3 id=ttl-стратегия-для-embeddings>TTL-стратегия для embeddings<a href=#ttl-%d1%81%d1%82%d1%80%d0%b0%d1%82%d0%b5%d0%b3%d0%b8%d1%8f-%d0%b4%d0%bb%d1%8f-embeddings class=anchor>#</a></h3><ul><li>Чанки документов, <strong>не связанных ни с одной презентацией</strong> более 90 дней → автоматическое удаление (фоновый job).</li><li>При удалении организации → удаление всей коллекции <code>org_{id}_docs</code> одной операцией.</li><li>При удалении конкретного документа → удаление чанков через payload-фильтр.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Очистка orphan-чанков (не используемых в презентациях)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cleanup_orphan_chunks</span>(organization_id: str) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>    cutoff_date <span style=color:#f92672>=</span> (datetime<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>90</span>))<span style=color:#f92672>.</span>isoformat()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Найти source_document_ids без активных presentation_sources</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># (запрос к PostgreSQL) → orphan_doc_ids</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    deleted <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> doc_id <span style=color:#f92672>in</span> orphan_doc_ids:
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> qdrant_client<span style=color:#f92672>.</span>delete(
</span></span><span style=display:flex><span>            collection_name<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;org_</span><span style=color:#e6db74>{</span>organization_id<span style=color:#e6db74>}</span><span style=color:#e6db74>_docs&#34;</span>,
</span></span><span style=display:flex><span>            points_selector<span style=color:#f92672>=</span>Filter(must<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>                FieldCondition(key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;source_document_id&#34;</span>, <span style=color:#66d9ef>match</span><span style=color:#f92672>=</span>MatchValue(value<span style=color:#f92672>=</span>doc_id)),
</span></span><span style=display:flex><span>                FieldCondition(key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;indexed_at&#34;</span>, range<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;lt&#34;</span>: cutoff_date}),
</span></span><span style=display:flex><span>            ]),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        deleted <span style=color:#f92672>+=</span> result<span style=color:#f92672>.</span>operation_id  <span style=color:#75715e># approx count</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> deleted
</span></span></code></pre></div><script lang=js>const innerPages=document.getElementById("inner-pages");innerPages&&innerPages.querySelectorAll("li").forEach(e=>{e.addEventListener("click",()=>{const t=e.innerText.trim();if(openedMenu){if(openedMenu.includes(t)){const e=openedMenu.findIndex(e=>e===t);openedMenu.splice(e,1)}else openedMenu.push(t);localStorage.setItem("openedMenu",JSON.stringify(openedMenu))}else localStorage.setItem("openedMenu","["+t+"]")})})</script><nav class=pagination><a class="nav nav-prev" href=https://example.org/03_backend/01_info_models/documents/ title="Документные коллекции"><i class="fa fa-arrow-left" aria-hidden=true></i> Предыдущее - Документные коллекции</a>
<a class="nav nav-next" href=https://example.org/03_backend/01_info_models/cache/ title="Кэш и очереди (Redis)">Следующее - Кэш и очереди (Redis) <i class="fa fa-arrow-right" aria-hidden=true></i></a></nav></div><div class="column is-sticky is-paddingless" id=tocWrapper><div class=is-paddingless id=tocContainer><div id=tocContent><div class=additionalinfo><span id=method_name>Векторное хранилище (Qdrant)</span>
<strong>Описание:</strong> Схема, стратегия chunking, HNSW-параметры и similarity-запросы для RAG-пайплайна.</div><div class=toc-header><h6 class="toc-title is-marginless">Содержание:On this page:</h6><i title="Back to top" id=tocBackToTop class="fa-solid fa-circle-arrow-up"></i></div><div id=toc><nav id=TableOfContents><ul><li><a href=#архитектура-коллекций>Архитектура коллекций</a></li><li><a href=#схема-записи-векторачанка>Схема записи (вектора/чанка)</a></li><li><a href=#диаграмма-структуры>Диаграмма структуры</a></li><li><a href=#стратегия-chunking>Стратегия Chunking</a><ul><li><a href=#параметры>Параметры</a></li><li><a href=#алгоритм-рекурсивного-разбиения>Алгоритм рекурсивного разбиения</a></li><li><a href=#специальная-обработка-по-типам>Специальная обработка по типам</a></li><li><a href=#обработка-перекрытий>Обработка перекрытий</a></li></ul></li><li><a href=#параметры-hnsw-индекса>Параметры HNSW-индекса</a><ul><li><a href=#конфигурация-коллекции-qdrant-api>Конфигурация коллекции (Qdrant API)</a></li></ul></li><li><a href=#пример-similarity-запроса-с-фильтрами>Пример similarity-запроса с фильтрами</a><ul><li><a href=#пример-ответа>Пример ответа</a></li></ul></li><li><a href=#стратегия-обновления-чанков-при-изменении-источника>Стратегия обновления чанков при изменении источника</a><ul><li><a href=#сценарий-пользователь-повторно-загружает-обновлённую-версию-документа>Сценарий: пользователь повторно загружает обновлённую версию документа</a></li><li><a href=#алгоритм-атомарного-обновления-чанков>Алгоритм атомарного обновления чанков</a></li><li><a href=#ttl-стратегия-для-embeddings>TTL-стратегия для embeddings</a></li></ul></li></ul></nav></div><ul class=info style="line-height:1.2;list-style-type:none;border:1px solid;border-radius:1px;padding:5px;margin:16px 10px 0;color:#000"></ul><div id=taxonomies><div class=taxonomy-wrapper></div><div class=taxonomy-wrapper></div></div><div class=toc-header><div class=edit-meta></div></div></div></div><div class=is-paddingless id=tocCollapsible title="Collapse/Uncollapse table of contents"><i class="fa-solid fa-angles-right fa-lg"></i></div></div></div></div><script type=text/javascript>const baseUrl="https://example.org/",codeCopyBefore="Copy to clipboard",codeCopyAfter="Copied to clipboard",svgDownloadLabel="Download as SVG",helperLoadingLabel="Loading",searchNoResults="No result found",introNextLabel="Next",introPrevLabel="Previous",introSkipLabel="✗",introDoneLabel="Done",printLabel="Print current page",qrCodeLabel="Show current page QR code",naCommonLabel="Not available"</script><script type=module src=/js/theme/modules/const.min.js></script><script type=module src=/js/theme/modules/helpers.min.js></script><script type=module src=/js/theme/modules/helpersGlobal.min.js></script><script type=module src=/js/theme/init.min.js></script><script type=module src=/js/theme/navbar.min.js></script><script type=module src=/js/theme/print.min.js></script><script type=module src=/js/theme/qrcode.min.js></script><script type=module src=/js/theme/search.min.js></script><script type=module src=/js/theme/shortcuts.min.js></script><script type=module src=/js/theme/sidebar.min.js></script><script type=module src=/js/theme/toc.min.js></script><script type=module src=/js/external/mermaid/mermaid.min.js></script><script type=module src=/js/fencedcodes/mermaid.min.js></script><script type=text/javascript src=/js/external/jquery/jquery-3.6.3.min.js></script><script type=text/javascript src=/js/external/tippy/popper.min.js></script><script type=text/javascript src=/js/external/tippy/tippy-bundle.umd.min.js></script><script type=text/javascript src=/js/external/markmap/markmap-autoloader.min.js></script><script type=text/javascript src=/js/theme/browserCompatibility.min.js></script><script type=text/javascript src=/js/external/flexsearch/flexsearch.bundle.min.js></script><script type=text/javascript src=/js/external/qrious/qrious.min.js></script><script type=text/javascript src=/js/external/overlay-scrollbars/overlayscrollbars.min.js></script><script type=text/javascript src=/js/external/markmap/markmap.min.js></script><script type=text/javascript src=/js/external/readfile/rawdeflate.min.js></script><script type=text/javascript src=/js/external/1ce05b4b.min.js></script><script type=text/javascript src=/js/external/techradar/d3.v4.min.js></script><script type=text/javascript src=/js/external/techradar/radar.min.js></script><script type=text/javascript src=/js/external/bpmn-visualization/bpmn-visualization.min.js></script><script type=text/javascript src=/js/external/sorttable/sorttable.min.js></script><script type=text/javascript src=/js/external/mermaid/svg-pan-zoom.min.js></script><script type=text/javascript src=/js/external/simplesearch/simplesearch.min.js></script><script>$("table").addClass("sortable")</script></body></html>