<!doctype html><html><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.124.1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Детальное описание схемы PostgreSQL 16: таблицы, индексы, ограничения, триггеры."><title>Реляционные таблицы (PostgreSQL)</title>
<link rel=icon href="/images/favicon.png?v=1772348677" type=image/x-icon><link rel=stylesheet rel=preload type=text/css href=/css/main.css><link rel=stylesheet type=text/css href=/css/external/all.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-thin.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-solid.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-regular.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-light.min.css><link rel=stylesheet type=text/css href=/css/external/sorttable/sorttable.min.css><link rel=stylesheet type=text/css href=/css/external/tippy/light-border.min.css><link rel=stylesheet type=text/css href=/css/external/techradar/radar.min.css><link rel=stylesheet type=text/css href=/css/external/form-js/form-js.min.css><link rel=stylesheet type=text/css href=/css/external/overlay-scrollbars/overlayscrollbars.min.css><link rel=stylesheet type=text/css href=/css/external/simplesearch/simplesearch.min.css></head><body onload=browserCompatibility()><div id=navbarInfo class="is-hidden modal-container"><div class="modal-content-box modal-text-box"><div class="card modal-title is-radiusless"><div class=card-header><p class="card-header-title is-marginless">About</p></div></div><div class=modal-content-container><div class="modal-content-block is-block"></div></div></div></div><div id=navbarShortcuts class="is-hidden modal-container"><div class="modal-content-box modal-text-box"><div class="card modal-title is-radiusless"><div class=card-header><p class="card-header-title is-marginless">Keyboard shortcuts</p></div></div><div class=modal-content-container><div class=modal-content-block><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>q</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show current page QR code</p></div><div class=modal-content><kbd>Escape</kbd></div><div class=modal-content><p class=has-text-weight-normal>Close modals</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>i</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show website information</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>k</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show shortcuts</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>h</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to homepage</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>f</kbd></div><div class=modal-content><p class=has-text-weight-normal>Find on website</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>m</kbd></div><div class=modal-content><p class=has-text-weight-normal>Collapse/Uncollapse sidebar</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>t</kbd></div><div class=modal-content><p class=has-text-weight-normal>Collapse/Uncollapse table of contents</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>↑</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to the top of the page</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>↓</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to the bottom of the page</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>p</kbd></div><div class=modal-content><p class=has-text-weight-normal>Print current page</p></div></div></div></div></div><div id=modalContainer class="is-hidden modal-container"><div id=modal class=modal-content-box></div></div><nav id=navbar class=navbar role=navigation aria-label="main navigation"><div id=navbarItemsContainer class=navbar-brand><div id=globalLogoContainer class=is-flex><a id=globalLogo class="navbar-item navbar-item-standard is-paddingless" href=/><img id=globalLogoImg alt=Homepage src="/images/logo.png?v=1772348677"><div class=logo-header-container><span>Сервис генерации презентаций</span></div></a><a id=globalTouchLogo class="navbar-item navbar-item-standard is-paddingless" href=/><img alt=Homepage src="/images/logoTouch.png?v=1772348677"></a></div><div id=navbarItems class=is-flex><div id=navbarItemsStart class=is-flex></div><div id=navbarItemsEnd class=is-flex><div class=navbar-item><a id=listDocuments class="button navbar-item-standard" href=/listdocuments/><span class=icon><i class="fa-solid fa-list"></i>
</span><span class=icon-text>&nbsp;Список документов</span></a></div><div class=navbar-item><a id=searchButton class="button navbar-item-standard" href=/search/><span class=icon><i class="fa-solid fa-magnifying-glass"></i>
</span><span class=icon-text>&nbsp;Поиск</span></a></div><div class=navbar-item><a id=printButton class="button navbar-item-standard"><span class=icon-text>Print</span>
<span class=icon><i class="fa-solid fa-print fa-lg"></i></span></a></div></div></div></div></nav><div id=navbarOverlay></div><div class="columns is-mobile is-paddingless is-marginless" id=mainContainer><div id=sidebarContainer class="column is-narrow is-paddingless is-marginless"><div id=sidebarWrapper class=is-fixed><div id=sidebar class=is-marginless><aside class="menu is-paddingless is-marginless"><ul class="menu-list is-marginless is-paddingless"><div class="card is-fs-expandable-icon"><div class=card-header><a href=/00_overview/ class=card-header-title><i class='fa-solid fa-circle-info fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/00_overview/ class=card-header-title title='Описание и артефакты анализа'><i class='fa-solid fa-circle-info fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Описание и артефакты анализа</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/00_overview/01_br/ class=card-header-title title=Требования><i class='fa-solid fa-folder-open'></i><p class="pt-0 pb-0 pr-2 pl-1">Требования</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/01_br/ class=card-header-title title='Бизнес-контекст и БТ'><i class='fa-solid fa-circle-info'></i><p class="pt-0 pb-0 pr-2 pl-1">Бизнес-контекст и БТ</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/02_actors/ class=card-header-title title='Акторы и границы системы'><i class='fa-solid fa-users'></i><p class="pt-0 pb-0 pr-2 pl-1">Акторы и границы системы</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/03_fr_documents/ class=card-header-title title='FR_01: Загрузка и индексация документов'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_01: Загрузка и индексация документов</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/04_fr_rag/ class=card-header-title title='FR_02: RAG-поиск и генерация презентаций'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_02: RAG-поиск и генерация презентаций</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/05_fr_users/ class=card-header-title title='FR_03: Управление пользователями'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_03: Управление пользователями</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/06_fr_admin/ class=card-header-title title='FR_04: Администрирование'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_04: Администрирование</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/07_nonfunctional/ class=card-header-title title='Нефункциональные требования'><i class='fa-solid fa-gauge-high'></i><p class="pt-0 pb-0 pr-2 pl-1">Нефункциональные требования</p></a></div></div></li></div></div></ul></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/02_constraints/ class=card-header-title title='Ограничения и допущения'><i class='fa-solid fa-lock'></i><p class="pt-0 pb-0 pr-2 pl-1">Ограничения и допущения</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/03_interfaces/ class=card-header-title title=Интерфейсы><i class='fa-solid fa-plug'></i><p class="pt-0 pb-0 pr-2 pl-1">Интерфейсы</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/04_quality_metrics/ class=card-header-title title='Метрики качества и итоговая сводка'><i class='fa-solid fa-chart-bar'></i><p class="pt-0 pb-0 pr-2 pl-1">Метрики качества и итоговая сводка</p></a></div></div></li></div></div></ul></li></div></div><div class="card is-fs-expandable-icon"><div class="card-header is-single-link"><a href=/01_architecture/ class=card-header-title><i class='fa-solid fa-diagram-project fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/01_architecture/ class=card-header-title title=Архитектура><i class='fa-solid fa-diagram-project fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Архитектура</p></a></div></div></li></div></div><div class="card is-fs-expandable-icon is-sidebar-active"><div class=card-header><a href=/03_backend/ class=card-header-title><i class='fa-solid fa-server fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class="is-marginless is-tree-active is-entries-expandable is-entries-expanded"><div class=card><div class=card-header><a href=/03_backend/ class=card-header-title title=Backend><i class='fa-solid fa-server fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Backend</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-expanded"><span class=icon></span></a></div></div><ul class="is-marginless is-tree-active"><div><div><li class="is-marginless is-entries-expandable is-entries-expanded"><div class=card><div class=card-header><a href=/03_backend/01_info_models/ class=card-header-title title='Модель данных и базы данных'><i class='fa-solid fa-database'></i><p class="pt-0 pb-0 pr-2 pl-1">Модель данных и базы данных</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-expanded"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class="card is-sidebar-active" id=sidebarActiveEntry><div class="card-header is-single-link"><a href=/03_backend/01_info_models/relational/ class=card-header-title title='Реляционные таблицы (PostgreSQL)'><i class='fa-solid fa-table'></i><p class="pt-0 pb-0 pr-2 pl-1">Реляционные таблицы (PostgreSQL)</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/documents/ class=card-header-title title='Документные коллекции'><i class='fa-solid fa-file-code'></i><p class="pt-0 pb-0 pr-2 pl-1">Документные коллекции</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/vector_store/ class=card-header-title title='Векторное хранилище (Qdrant)'><i class='fa-solid fa-magnifying-glass-chart'></i><p class="pt-0 pb-0 pr-2 pl-1">Векторное хранилище (Qdrant)</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/cache/ class=card-header-title title='Кэш и очереди (Redis)'><i class='fa-solid fa-bolt'></i><p class="pt-0 pb-0 pr-2 pl-1">Кэш и очереди (Redis)</p></a></div></div></li></div></div></ul></li></div></div><div><div><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/03_backend/02_rest_methods/ class=card-header-title title='REST API'><i class='fa-solid fa-route'></i><p class="pt-0 pb-0 pr-2 pl-1">REST API</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/createproject/ class=card-header-title title='POST /projects'><i class='fa-solid fa-folder-plus'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /projects</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/createpresentation/ class=card-header-title title='POST /presentations'><i class='fa-solid fa-file-powerpoint'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /presentations</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/generateoutline/ class=card-header-title title='POST /presentations/{id}/generate/outline'><i class='fa-solid fa-list-ol'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /presentations/{id}/generate/outline</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/generateslides/ class=card-header-title title='POST /presentations/{id}/generate/slides'><i class='fa-solid fa-wand-magic-sparkles'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /presentations/{id}/generate/slides</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/regenerateslide/ class=card-header-title title='POST /presentations/{id}/generate/slide/{slide_id}'><i class='fa-solid fa-rotate-right'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /presentations/{id}/generate/slide/{slide_id}</p></a></div></div></li></div></div></ul></li></div></div></ul></li></div></div><div class="card is-fs-expandable-icon"><div class=card-header><a href=/02_frontend/ class=card-header-title><i class='fa-solid fa-display fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/02_frontend/ class=card-header-title title=Frontend><i class='fa-solid fa-display fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Frontend</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/02_frontend/screens/ class=card-header-title title=Экраны><i class='fa-solid fa-window-restore'></i><p class="pt-0 pb-0 pr-2 pl-1">Экраны</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/screens/landing/ class=card-header-title title=Лендинг><i class='fa-solid fa-house'></i><p class="pt-0 pb-0 pr-2 pl-1">Лендинг</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/screens/wizard_step1/ class=card-header-title title='Wizard — Шаг 1: Данные и контент'><i class='fa-solid fa-upload'></i><p class="pt-0 pb-0 pr-2 pl-1">Wizard — Шаг 1: Данные и контент</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/screens/wizard_step2/ class=card-header-title title='Wizard — Шаг 2: Аудитория и цель'><i class='fa-solid fa-bullseye'></i><p class="pt-0 pb-0 pr-2 pl-1">Wizard — Шаг 2: Аудитория и цель</p></a></div></div></li></div></div></ul></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/components/ class=card-header-title title='Реестр компонентов'><i class='fa-solid fa-cubes'></i><p class="pt-0 pb-0 pr-2 pl-1">Реестр компонентов</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/user_flows/ class=card-header-title title='Пользовательские сценарии'><i class='fa-solid fa-route'></i><p class="pt-0 pb-0 pr-2 pl-1">Пользовательские сценарии</p></a></div></div></li></div></div></ul></li></div></div></ul></aside></div><div id=sidebarCollapsible class=is-marginless><div class="card is-uncollapse-action"><div id=sidebarUncollapse class="card-header is-single-link" title="Collapse/Uncollapse sidebar"><a class=card-header-title><i class="fa-solid fa-angles-right fa-lg"></i></a></div></div><div class="card is-collapse-action"><div id=sidebarCollapse class="card-header is-single-link" title="Collapse/Uncollapse sidebar"><a class=card-header-title><i class="fa-solid fa-angles-left fa-lg"></i><p>Collapse sidebar</p></a></div></div></div></div></div><div id=sidebarMobileWrapper class="column is-narrow is-hidden-desktop"></div><div class="columns is-mobile is-marginless is-scroll-smooth has-toc is-toc-collapsed" id=contentContainer><div class=column id=content data-pagefind-body><style>ul.breadcrumb{padding:10px 15px;list-style:none;background-color:#eee}ul.breadcrumb li{display:inline;font-size:14px}ul.breadcrumb li+li:before{padding:8px;color:#000;content:"/\00a0"}ul.breadcrumb li a{color:#0275d8;text-decoration:none}ul.breadcrumb li a:hover{color:#01447e;text-decoration:underline}</style><ul id=breadcrumbs class=breadcrumb><li><a href=/>Промпт-инжиниринг</a></li><li><a href=/03_backend/>Backend</a></li><li><a href=/03_backend/01_info_models/>Модель данных и базы данных</a></li><li><a href=/03_backend/01_info_models/relational/>Реляционные таблицы (PostgreSQL)</a></li></ul><div id=contentTitle>Реляционные таблицы (PostgreSQL)</div><h1 id=реляционные-таблицы-postgresql-16>Реляционные таблицы PostgreSQL 16<a href=#%d1%80%d0%b5%d0%bb%d1%8f%d1%86%d0%b8%d0%be%d0%bd%d0%bd%d1%8b%d0%b5-%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d1%8b-postgresql-16 class=anchor>#</a></h1><blockquote><p><strong>Схема:</strong> <code>public</code> (Free/Pro) / <code>tenant_{id}</code> (Enterprise)
<strong>Расширения:</strong> <code>uuid-ossp</code>, <code>pgcrypto</code>, <code>pg_trgm</code>, <code>btree_gin</code></p></blockquote><hr><h2 id=enum-типы-глобальные>Enum-типы (глобальные)<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-%d0%b3%d0%bb%d0%be%d0%b1%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%b5 class=anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> org_role <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;editor&#39;</span>, <span style=color:#e6db74>&#39;viewer&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> oauth_provider <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;google&#39;</span>, <span style=color:#e6db74>&#39;microsoft&#39;</span>, <span style=color:#e6db74>&#39;notion&#39;</span>, <span style=color:#e6db74>&#39;confluence&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> subscription_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;active&#39;</span>, <span style=color:#e6db74>&#39;trialing&#39;</span>, <span style=color:#e6db74>&#39;past_due&#39;</span>, <span style=color:#e6db74>&#39;canceled&#39;</span>, <span style=color:#e6db74>&#39;expired&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> presentation_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;draft&#39;</span>, <span style=color:#e6db74>&#39;outline_ready&#39;</span>, <span style=color:#e6db74>&#39;generating&#39;</span>, <span style=color:#e6db74>&#39;ready&#39;</span>, <span style=color:#e6db74>&#39;error&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> tone_type <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;formal&#39;</span>, <span style=color:#e6db74>&#39;business&#39;</span>, <span style=color:#e6db74>&#39;persuasive&#39;</span>, <span style=color:#e6db74>&#39;technical&#39;</span>, <span style=color:#e6db74>&#39;educational&#39;</span>, <span style=color:#e6db74>&#39;friendly&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> slide_type <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;title_slide&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>, <span style=color:#e6db74>&#39;chart&#39;</span>, <span style=color:#e6db74>&#39;table&#39;</span>, <span style=color:#e6db74>&#39;image&#39;</span>, <span style=color:#e6db74>&#39;quote&#39;</span>, <span style=color:#e6db74>&#39;divider&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> slide_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pending&#39;</span>, <span style=color:#e6db74>&#39;generating&#39;</span>, <span style=color:#e6db74>&#39;ready&#39;</span>, <span style=color:#e6db74>&#39;error&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> source_file_type <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pdf&#39;</span>, <span style=color:#e6db74>&#39;docx&#39;</span>, <span style=color:#e6db74>&#39;xlsx&#39;</span>, <span style=color:#e6db74>&#39;csv&#39;</span>, <span style=color:#e6db74>&#39;pptx&#39;</span>, <span style=color:#e6db74>&#39;url&#39;</span>, <span style=color:#e6db74>&#39;image&#39;</span>, <span style=color:#e6db74>&#39;txt&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> ingestion_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pending&#39;</span>, <span style=color:#e6db74>&#39;processing&#39;</span>, <span style=color:#e6db74>&#39;indexed&#39;</span>, <span style=color:#e6db74>&#39;failed&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> job_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pending&#39;</span>, <span style=color:#e6db74>&#39;running&#39;</span>, <span style=color:#e6db74>&#39;completed&#39;</span>, <span style=color:#e6db74>&#39;failed&#39;</span>, <span style=color:#e6db74>&#39;retrying&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> llm_provider <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;claude&#39;</span>, <span style=color:#e6db74>&#39;gpt4o&#39;</span>, <span style=color:#e6db74>&#39;llama3&#39;</span>, <span style=color:#e6db74>&#39;gemini&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> export_format <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pptx&#39;</span>, <span style=color:#e6db74>&#39;pdf&#39;</span>, <span style=color:#e6db74>&#39;google_slides&#39;</span>, <span style=color:#e6db74>&#39;png&#39;</span>, <span style=color:#e6db74>&#39;web&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> share_access <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;view&#39;</span>, <span style=color:#e6db74>&#39;comment&#39;</span>, <span style=color:#e6db74>&#39;edit&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> webhook_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pending&#39;</span>, <span style=color:#e6db74>&#39;delivered&#39;</span>, <span style=color:#e6db74>&#39;failed&#39;</span>, <span style=color:#e6db74>&#39;abandoned&#39;</span>);
</span></span></code></pre></div><hr><h2 id=таблица-users>Таблица: <code>users</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-users class=anchor>#</a></h2><p><strong>Домен:</strong> Auth
<strong>Назначение:</strong> Учётные записи пользователей системы.</p><h3 id=поля>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>email</td><td>VARCHAR(255)</td><td>✓</td><td>—</td><td>UNIQUE</td><td>Email — основной идентификатор</td></tr><tr><td>name</td><td>VARCHAR(255)</td><td>✓</td><td>—</td><td>—</td><td>Отображаемое имя</td></tr><tr><td>avatar_url</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>URL аватара (S3 или внешний)</td></tr><tr><td>is_email_verified</td><td>BOOLEAN</td><td>✓</td><td>FALSE</td><td>—</td><td>Подтверждён ли email</td></tr><tr><td>last_login_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Время последнего входа</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата регистрации</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата последнего обновления</td></tr><tr><td>deleted_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Soft delete: дата удаления</td></tr></tbody></table><h3 id=индексы>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>users_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>users_email_key</td><td>email</td><td>BTREE UNIQUE</td><td>—</td><td>Логин по email, быстрый поиск</td></tr><tr><td>users_active_idx</td><td>deleted_at</td><td>BTREE</td><td>WHERE deleted_at IS NULL</td><td>Фильтр активных пользователей</td></tr></tbody></table><h3 id=ограничения>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f class=anchor>#</a></h3><ul><li>CHECK: <code>email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'</code> — базовая валидация формата email</li></ul><h3 id=триггеры>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b class=anchor>#</a></h3><ul><li><code>trg_users_updated_at</code> — обновляет <code>updated_at = now()</code> перед каждым UPDATE</li></ul><h3 id=типичные-запросы>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Поиск пользователя по email при логине
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, name, is_email_verified
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> users
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> email <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> deleted_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Soft delete пользователя (GDPR right-to-erasure)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>UPDATE</span> users
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> deleted_at <span style=color:#f92672>=</span> now(), email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;deleted_&#39;</span> <span style=color:#f92672>||</span> id <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;@deleted.invalid&#39;</span>, name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Deleted User&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> deleted_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span></code></pre></div><h3 id=связи>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8 class=anchor>#</a></h3><ul><li><code>organization_members</code> (один ко многим) через <code>user_id</code></li><li><code>oauth_connections</code> (один ко многим) через <code>user_id</code></li><li><code>api_keys</code> (один ко многим) через <code>created_by</code></li><li><code>presentations</code> (один ко многим) через <code>created_by</code></li></ul><hr><h2 id=таблица-organizations>Таблица: <code>organizations</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-organizations class=anchor>#</a></h2><p><strong>Домен:</strong> Auth
<strong>Назначение:</strong> Тенанты — компании или команды, единица изоляции данных.</p><h3 id=поля-1>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-1 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>name</td><td>VARCHAR(255)</td><td>✓</td><td>—</td><td>—</td><td>Название организации</td></tr><tr><td>slug</td><td>VARCHAR(100)</td><td>✓</td><td>—</td><td>UNIQUE</td><td>URL-friendly идентификатор</td></tr><tr><td>logo_url</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>URL логотипа организации</td></tr><tr><td>website</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Сайт компании</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr><tr><td>deleted_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Soft delete</td></tr></tbody></table><h3 id=индексы-1>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-1 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>organizations_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>organizations_slug_key</td><td>slug</td><td>BTREE UNIQUE</td><td>—</td><td>Поиск по slug в URL</td></tr><tr><td>organizations_active_idx</td><td>deleted_at</td><td>BTREE</td><td>WHERE deleted_at IS NULL</td><td>Фильтр активных</td></tr></tbody></table><h3 id=ограничения-1>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-1 class=anchor>#</a></h3><ul><li>CHECK: <code>slug ~ '^[a-z0-9-]{3,100}$'</code> — только строчные буквы, цифры, дефис</li></ul><h3 id=триггеры-1>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b-1 class=anchor>#</a></h3><ul><li><code>trg_organizations_updated_at</code> — обновляет <code>updated_at</code> при UPDATE</li></ul><h3 id=типичные-запросы-1>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-1 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Получить организацию по slug
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, name, logo_url
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> organizations
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> slug <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> deleted_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span></code></pre></div><h3 id=связи-1>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-1 class=anchor>#</a></h3><ul><li><code>organization_members</code> (один ко многим) через <code>organization_id</code></li><li><code>subscriptions</code> (один к одному) через <code>organization_id</code></li><li><code>projects</code> (один ко многим) через <code>organization_id</code></li><li><code>brand_kits</code> (один ко многим) через <code>organization_id</code></li></ul><hr><h2 id=таблица-organization_members>Таблица: <code>organization_members</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-organization_members class=anchor>#</a></h2><p><strong>Домен:</strong> Auth
<strong>Назначение:</strong> Связь пользователей с организацией и их ролевые права.</p><h3 id=поля-2>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-2 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Организация</td></tr><tr><td>user_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Пользователь</td></tr><tr><td>role</td><td>org_role</td><td>✓</td><td>&lsquo;viewer&rsquo;</td><td>—</td><td>Роль: admin / editor / viewer</td></tr><tr><td>invited_by</td><td>UUID</td><td>✗</td><td>NULL</td><td>FK</td><td>Кто пригласил</td></tr><tr><td>joined_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Дата принятия приглашения</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания записи</td></tr></tbody></table><h3 id=индексы-2>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-2 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>org_members_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>org_members_org_user_key</td><td>(organization_id, user_id)</td><td>BTREE UNIQUE</td><td>—</td><td>Пользователь уникален в орг.</td></tr><tr><td>org_members_user_idx</td><td>user_id</td><td>BTREE</td><td>—</td><td>Организации пользователя</td></tr></tbody></table><h3 id=ограничения-2>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-2 class=anchor>#</a></h3><ul><li>FK: <code>organization_id</code> → <code>organizations.id</code> ON DELETE CASCADE</li><li>FK: <code>user_id</code> → <code>users.id</code> ON DELETE CASCADE</li><li>FK: <code>invited_by</code> → <code>users.id</code> ON DELETE SET NULL</li></ul><h3 id=enum-типы>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> org_role <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;editor&#39;</span>, <span style=color:#e6db74>&#39;viewer&#39;</span>);
</span></span></code></pre></div><h3 id=типичные-запросы-2>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-2 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Проверить роль пользователя в организации
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>role</span> <span style=color:#66d9ef>FROM</span> organization_members
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> user_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Список участников организации с данными пользователя
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> u.id, u.name, u.email, om.<span style=color:#66d9ef>role</span>, om.joined_at
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> organization_members om
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> users u <span style=color:#66d9ef>ON</span> u.id <span style=color:#f92672>=</span> om.user_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> om.organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> om.<span style=color:#66d9ef>role</span>, u.name;
</span></span></code></pre></div><h3 id=связи-2>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-2 class=anchor>#</a></h3><ul><li><code>organizations</code> (многие к одному) через <code>organization_id</code></li><li><code>users</code> (многие к одному) через <code>user_id</code></li></ul><hr><h2 id=таблица-oauth_connections>Таблица: <code>oauth_connections</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-oauth_connections class=anchor>#</a></h2><p><strong>Домен:</strong> Auth
<strong>Назначение:</strong> OAuth 2.0 токены для интеграций с внешними сервисами (Google Drive, OneDrive, Notion, Confluence).</p><h3 id=поля-3>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-3 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>user_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Владелец токена</td></tr><tr><td>provider</td><td>oauth_provider</td><td>✓</td><td>—</td><td>—</td><td>Провайдер OAuth</td></tr><tr><td>provider_user_id</td><td>VARCHAR(255)</td><td>✓</td><td>—</td><td>—</td><td>ID пользователя у провайдера</td></tr><tr><td>access_token_encrypted</td><td>BYTEA</td><td>✓</td><td>—</td><td>—</td><td>Зашифрованный access token (AES-256-GCM)</td></tr><tr><td>refresh_token_encrypted</td><td>BYTEA</td><td>✗</td><td>NULL</td><td>—</td><td>Зашифрованный refresh token</td></tr><tr><td>token_expires_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Срок истечения access token</td></tr><tr><td>scopes</td><td>TEXT[]</td><td>✓</td><td>&lsquo;{}&rsquo;</td><td>—</td><td>Разрешённые scopes</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления токена</td></tr></tbody></table><h3 id=индексы-3>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-3 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>oauth_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>oauth_user_provider_key</td><td>(user_id, provider)</td><td>BTREE UNIQUE</td><td>—</td><td>Один токен на провайдера</td></tr><tr><td>oauth_expires_idx</td><td>token_expires_at</td><td>BTREE</td><td>WHERE token_expires_at &lt; now()</td><td>Поиск истёкших для refresh</td></tr></tbody></table><h3 id=ограничения-3>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-3 class=anchor>#</a></h3><ul><li>FK: <code>user_id</code> → <code>users.id</code> ON DELETE CASCADE</li></ul><h3 id=триггеры-2>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b-2 class=anchor>#</a></h3><ul><li><code>trg_oauth_updated_at</code> — обновляет <code>updated_at</code> при UPDATE (рефреш токена)</li></ul><h3 id=типичные-запросы-3>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-3 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Получить токен для провайдера (перед вызовом внешнего API)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> access_token_encrypted, token_expires_at, refresh_token_encrypted
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> oauth_connections
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> user_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> provider <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;
</span></span></code></pre></div><h3 id=связи-3>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-3 class=anchor>#</a></h3><ul><li><code>users</code> (многие к одному) через <code>user_id</code></li></ul><hr><h2 id=таблица-api_keys>Таблица: <code>api_keys</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-api_keys class=anchor>#</a></h2><p><strong>Домен:</strong> Auth
<strong>Назначение:</strong> API-ключи организаций для публичного REST API.</p><h3 id=поля-4>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-4 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Организация-владелец</td></tr><tr><td>name</td><td>VARCHAR(100)</td><td>✓</td><td>—</td><td>—</td><td>Название ключа (для отображения)</td></tr><tr><td>key_hash</td><td>CHAR(64)</td><td>✓</td><td>—</td><td>UNIQUE</td><td>SHA-256 хеш ключа</td></tr><tr><td>key_prefix</td><td>CHAR(8)</td><td>✓</td><td>—</td><td>—</td><td>Первые 8 символов для идентификации</td></tr><tr><td>scopes</td><td>TEXT[]</td><td>✓</td><td>&lsquo;{}&rsquo;</td><td>—</td><td>Разрешения: read, write, admin</td></tr><tr><td>rate_limit_per_minute</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK > 0</td><td>Лимит запросов (NULL = план default)</td></tr><tr><td>created_by</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Кто создал</td></tr><tr><td>expires_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Срок действия (NULL = бессрочный)</td></tr><tr><td>last_used_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Последнее использование</td></tr><tr><td>revoked_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Дата отзыва</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr></tbody></table><h3 id=индексы-4>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-4 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>api_keys_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>api_keys_hash_key</td><td>key_hash</td><td>BTREE UNIQUE</td><td>—</td><td>Валидация ключа при запросе</td></tr><tr><td>api_keys_org_idx</td><td>organization_id</td><td>BTREE</td><td>WHERE revoked_at IS NULL</td><td>Активные ключи организации</td></tr></tbody></table><h3 id=ограничения-4>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-4 class=anchor>#</a></h3><ul><li>FK: <code>organization_id</code> → <code>organizations.id</code> ON DELETE CASCADE</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE RESTRICT</li><li>CHECK: <code>rate_limit_per_minute > 0 OR rate_limit_per_minute IS NULL</code> — лимит положительный</li></ul><h3 id=типичные-запросы-4>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-4 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Валидация API ключа (вычислить SHA-256 на уровне приложения)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> ak.id, ak.organization_id, ak.scopes, ak.rate_limit_per_minute
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> api_keys ak
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> ak.key_hash <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> ak.revoked_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> (ak.expires_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>OR</span> ak.expires_at <span style=color:#f92672>&gt;</span> now());
</span></span></code></pre></div><h3 id=связи-4>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-4 class=anchor>#</a></h3><ul><li><code>organizations</code> (многие к одному) через <code>organization_id</code></li><li><code>users</code> (многие к одному) через <code>created_by</code></li></ul><hr><h2 id=таблица-plans>Таблица: <code>plans</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-plans class=anchor>#</a></h2><p><strong>Домен:</strong> Billing
<strong>Назначение:</strong> Тарифные планы с лимитами использования.</p><h3 id=поля-5>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-5 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>name</td><td>VARCHAR(50)</td><td>✓</td><td>—</td><td>UNIQUE</td><td>Название: free, pro, team, enterprise</td></tr><tr><td>max_users</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK > 0</td><td>Лимит пользователей (NULL = ∞)</td></tr><tr><td>max_presentations_per_month</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK > 0</td><td>Лимит презентаций в месяц</td></tr><tr><td>max_file_size_mb</td><td>INT</td><td>✓</td><td>—</td><td>CHECK > 0</td><td>Макс. размер загружаемого файла</td></tr><tr><td>max_source_files_per_pres</td><td>INT</td><td>✓</td><td>5</td><td>CHECK > 0</td><td>Макс. источников на презентацию</td></tr><tr><td>ai_tokens_per_month</td><td>BIGINT</td><td>✗</td><td>NULL</td><td>CHECK > 0</td><td>Лимит AI-токенов в месяц</td></tr><tr><td>storage_gb</td><td>INT</td><td>✓</td><td>—</td><td>CHECK > 0</td><td>Дисковое пространство GB</td></tr><tr><td>features</td><td>JSONB</td><td>✓</td><td>&lsquo;{}&rsquo;</td><td>—</td><td>Feature-флаги плана</td></tr><tr><td>price_monthly_usd</td><td>NUMERIC(10,2)</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Цена в месяц</td></tr><tr><td>price_yearly_usd</td><td>NUMERIC(10,2)</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Цена в год</td></tr><tr><td>is_active</td><td>BOOLEAN</td><td>✓</td><td>TRUE</td><td>—</td><td>Доступен ли для оформления</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr></tbody></table><h3 id=индексы-5>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-5 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>plans_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>plans_name_key</td><td>name</td><td>BTREE UNIQUE</td><td>—</td><td>Уникальность имени</td></tr><tr><td>plans_active_idx</td><td>is_active</td><td>BTREE</td><td>WHERE is_active = TRUE</td><td>Список доступных планов</td></tr></tbody></table><h3 id=типичные-запросы-5>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-5 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Получить все активные тарифы для pricing page
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, name, max_users, ai_tokens_per_month, price_monthly_usd, features
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> plans
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> is_active <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> price_monthly_usd NULLS <span style=color:#66d9ef>FIRST</span>;
</span></span></code></pre></div><h3 id=связи-5>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-5 class=anchor>#</a></h3><ul><li><code>subscriptions</code> (один ко многим) через <code>plan_id</code></li></ul><hr><h2 id=таблица-subscriptions>Таблица: <code>subscriptions</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-subscriptions class=anchor>#</a></h2><p><strong>Домен:</strong> Billing
<strong>Назначение:</strong> Подписка организации на тарифный план.</p><h3 id=поля-6>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-6 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK UNIQUE</td><td>Организация (1:1)</td></tr><tr><td>plan_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Текущий план</td></tr><tr><td>status</td><td>subscription_status</td><td>✓</td><td>&rsquo;trialing'</td><td>—</td><td>Статус подписки</td></tr><tr><td>current_period_start</td><td>TIMESTAMPTZ</td><td>✓</td><td>—</td><td>—</td><td>Начало расчётного периода</td></tr><tr><td>current_period_end</td><td>TIMESTAMPTZ</td><td>✓</td><td>—</td><td>—</td><td>Конец расчётного периода</td></tr><tr><td>external_subscription_id</td><td>VARCHAR(255)</td><td>✗</td><td>NULL</td><td>—</td><td>Stripe subscription ID</td></tr><tr><td>cancel_at_period_end</td><td>BOOLEAN</td><td>✓</td><td>FALSE</td><td>—</td><td>Отменить в конце периода</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr></tbody></table><h3 id=индексы-6>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-6 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>subscriptions_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>subscriptions_org_key</td><td>organization_id</td><td>BTREE UNIQUE</td><td>—</td><td>Одна подписка на орг.</td></tr><tr><td>subscriptions_period_idx</td><td>current_period_end</td><td>BTREE</td><td>WHERE status = &lsquo;active&rsquo;</td><td>Поиск истекающих подписок</td></tr></tbody></table><h3 id=ограничения-5>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-5 class=anchor>#</a></h3><ul><li>FK: <code>organization_id</code> → <code>organizations.id</code> ON DELETE CASCADE</li><li>FK: <code>plan_id</code> → <code>plans.id</code> ON DELETE RESTRICT</li><li>CHECK: <code>current_period_end > current_period_start</code> — корректный период</li></ul><h3 id=enum-типы-1>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-1 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> subscription_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;active&#39;</span>, <span style=color:#e6db74>&#39;trialing&#39;</span>, <span style=color:#e6db74>&#39;past_due&#39;</span>, <span style=color:#e6db74>&#39;canceled&#39;</span>, <span style=color:#e6db74>&#39;expired&#39;</span>);
</span></span></code></pre></div><h3 id=триггеры-3>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b-3 class=anchor>#</a></h3><ul><li><code>trg_subscriptions_updated_at</code> — обновляет <code>updated_at</code> при UPDATE</li></ul><h3 id=типичные-запросы-6>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-6 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Получить план организации (JOIN для лимитов)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> p.max_presentations_per_month, p.ai_tokens_per_month, p.features, s.status
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> subscriptions s
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> plans p <span style=color:#66d9ef>ON</span> p.id <span style=color:#f92672>=</span> s.plan_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> s.organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><h3 id=связи-6>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-6 class=anchor>#</a></h3><ul><li><code>organizations</code> (многие к одному) через <code>organization_id</code></li><li><code>plans</code> (многие к одному) через <code>plan_id</code></li></ul><hr><h2 id=таблица-usage_records>Таблица: <code>usage_records</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-usage_records class=anchor>#</a></h2><p><strong>Домен:</strong> Billing
<strong>Назначение:</strong> Учёт потребления ресурсов по периодам для биллинга и fair-use мониторинга.</p><h3 id=поля-7>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-7 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Организация</td></tr><tr><td>period_start</td><td>DATE</td><td>✓</td><td>—</td><td>—</td><td>Начало периода (1-е число месяца)</td></tr><tr><td>period_end</td><td>DATE</td><td>✓</td><td>—</td><td>—</td><td>Конец периода</td></tr><tr><td>presentations_generated</td><td>INT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Сгенерировано презентаций</td></tr><tr><td>slides_generated</td><td>INT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Сгенерировано слайдов</td></tr><tr><td>tokens_used</td><td>BIGINT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Использовано LLM-токенов</td></tr><tr><td>storage_bytes_used</td><td>BIGINT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Использовано байт хранилища</td></tr><tr><td>cost_usd</td><td>NUMERIC(12,4)</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Стоимость LLM-вызовов в USD</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr></tbody></table><h3 id=индексы-7>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-7 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>usage_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>usage_org_period_key</td><td>(organization_id, period_start)</td><td>BTREE UNIQUE</td><td>—</td><td>Один период на организацию</td></tr><tr><td>usage_period_idx</td><td>period_start DESC</td><td>BTREE</td><td>—</td><td>Текущий и прошлый периоды</td></tr></tbody></table><h3 id=ограничения-6>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-6 class=anchor>#</a></h3><ul><li>FK: <code>organization_id</code> → <code>organizations.id</code> ON DELETE CASCADE</li><li>CHECK: <code>period_end > period_start</code> — корректный диапазон</li></ul><h3 id=типичные-запросы-7>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-7 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Использование организации в текущем месяце
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> presentations_generated, tokens_used, cost_usd
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> usage_records
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> period_start <span style=color:#f92672>=</span> date_trunc(<span style=color:#e6db74>&#39;month&#39;</span>, now())::DATE;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Атомарное увеличение счётчиков (UPSERT)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> usage_records (organization_id, period_start, period_end, slides_generated, tokens_used, cost_usd)
</span></span><span style=display:flex><span><span style=color:#66d9ef>VALUES</span> (<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>4</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>5</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>ON</span> CONFLICT (organization_id, period_start)
</span></span><span style=display:flex><span><span style=color:#66d9ef>DO</span> <span style=color:#66d9ef>UPDATE</span> <span style=color:#66d9ef>SET</span>
</span></span><span style=display:flex><span>    slides_generated <span style=color:#f92672>=</span> usage_records.slides_generated <span style=color:#f92672>+</span> EXCLUDED.slides_generated,
</span></span><span style=display:flex><span>    tokens_used <span style=color:#f92672>=</span> usage_records.tokens_used <span style=color:#f92672>+</span> EXCLUDED.tokens_used,
</span></span><span style=display:flex><span>    cost_usd <span style=color:#f92672>=</span> usage_records.cost_usd <span style=color:#f92672>+</span> EXCLUDED.cost_usd,
</span></span><span style=display:flex><span>    updated_at <span style=color:#f92672>=</span> now();
</span></span></code></pre></div><h3 id=связи-7>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-7 class=anchor>#</a></h3><ul><li><code>organizations</code> (многие к одному) через <code>organization_id</code></li></ul><hr><h2 id=таблица-brand_kits>Таблица: <code>brand_kits</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-brand_kits class=anchor>#</a></h2><p><strong>Домен:</strong> Presentation
<strong>Назначение:</strong> Корпоративный стиль организации — цвета, шрифты, логотип, шаблон.</p><h3 id=поля-8>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-8 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Организация-владелец</td></tr><tr><td>name</td><td>VARCHAR(100)</td><td>✓</td><td>—</td><td>—</td><td>Название кита</td></tr><tr><td>is_default</td><td>BOOLEAN</td><td>✓</td><td>FALSE</td><td>—</td><td>Применяется ли по умолчанию</td></tr><tr><td>primary_color</td><td>CHAR(7)</td><td>✗</td><td>NULL</td><td>CHECK ~*</td><td>HEX цвет #RRGGBB</td></tr><tr><td>secondary_color</td><td>CHAR(7)</td><td>✗</td><td>NULL</td><td>CHECK ~*</td><td>HEX цвет</td></tr><tr><td>background_color</td><td>CHAR(7)</td><td>✗</td><td>NULL</td><td>CHECK ~*</td><td>HEX цвет фона</td></tr><tr><td>accent_color</td><td>CHAR(7)</td><td>✗</td><td>NULL</td><td>CHECK ~*</td><td>HEX акцентный цвет</td></tr><tr><td>text_color</td><td>CHAR(7)</td><td>✗</td><td>NULL</td><td>CHECK ~*</td><td>HEX цвет текста</td></tr><tr><td>logo_url</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>URL логотипа (SVG/PNG)</td></tr><tr><td>font_heading</td><td>VARCHAR(100)</td><td>✗</td><td>NULL</td><td>—</td><td>Шрифт заголовков</td></tr><tr><td>font_body</td><td>VARCHAR(100)</td><td>✗</td><td>NULL</td><td>—</td><td>Шрифт тела</td></tr><tr><td>additional_settings</td><td>JSONB</td><td>✗</td><td>&lsquo;{}&rsquo;</td><td>—</td><td>Дополнительные параметры</td></tr><tr><td>template_s3_key</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>S3-ключ PPTX-шаблона</td></tr><tr><td>created_by</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Кто создал</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr></tbody></table><h3 id=индексы-8>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-8 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>brand_kits_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>brand_kits_org_name_key</td><td>(organization_id, name)</td><td>BTREE UNIQUE</td><td>—</td><td>Уникальность имени в организации</td></tr><tr><td>brand_kits_org_default_idx</td><td>(organization_id, is_default)</td><td>BTREE</td><td>WHERE is_default = TRUE</td><td>Быстрый доступ к дефолтному</td></tr></tbody></table><h3 id=ограничения-7>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-7 class=anchor>#</a></h3><ul><li>FK: <code>organization_id</code> → <code>organizations.id</code> ON DELETE CASCADE</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE RESTRICT</li><li>CHECK: <code>primary_color ~* '^#[0-9A-F]{6}$'</code> — формат HEX-цвета (аналогично для всех color полей)</li></ul><h3 id=триггеры-4>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b-4 class=anchor>#</a></h3><ul><li><code>trg_brand_kits_single_default</code> — при установке <code>is_default = TRUE</code> снимает флаг со всех других кит-сетов организации:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> fn_ensure_single_default_brand_kit()
</span></span><span style=display:flex><span><span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TRIGGER</span> <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NEW</span>.is_default <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span> <span style=color:#66d9ef>THEN</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>UPDATE</span> brand_kits
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SET</span> is_default <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>WHERE</span> organization_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>NEW</span>.organization_id <span style=color:#66d9ef>AND</span> id <span style=color:#f92672>!=</span> <span style=color:#66d9ef>NEW</span>.id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>END</span> <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>RETURN</span> <span style=color:#66d9ef>NEW</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> plpgsql;
</span></span></code></pre></div><h3 id=типичные-запросы-8>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-8 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Получить дефолтный Brand Kit организации
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, primary_color, secondary_color, font_heading, font_body, logo_url, template_s3_key
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> brand_kits
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> is_default <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>;
</span></span></code></pre></div><h3 id=связи-8>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-8 class=anchor>#</a></h3><ul><li><code>organizations</code> (многие к одному) через <code>organization_id</code></li><li><code>presentations</code> (один ко многим) через <code>brand_kit_id</code></li></ul><hr><h2 id=таблица-projects>Таблица: <code>projects</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-projects class=anchor>#</a></h2><p><strong>Домен:</strong> Presentation
<strong>Назначение:</strong> Контейнер для группировки презентаций внутри организации.</p><h3 id=поля-9>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-9 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Организация-владелец</td></tr><tr><td>name</td><td>VARCHAR(255)</td><td>✓</td><td>—</td><td>—</td><td>Название проекта</td></tr><tr><td>description</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Описание проекта</td></tr><tr><td>is_archived</td><td>BOOLEAN</td><td>✓</td><td>FALSE</td><td>—</td><td>Архивирован ли</td></tr><tr><td>created_by</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Создатель</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr></tbody></table><h3 id=индексы-9>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-9 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>projects_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>projects_org_idx</td><td>(organization_id, is_archived)</td><td>BTREE</td><td>WHERE is_archived = FALSE</td><td>Активные проекты организации</td></tr><tr><td>projects_created_by_idx</td><td>created_by</td><td>BTREE</td><td>—</td><td>Проекты пользователя</td></tr></tbody></table><h3 id=ограничения-8>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-8 class=anchor>#</a></h3><ul><li>FK: <code>organization_id</code> → <code>organizations.id</code> ON DELETE CASCADE</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE RESTRICT</li></ul><h3 id=типичные-запросы-9>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-9 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Список активных проектов с количеством презентаций
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> p.id, p.name, p.description, <span style=color:#66d9ef>COUNT</span>(pr.id) <span style=color:#66d9ef>AS</span> presentation_count
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> projects p
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> presentations pr <span style=color:#66d9ef>ON</span> pr.project_id <span style=color:#f92672>=</span> p.id <span style=color:#66d9ef>AND</span> pr.deleted_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> p.organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> p.is_archived <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> p.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> p.updated_at <span style=color:#66d9ef>DESC</span>;
</span></span></code></pre></div><h3 id=связи-9>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-9 class=anchor>#</a></h3><ul><li><code>organizations</code> (многие к одному) через <code>organization_id</code></li><li><code>presentations</code> (один ко многим) через <code>project_id</code></li></ul><hr><h2 id=таблица-presentations>Таблица: <code>presentations</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-presentations class=anchor>#</a></h2><p><strong>Домен:</strong> Presentation
<strong>Назначение:</strong> Основная сущность — презентация со всеми метаданными.</p><h3 id=поля-10>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-10 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>project_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Проект-контейнер</td></tr><tr><td>title</td><td>VARCHAR(500)</td><td>✓</td><td>—</td><td>—</td><td>Заголовок презентации</td></tr><tr><td>description</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Описание / промпт</td></tr><tr><td>status</td><td>presentation_status</td><td>✓</td><td>&lsquo;draft&rsquo;</td><td>—</td><td>Статус жизненного цикла</td></tr><tr><td>tone</td><td>tone_type</td><td>✗</td><td>NULL</td><td>—</td><td>Тональность</td></tr><tr><td>target_audience</td><td>VARCHAR(100)</td><td>✗</td><td>NULL</td><td>—</td><td>Целевая аудитория</td></tr><tr><td>language</td><td>CHAR(5)</td><td>✓</td><td>&lsquo;ru&rsquo;</td><td>—</td><td>Язык (BCP 47: ru, en-US…)</td></tr><tr><td>slide_count</td><td>INT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Денормализованный счётчик слайдов</td></tr><tr><td>thumbnail_url</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>URL превью</td></tr><tr><td>brand_kit_id</td><td>UUID</td><td>✗</td><td>NULL</td><td>FK</td><td>Применённый Brand Kit</td></tr><tr><td>current_generation_job_id</td><td>UUID</td><td>✗</td><td>NULL</td><td>—</td><td>Текущая задача генерации (soft FK)</td></tr><tr><td>created_by</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Создатель</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr><tr><td>deleted_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Soft delete</td></tr></tbody></table><h3 id=индексы-10>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-10 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>presentations_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>presentations_project_idx</td><td>(project_id, created_at DESC)</td><td>BTREE</td><td>WHERE deleted_at IS NULL</td><td>Список презентаций проекта</td></tr><tr><td>presentations_creator_idx</td><td>(created_by, status)</td><td>BTREE</td><td>WHERE deleted_at IS NULL</td><td>Мои презентации по статусу</td></tr><tr><td>presentations_status_idx</td><td>status</td><td>BTREE</td><td>WHERE status IN (&lsquo;generating&rsquo;)</td><td>Мониторинг активных генераций</td></tr></tbody></table><h3 id=ограничения-9>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-9 class=anchor>#</a></h3><ul><li>FK: <code>project_id</code> → <code>projects.id</code> ON DELETE CASCADE</li><li>FK: <code>brand_kit_id</code> → <code>brand_kits.id</code> ON DELETE SET NULL</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE RESTRICT</li></ul><h3 id=enum-типы-2>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-2 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> presentation_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;draft&#39;</span>, <span style=color:#e6db74>&#39;outline_ready&#39;</span>, <span style=color:#e6db74>&#39;generating&#39;</span>, <span style=color:#e6db74>&#39;ready&#39;</span>, <span style=color:#e6db74>&#39;error&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> tone_type <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;formal&#39;</span>, <span style=color:#e6db74>&#39;business&#39;</span>, <span style=color:#e6db74>&#39;persuasive&#39;</span>, <span style=color:#e6db74>&#39;technical&#39;</span>, <span style=color:#e6db74>&#39;educational&#39;</span>, <span style=color:#e6db74>&#39;friendly&#39;</span>);
</span></span></code></pre></div><h3 id=триггеры-5>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b-5 class=anchor>#</a></h3><ul><li><code>trg_presentations_updated_at</code> — обновляет <code>updated_at</code> при UPDATE</li><li><code>trg_presentations_slide_count</code> — обновляет <code>slide_count</code> при INSERT/DELETE в таблице <code>slides</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> fn_update_slide_count()
</span></span><span style=display:flex><span><span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TRIGGER</span> <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>UPDATE</span> presentations
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SET</span> slide_count <span style=color:#f92672>=</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>FROM</span> slides <span style=color:#66d9ef>WHERE</span> presentation_id <span style=color:#f92672>=</span> COALESCE(<span style=color:#66d9ef>NEW</span>.presentation_id, <span style=color:#66d9ef>OLD</span>.presentation_id)),
</span></span><span style=display:flex><span>        updated_at <span style=color:#f92672>=</span> now()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> COALESCE(<span style=color:#66d9ef>NEW</span>.presentation_id, <span style=color:#66d9ef>OLD</span>.presentation_id);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>RETURN</span> <span style=color:#66d9ef>NULL</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> plpgsql;
</span></span></code></pre></div><h3 id=типичные-запросы-10>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-10 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Список презентаций в проекте с пагинацией
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, title, status, slide_count, thumbnail_url, created_at, updated_at
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> presentations
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> project_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> deleted_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> updated_at <span style=color:#66d9ef>DESC</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>20</span> <span style=color:#66d9ef>OFFSET</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Полная презентация со слайдами (при открытии редактора)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> p.<span style=color:#f92672>*</span>, json_agg(
</span></span><span style=display:flex><span>    json_build_object(<span style=color:#e6db74>&#39;id&#39;</span>, s.id, <span style=color:#e6db74>&#39;position&#39;</span>, s.<span style=color:#66d9ef>position</span>, <span style=color:#e6db74>&#39;title&#39;</span>, s.title,
</span></span><span style=display:flex><span>                      <span style=color:#e6db74>&#39;slide_type&#39;</span>, s.slide_type, <span style=color:#e6db74>&#39;status&#39;</span>, s.status, <span style=color:#e6db74>&#39;content&#39;</span>, s.content)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> s.<span style=color:#66d9ef>position</span>
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>AS</span> slides
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> presentations p
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> slides s <span style=color:#66d9ef>ON</span> s.presentation_id <span style=color:#f92672>=</span> p.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> p.id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> p.deleted_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> p.id;
</span></span></code></pre></div><h3 id=связи-10>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-10 class=anchor>#</a></h3><ul><li><code>projects</code> (многие к одному) через <code>project_id</code></li><li><code>slides</code> (один ко многим) через <code>presentation_id</code></li><li><code>brand_kits</code> (многие к одному) через <code>brand_kit_id</code></li><li><code>generation_jobs</code> (один ко многим) через <code>presentation_id</code></li><li><code>export_jobs</code> (один ко многим) через <code>presentation_id</code></li><li><code>presentation_sources</code> (один ко многим) через <code>presentation_id</code></li></ul><hr><h2 id=таблица-slides>Таблица: <code>slides</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-slides class=anchor>#</a></h2><p><strong>Домен:</strong> Presentation
<strong>Назначение:</strong> Отдельный слайд презентации с контентом и метаданными атрибуции.</p><h3 id=поля-11>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-11 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>presentation_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Родительская презентация</td></tr><tr><td>position</td><td>SMALLINT</td><td>✓</td><td>—</td><td>CHECK > 0</td><td>Порядковый номер (1-based)</td></tr><tr><td>title</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Заголовок слайда</td></tr><tr><td>content</td><td>JSONB</td><td>✓</td><td>&lsquo;{}&rsquo;</td><td>—</td><td>Контент: блоки текста, графики, таблицы</td></tr><tr><td>slide_type</td><td>slide_type</td><td>✓</td><td>&lsquo;content&rsquo;</td><td>—</td><td>Тип слайда</td></tr><tr><td>status</td><td>slide_status</td><td>✓</td><td>&lsquo;pending&rsquo;</td><td>—</td><td>Статус генерации</td></tr><tr><td>source_refs</td><td>JSONB</td><td>✓</td><td>&lsquo;[]&rsquo;</td><td>—</td><td>Ссылки на источники для attribution</td></tr><tr><td>hallucination_flags</td><td>JSONB</td><td>✓</td><td>&lsquo;[]&rsquo;</td><td>—</td><td>Флаги проверки фактов</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr></tbody></table><h3 id=индексы-11>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-11 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>slides_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>slides_presentation_pos_key</td><td>(presentation_id, position)</td><td>BTREE UNIQUE</td><td>—</td><td>Уникальность позиции</td></tr><tr><td>slides_pres_status_idx</td><td>(presentation_id, status)</td><td>BTREE</td><td>WHERE status != &lsquo;ready&rsquo;</td><td>Мониторинг незавершённых слайдов</td></tr></tbody></table><h3 id=ограничения-10>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-10 class=anchor>#</a></h3><ul><li>FK: <code>presentation_id</code> → <code>presentations.id</code> ON DELETE CASCADE</li><li>CHECK: <code>position > 0</code> — позиция положительная</li></ul><h3 id=enum-типы-3>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-3 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> slide_type <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;title_slide&#39;</span>, <span style=color:#e6db74>&#39;content&#39;</span>, <span style=color:#e6db74>&#39;chart&#39;</span>, <span style=color:#e6db74>&#39;table&#39;</span>, <span style=color:#e6db74>&#39;image&#39;</span>, <span style=color:#e6db74>&#39;quote&#39;</span>, <span style=color:#e6db74>&#39;divider&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> slide_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pending&#39;</span>, <span style=color:#e6db74>&#39;generating&#39;</span>, <span style=color:#e6db74>&#39;ready&#39;</span>, <span style=color:#e6db74>&#39;error&#39;</span>);
</span></span></code></pre></div><h3 id=триггеры-6>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b-6 class=anchor>#</a></h3><ul><li><code>trg_slides_updated_at</code> — обновляет <code>updated_at</code> при UPDATE</li><li><code>trg_slides_version_snapshot</code> — при UPDATE создаёт запись в <code>slide_versions</code> (если контент изменился):</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> fn_snapshot_slide_version()
</span></span><span style=display:flex><span><span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TRIGGER</span> <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>OLD</span>.content <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>DISTINCT</span> <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>NEW</span>.content <span style=color:#66d9ef>THEN</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> slide_versions (slide_id, version_number, content, created_by, created_at)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>VALUES</span> (
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>OLD</span>.id,
</span></span><span style=display:flex><span>            (<span style=color:#66d9ef>SELECT</span> COALESCE(<span style=color:#66d9ef>MAX</span>(version_number), <span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>FROM</span> slide_versions <span style=color:#66d9ef>WHERE</span> slide_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>OLD</span>.id),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>OLD</span>.content,
</span></span><span style=display:flex><span>            current_setting(<span style=color:#e6db74>&#39;app.current_user_id&#39;</span>, <span style=color:#66d9ef>true</span>)::uuid,
</span></span><span style=display:flex><span>            now()
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>END</span> <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>RETURN</span> <span style=color:#66d9ef>NEW</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> plpgsql;
</span></span></code></pre></div><h3 id=типичные-запросы-11>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-11 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Слайды презентации в порядке
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, <span style=color:#66d9ef>position</span>, title, slide_type, status, content, source_refs
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> slides
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> presentation_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>position</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Обновление контента слайда (инициирует триггер версионирования)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>UPDATE</span> slides
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> content <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>, status <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ready&#39;</span>, updated_at <span style=color:#f92672>=</span> now()
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><h3 id=связи-11>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-11 class=anchor>#</a></h3><ul><li><code>presentations</code> (многие к одному) через <code>presentation_id</code></li><li><code>slide_versions</code> (один ко многим) через <code>slide_id</code></li></ul><hr><h2 id=таблица-slide_versions>Таблица: <code>slide_versions</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-slide_versions class=anchor>#</a></h2><p><strong>Домен:</strong> Presentation
<strong>Назначение:</strong> История версий контента слайда (до 20 версий согласно US-405).</p><h3 id=поля-12>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-12 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>slide_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Родительский слайд</td></tr><tr><td>version_number</td><td>SMALLINT</td><td>✓</td><td>—</td><td>CHECK > 0</td><td>Номер версии</td></tr><tr><td>content</td><td>JSONB</td><td>✓</td><td>—</td><td>—</td><td>Снимок контента слайда</td></tr><tr><td>created_by</td><td>UUID</td><td>✗</td><td>NULL</td><td>FK</td><td>Кто инициировал изменение</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Время создания версии</td></tr></tbody></table><h3 id=индексы-12>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-12 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>slide_versions_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>slide_ver_slide_num_key</td><td>(slide_id, version_number)</td><td>BTREE UNIQUE</td><td>—</td><td>Уникальность версии</td></tr><tr><td>slide_ver_slide_idx</td><td>(slide_id, version_number DESC)</td><td>BTREE</td><td>—</td><td>История версий в обратном порядке</td></tr></tbody></table><h3 id=ограничения-11>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-11 class=anchor>#</a></h3><ul><li>FK: <code>slide_id</code> → <code>slides.id</code> ON DELETE CASCADE</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE SET NULL</li><li>CHECK: <code>version_number > 0</code></li></ul><h3 id=типичные-запросы-12>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-12 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- История версий слайда (до 20 записей)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> version_number, created_at, created_by
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> slide_versions
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> slide_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> version_number <span style=color:#66d9ef>DESC</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Восстановить версию N
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>UPDATE</span> slides
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> content <span style=color:#f92672>=</span> (<span style=color:#66d9ef>SELECT</span> content <span style=color:#66d9ef>FROM</span> slide_versions <span style=color:#66d9ef>WHERE</span> slide_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> version_number <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><h3 id=связи-12>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-12 class=anchor>#</a></h3><ul><li><code>slides</code> (многие к одному) через <code>slide_id</code></li></ul><hr><h2 id=таблица-presentation_shares>Таблица: <code>presentation_shares</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-presentation_shares class=anchor>#</a></h2><p><strong>Домен:</strong> Presentation
<strong>Назначение:</strong> Публичные ссылки для просмотра / комментирования / редактирования презентации.</p><h3 id=поля-13>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-13 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>presentation_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Презентация</td></tr><tr><td>token</td><td>CHAR(32)</td><td>✓</td><td>—</td><td>UNIQUE</td><td>Случайный токен ссылки</td></tr><tr><td>access_level</td><td>share_access</td><td>✓</td><td>&lsquo;view&rsquo;</td><td>—</td><td>Уровень доступа</td></tr><tr><td>password_hash</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Хеш пароля (bcrypt, если защищена)</td></tr><tr><td>expires_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Срок действия (NULL = бессрочная)</td></tr><tr><td>view_count</td><td>INT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Счётчик просмотров</td></tr><tr><td>created_by</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Кто создал</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr></tbody></table><h3 id=индексы-13>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-13 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>shares_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>shares_token_key</td><td>token</td><td>BTREE UNIQUE</td><td>—</td><td>Быстрый поиск по токену из URL</td></tr><tr><td>shares_pres_idx</td><td>presentation_id</td><td>BTREE</td><td>—</td><td>Ссылки презентации</td></tr></tbody></table><h3 id=ограничения-12>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-12 class=anchor>#</a></h3><ul><li>FK: <code>presentation_id</code> → <code>presentations.id</code> ON DELETE CASCADE</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE RESTRICT</li></ul><h3 id=enum-типы-4>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-4 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> share_access <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;view&#39;</span>, <span style=color:#e6db74>&#39;comment&#39;</span>, <span style=color:#e6db74>&#39;edit&#39;</span>);
</span></span></code></pre></div><h3 id=типичные-запросы-13>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-13 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Валидация токена ссылки
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> ps.presentation_id, ps.access_level, ps.password_hash
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> presentation_shares ps
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> ps.token <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> (ps.expires_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>OR</span> ps.expires_at <span style=color:#f92672>&gt;</span> now());
</span></span></code></pre></div><h3 id=связи-13>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-13 class=anchor>#</a></h3><ul><li><code>presentations</code> (многие к одному) через <code>presentation_id</code></li></ul><hr><h2 id=таблица-source_documents>Таблица: <code>source_documents</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-source_documents class=anchor>#</a></h2><p><strong>Домен:</strong> AI
<strong>Назначение:</strong> Метаданные исходных документов, загруженных пользователем для RAG-пайплайна.</p><h3 id=поля-14>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-14 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Организация-владелец</td></tr><tr><td>original_filename</td><td>TEXT</td><td>✓</td><td>—</td><td>—</td><td>Оригинальное имя файла</td></tr><tr><td>file_type</td><td>source_file_type</td><td>✓</td><td>—</td><td>—</td><td>Тип источника</td></tr><tr><td>s3_key</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>S3-ключ файла (NULL для URL)</td></tr><tr><td>file_size_bytes</td><td>BIGINT</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Размер файла</td></tr><tr><td>content_hash</td><td>CHAR(64)</td><td>✗</td><td>NULL</td><td>—</td><td>SHA-256 для дедупликации</td></tr><tr><td>url</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>URL веб-источника</td></tr><tr><td>ingestion_status</td><td>ingestion_status</td><td>✓</td><td>&lsquo;pending&rsquo;</td><td>—</td><td>Статус обработки</td></tr><tr><td>page_count</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Количество страниц</td></tr><tr><td>word_count</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Количество слов</td></tr><tr><td>created_by</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Загрузил</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата загрузки</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr></tbody></table><h3 id=индексы-14>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-14 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>source_docs_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>source_docs_hash_idx</td><td>content_hash</td><td>BTREE</td><td>WHERE content_hash IS NOT NULL</td><td>Дедупликация файлов</td></tr><tr><td>source_docs_org_status_idx</td><td>(organization_id, ingestion_status)</td><td>BTREE</td><td>—</td><td>Фильтр по статусу индексации</td></tr><tr><td>source_docs_org_idx</td><td>organization_id</td><td>BTREE</td><td>—</td><td>Документы организации</td></tr></tbody></table><h3 id=ограничения-13>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-13 class=anchor>#</a></h3><ul><li>FK: <code>organization_id</code> → <code>organizations.id</code> ON DELETE CASCADE</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE RESTRICT</li><li>CHECK: <code>(s3_key IS NOT NULL AND url IS NULL) OR (s3_key IS NULL AND url IS NOT NULL)</code> — либо файл, либо URL</li></ul><h3 id=enum-типы-5>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-5 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> source_file_type <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pdf&#39;</span>, <span style=color:#e6db74>&#39;docx&#39;</span>, <span style=color:#e6db74>&#39;xlsx&#39;</span>, <span style=color:#e6db74>&#39;csv&#39;</span>, <span style=color:#e6db74>&#39;pptx&#39;</span>, <span style=color:#e6db74>&#39;url&#39;</span>, <span style=color:#e6db74>&#39;image&#39;</span>, <span style=color:#e6db74>&#39;txt&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> ingestion_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pending&#39;</span>, <span style=color:#e6db74>&#39;processing&#39;</span>, <span style=color:#e6db74>&#39;indexed&#39;</span>, <span style=color:#e6db74>&#39;failed&#39;</span>);
</span></span></code></pre></div><h3 id=типичные-запросы-14>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-14 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Проверить дубликат перед загрузкой
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, ingestion_status <span style=color:#66d9ef>FROM</span> source_documents
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AND</span> content_hash <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Источники, использованные в презентации
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> sd.id, sd.original_filename, sd.file_type, sd.ingestion_status
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> source_documents sd
</span></span><span style=display:flex><span><span style=color:#66d9ef>JOIN</span> presentation_sources ps <span style=color:#66d9ef>ON</span> ps.source_document_id <span style=color:#f92672>=</span> sd.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> ps.presentation_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><h3 id=связи-14>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-14 class=anchor>#</a></h3><ul><li><code>organizations</code> (многие к одному) через <code>organization_id</code></li><li><code>presentation_sources</code> (один ко многим) через <code>source_document_id</code></li><li><code>document_ingestion_jobs</code> (один ко многим) через <code>source_document_id</code></li></ul><hr><h2 id=таблица-presentation_sources>Таблица: <code>presentation_sources</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-presentation_sources class=anchor>#</a></h2><p><strong>Домен:</strong> AI
<strong>Назначение:</strong> Связь M:N между презентациями и исходными документами.</p><h3 id=поля-15>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-15 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>presentation_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Презентация</td></tr><tr><td>source_document_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Исходный документ</td></tr><tr><td>added_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Когда добавлен источник</td></tr></tbody></table><h3 id=индексы-15>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-15 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>pres_sources_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>pres_sources_unique_key</td><td>(presentation_id, source_document_id)</td><td>BTREE UNIQUE</td><td>—</td><td>Нет дублей</td></tr><tr><td>pres_sources_pres_idx</td><td>presentation_id</td><td>BTREE</td><td>—</td><td>Источники презентации</td></tr><tr><td>pres_sources_doc_idx</td><td>source_document_id</td><td>BTREE</td><td>—</td><td>Презентации, использующие документ</td></tr></tbody></table><h3 id=ограничения-14>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-14 class=anchor>#</a></h3><ul><li>FK: <code>presentation_id</code> → <code>presentations.id</code> ON DELETE CASCADE</li><li>FK: <code>source_document_id</code> → <code>source_documents.id</code> ON DELETE RESTRICT</li></ul><h3 id=связи-15>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-15 class=anchor>#</a></h3><ul><li><code>presentations</code> (многие к одному) через <code>presentation_id</code></li><li><code>source_documents</code> (многие к одному) через <code>source_document_id</code></li></ul><hr><h2 id=таблица-document_ingestion_jobs>Таблица: <code>document_ingestion_jobs</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-document_ingestion_jobs class=anchor>#</a></h2><p><strong>Домен:</strong> AI
<strong>Назначение:</strong> Задачи асинхронной обработки документа (chunking + embedding + Qdrant).</p><h3 id=поля-16>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-16 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>source_document_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Обрабатываемый документ</td></tr><tr><td>status</td><td>job_status</td><td>✓</td><td>&lsquo;pending&rsquo;</td><td>—</td><td>Статус задачи</td></tr><tr><td>chunks_created</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Создано чанков</td></tr><tr><td>embeddings_created</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Создано embeddings</td></tr><tr><td>worker_id</td><td>VARCHAR(100)</td><td>✗</td><td>NULL</td><td>—</td><td>Celery worker ID</td></tr><tr><td>started_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Начало обработки</td></tr><tr><td>completed_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Окончание обработки</td></tr><tr><td>error_message</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Сообщение об ошибке</td></tr><tr><td>retry_count</td><td>SMALLINT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Количество повторов</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr></tbody></table><h3 id=индексы-16>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-16 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>ingest_jobs_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>ingest_jobs_doc_idx</td><td>source_document_id</td><td>BTREE</td><td>—</td><td>Задачи документа</td></tr><tr><td>ingest_jobs_pending_idx</td><td>(created_at, status)</td><td>BTREE</td><td>WHERE status = &lsquo;pending&rsquo;</td><td>Очередь задач для Celery</td></tr></tbody></table><h3 id=ограничения-15>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-15 class=anchor>#</a></h3><ul><li>FK: <code>source_document_id</code> → <code>source_documents.id</code> ON DELETE CASCADE</li></ul><h3 id=enum-типы-6>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-6 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> job_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pending&#39;</span>, <span style=color:#e6db74>&#39;running&#39;</span>, <span style=color:#e6db74>&#39;completed&#39;</span>, <span style=color:#e6db74>&#39;failed&#39;</span>, <span style=color:#e6db74>&#39;retrying&#39;</span>);
</span></span></code></pre></div><h3 id=связи-16>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-16 class=anchor>#</a></h3><ul><li><code>source_documents</code> (многие к одному) через <code>source_document_id</code></li></ul><hr><h2 id=таблица-generation_jobs>Таблица: <code>generation_jobs</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-generation_jobs class=anchor>#</a></h2><p><strong>Домен:</strong> AI
<strong>Назначение:</strong> Задачи генерации презентаций через LLM (LangGraph pipeline).</p><h3 id=поля-17>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-17 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>presentation_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Целевая презентация</td></tr><tr><td>status</td><td>job_status</td><td>✓</td><td>&lsquo;pending&rsquo;</td><td>—</td><td>Статус задачи</td></tr><tr><td>llm_provider</td><td>llm_provider</td><td>✗</td><td>NULL</td><td>—</td><td>Использованный LLM</td></tr><tr><td>outline_tokens_used</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Токены на генерацию outline</td></tr><tr><td>generation_tokens_used</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Токены на генерацию слайдов</td></tr><tr><td>total_tokens_used</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Суммарные токены</td></tr><tr><td>total_cost_usd</td><td>NUMERIC(10,6)</td><td>✗</td><td>NULL</td><td>CHECK >= 0</td><td>Стоимость генерации</td></tr><tr><td>slides_completed</td><td>INT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Готово слайдов</td></tr><tr><td>slides_total</td><td>INT</td><td>✗</td><td>NULL</td><td>CHECK > 0</td><td>Всего слайдов</td></tr><tr><td>worker_id</td><td>VARCHAR(100)</td><td>✗</td><td>NULL</td><td>—</td><td>Celery worker ID</td></tr><tr><td>started_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Начало генерации</td></tr><tr><td>completed_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Окончание генерации</td></tr><tr><td>error_message</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Сообщение об ошибке</td></tr><tr><td>retry_count</td><td>SMALLINT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Количество повторов</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr></tbody></table><h3 id=индексы-17>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-17 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>gen_jobs_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>gen_jobs_pres_idx</td><td>presentation_id</td><td>BTREE</td><td>—</td><td>Задачи презентации</td></tr><tr><td>gen_jobs_pending_idx</td><td>(created_at, status)</td><td>BTREE</td><td>WHERE status IN (&lsquo;pending&rsquo;,&lsquo;running&rsquo;)</td><td>Мониторинг активных задач</td></tr></tbody></table><h3 id=ограничения-16>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-16 class=anchor>#</a></h3><ul><li>FK: <code>presentation_id</code> → <code>presentations.id</code> ON DELETE CASCADE</li></ul><h3 id=enum-типы-7>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-7 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> llm_provider <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;claude&#39;</span>, <span style=color:#e6db74>&#39;gpt4o&#39;</span>, <span style=color:#e6db74>&#39;llama3&#39;</span>, <span style=color:#e6db74>&#39;gemini&#39;</span>);
</span></span></code></pre></div><h3 id=триггеры-7>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b-7 class=anchor>#</a></h3><ul><li><code>trg_generation_jobs_sync_status</code> — при изменении <code>status</code> в <code>generation_jobs</code> синхронизирует <code>presentations.status</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> fn_sync_presentation_status()
</span></span><span style=display:flex><span><span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TRIGGER</span> <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>UPDATE</span> presentations <span style=color:#66d9ef>SET</span>
</span></span><span style=display:flex><span>        status <span style=color:#f92672>=</span> <span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>NEW</span>.status
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>WHEN</span> <span style=color:#e6db74>&#39;running&#39;</span>   <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;generating&#39;</span>::presentation_status
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>WHEN</span> <span style=color:#e6db74>&#39;completed&#39;</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;ready&#39;</span>::presentation_status
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>WHEN</span> <span style=color:#e6db74>&#39;failed&#39;</span>    <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;error&#39;</span>::presentation_status
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>ELSE</span> presentations.status
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>END</span>,
</span></span><span style=display:flex><span>        updated_at <span style=color:#f92672>=</span> now()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#66d9ef>NEW</span>.presentation_id
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>AND</span> current_generation_job_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>NEW</span>.id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>RETURN</span> <span style=color:#66d9ef>NEW</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> plpgsql;
</span></span></code></pre></div><h3 id=типичные-запросы-15>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-15 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Прогресс генерации для WebSocket stream
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> slides_completed, slides_total, status, error_message
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> generation_jobs
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Cost analytics за период
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> llm_provider, <span style=color:#66d9ef>SUM</span>(total_cost_usd) <span style=color:#66d9ef>AS</span> total_cost, <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>AS</span> jobs_count
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> generation_jobs
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> presentation_id <span style=color:#66d9ef>IN</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> presentations <span style=color:#66d9ef>WHERE</span> project_id <span style=color:#66d9ef>IN</span> (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> projects <span style=color:#66d9ef>WHERE</span> organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>AND</span> completed_at <span style=color:#66d9ef>BETWEEN</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>AND</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> llm_provider;
</span></span></code></pre></div><h3 id=связи-17>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-17 class=anchor>#</a></h3><ul><li><code>presentations</code> (многие к одному) через <code>presentation_id</code></li></ul><hr><h2 id=таблица-export_jobs>Таблица: <code>export_jobs</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-export_jobs class=anchor>#</a></h2><p><strong>Домен:</strong> AI
<strong>Назначение:</strong> Задачи экспорта презентации в PPTX, PDF, Google Slides, PNG.</p><h3 id=поля-18>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-18 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>presentation_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Исходная презентация</td></tr><tr><td>format</td><td>export_format</td><td>✓</td><td>—</td><td>—</td><td>Формат экспорта</td></tr><tr><td>status</td><td>job_status</td><td>✓</td><td>&lsquo;pending&rsquo;</td><td>—</td><td>Статус задачи</td></tr><tr><td>s3_key</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>S3-ключ результата (PPTX/PDF)</td></tr><tr><td>google_file_id</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Google Drive file ID</td></tr><tr><td>download_url</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Presigned S3 URL для скачивания</td></tr><tr><td>expires_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Срок жизни ссылки</td></tr><tr><td>slide_range</td><td>INT[]</td><td>✗</td><td>NULL</td><td>—</td><td>Диапазон слайдов (NULL = все)</td></tr><tr><td>created_by</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Инициатор</td></tr><tr><td>started_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Начало экспорта</td></tr><tr><td>completed_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Окончание</td></tr><tr><td>error_message</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>Сообщение об ошибке</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr></tbody></table><h3 id=индексы-18>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-18 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>export_jobs_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>export_jobs_pres_idx</td><td>(presentation_id, format)</td><td>BTREE</td><td>—</td><td>Экспорты презентации</td></tr><tr><td>export_jobs_pending_idx</td><td>status</td><td>BTREE</td><td>WHERE status = &lsquo;pending&rsquo;</td><td>Очередь</td></tr><tr><td>export_jobs_expires_idx</td><td>expires_at</td><td>BTREE</td><td>WHERE expires_at IS NOT NULL</td><td>Очистка истёкших</td></tr></tbody></table><h3 id=ограничения-17>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-17 class=anchor>#</a></h3><ul><li>FK: <code>presentation_id</code> → <code>presentations.id</code> ON DELETE CASCADE</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE RESTRICT</li></ul><h3 id=enum-типы-8>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-8 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> export_format <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pptx&#39;</span>, <span style=color:#e6db74>&#39;pdf&#39;</span>, <span style=color:#e6db74>&#39;google_slides&#39;</span>, <span style=color:#e6db74>&#39;png&#39;</span>, <span style=color:#e6db74>&#39;web&#39;</span>);
</span></span></code></pre></div><h3 id=связи-18>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-18 class=anchor>#</a></h3><ul><li><code>presentations</code> (многие к одному) через <code>presentation_id</code></li></ul><hr><h2 id=таблица-webhook_subscriptions>Таблица: <code>webhook_subscriptions</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-webhook_subscriptions class=anchor>#</a></h2><p><strong>Домен:</strong> AI / Интеграции
<strong>Назначение:</strong> Зарегистрированные webhook-endpoints организаций для получения событий.</p><h3 id=поля-19>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-19 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Организация</td></tr><tr><td>url</td><td>TEXT</td><td>✓</td><td>—</td><td>—</td><td>HTTPS-endpoint для доставки</td></tr><tr><td>secret_hash</td><td>TEXT</td><td>✓</td><td>—</td><td>—</td><td>HMAC-SHA256 подпись (хеш секрета)</td></tr><tr><td>events</td><td>TEXT[]</td><td>✓</td><td>—</td><td>CHECK</td><td>Подписанные типы событий</td></tr><tr><td>is_active</td><td>BOOLEAN</td><td>✓</td><td>TRUE</td><td>—</td><td>Активна ли подписка</td></tr><tr><td>created_by</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Создатель</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата создания</td></tr><tr><td>updated_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Дата обновления</td></tr></tbody></table><h3 id=индексы-19>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-19 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>webhooks_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>webhooks_org_idx</td><td>organization_id</td><td>BTREE</td><td>WHERE is_active = TRUE</td><td>Активные подписки орг.</td></tr></tbody></table><h3 id=ограничения-18>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-18 class=anchor>#</a></h3><ul><li>FK: <code>organization_id</code> → <code>organizations.id</code> ON DELETE CASCADE</li><li>FK: <code>created_by</code> → <code>users.id</code> ON DELETE RESTRICT</li><li>CHECK: <code>url ~ '^https://'</code> — только HTTPS endpoints</li><li>CHECK: <code>array_length(events, 1) > 0</code> — минимум одно событие</li></ul><h3 id=типичные-запросы-16>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-16 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Найти активные подписки для события
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, url, secret_hash, organization_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> webhook_subscriptions
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> is_active <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span> <span style=color:#66d9ef>AND</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>ANY</span>(events);
</span></span></code></pre></div><h3 id=связи-19>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-19 class=anchor>#</a></h3><ul><li><code>organizations</code> (многие к одному) через <code>organization_id</code></li><li><code>webhook_events</code> (один ко многим) через <code>webhook_subscription_id</code></li></ul><hr><h2 id=таблица-webhook_events>Таблица: <code>webhook_events</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-webhook_events class=anchor>#</a></h2><p><strong>Домен:</strong> AI / Интеграции
<strong>Назначение:</strong> Журнал доставки webhook-событий с гарантией at-least-once.</p><h3 id=поля-20>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-20 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Уникальный event_id (идемпотентность на стороне клиента)</td></tr><tr><td>webhook_subscription_id</td><td>UUID</td><td>✓</td><td>—</td><td>FK</td><td>Подписка</td></tr><tr><td>event_type</td><td>VARCHAR(100)</td><td>✓</td><td>—</td><td>—</td><td>Тип события</td></tr><tr><td>payload</td><td>JSONB</td><td>✓</td><td>—</td><td>—</td><td>Тело события</td></tr><tr><td>status</td><td>webhook_status</td><td>✓</td><td>&lsquo;pending&rsquo;</td><td>—</td><td>Статус доставки</td></tr><tr><td>http_status_code</td><td>SMALLINT</td><td>✗</td><td>NULL</td><td>—</td><td>HTTP-ответ от клиента</td></tr><tr><td>attempts</td><td>SMALLINT</td><td>✓</td><td>0</td><td>CHECK >= 0</td><td>Количество попыток</td></tr><tr><td>last_attempt_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Последняя попытка</td></tr><tr><td>next_retry_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Следующая попытка (backoff)</td></tr><tr><td>delivered_at</td><td>TIMESTAMPTZ</td><td>✗</td><td>NULL</td><td>—</td><td>Время успешной доставки</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Время создания события</td></tr></tbody></table><h3 id=индексы-20>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-20 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>wh_events_pkey</td><td>id</td><td>BTREE UNIQUE</td><td>—</td><td>PK</td></tr><tr><td>wh_events_sub_status_idx</td><td>(webhook_subscription_id, status)</td><td>BTREE</td><td>—</td><td>События подписки</td></tr><tr><td>wh_events_retry_idx</td><td>next_retry_at</td><td>BTREE</td><td>WHERE status = &lsquo;pending&rsquo; AND attempts &lt; 5</td><td>Retry scheduler</td></tr></tbody></table><h3 id=ограничения-19>Ограничения<a href=#%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-19 class=anchor>#</a></h3><ul><li>FK: <code>webhook_subscription_id</code> → <code>webhook_subscriptions.id</code> ON DELETE CASCADE</li><li>CHECK: <code>attempts &lt;= 5</code> — максимум 5 попыток доставки</li></ul><h3 id=enum-типы-9>Enum-типы<a href=#enum-%d1%82%d0%b8%d0%bf%d1%8b-9 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> webhook_status <span style=color:#66d9ef>AS</span> ENUM (<span style=color:#e6db74>&#39;pending&#39;</span>, <span style=color:#e6db74>&#39;delivered&#39;</span>, <span style=color:#e6db74>&#39;failed&#39;</span>, <span style=color:#e6db74>&#39;abandoned&#39;</span>);
</span></span></code></pre></div><h3 id=триггеры-8>Триггеры<a href=#%d1%82%d1%80%d0%b8%d0%b3%d0%b3%d0%b5%d1%80%d1%8b-8 class=anchor>#</a></h3><ul><li><code>trg_webhook_events_partition</code> — автоматическое удаление записей старше 7 дней через pg_cron</li></ul><h3 id=типичные-запросы-17>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-17 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Выбрать события для retry (exponential backoff)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> id, webhook_subscription_id, payload, attempts
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> webhook_events
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> status <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pending&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> attempts <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> (next_retry_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>OR</span> next_retry_at <span style=color:#f92672>&lt;=</span> now())
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> created_at
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>100</span>;
</span></span></code></pre></div><h3 id=связи-20>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-20 class=anchor>#</a></h3><ul><li><code>webhook_subscriptions</code> (многие к одному) через <code>webhook_subscription_id</code></li></ul><hr><h2 id=таблица-audit_logs>Таблица: <code>audit_logs</code><a href=#%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-audit_logs class=anchor>#</a></h2><p><strong>Домен:</strong> Auth
<strong>Назначение:</strong> Полный журнал аудита всех значимых действий (хранение 90 дней, партиционирование по месяцам).</p><h3 id=поля-21>Поля<a href=#%d0%bf%d0%be%d0%bb%d1%8f-21 class=anchor>#</a></h3><table><thead><tr><th>Поле</th><th>Тип</th><th>NOT NULL</th><th>Default</th><th>Ограничения</th><th>Описание</th></tr></thead><tbody><tr><td>id</td><td>UUID</td><td>✓</td><td>gen_random_uuid()</td><td>PK</td><td>Первичный ключ</td></tr><tr><td>organization_id</td><td>UUID</td><td>✓</td><td>—</td><td>—</td><td>Организация (без FK — для надёжности хранения)</td></tr><tr><td>user_id</td><td>UUID</td><td>✗</td><td>NULL</td><td>—</td><td>Пользователь (NULL — системные действия)</td></tr><tr><td>action</td><td>VARCHAR(100)</td><td>✓</td><td>—</td><td>—</td><td>Действие: <code>presentation.created</code>, <code>user.deleted</code>…</td></tr><tr><td>resource_type</td><td>VARCHAR(50)</td><td>✗</td><td>NULL</td><td>—</td><td>Тип ресурса: presentation, user, brand_kit…</td></tr><tr><td>resource_id</td><td>UUID</td><td>✗</td><td>NULL</td><td>—</td><td>ID ресурса</td></tr><tr><td>metadata</td><td>JSONB</td><td>✗</td><td>&lsquo;{}&rsquo;</td><td>—</td><td>Дополнительный контекст (diff, параметры)</td></tr><tr><td>ip_address</td><td>INET</td><td>✗</td><td>NULL</td><td>—</td><td>IP-адрес клиента</td></tr><tr><td>user_agent</td><td>TEXT</td><td>✗</td><td>NULL</td><td>—</td><td>User-Agent браузера</td></tr><tr><td>created_at</td><td>TIMESTAMPTZ</td><td>✓</td><td>now()</td><td>—</td><td>Время события</td></tr></tbody></table><h3 id=партиционирование>Партиционирование<a href=#%d0%bf%d0%b0%d1%80%d1%82%d0%b8%d1%86%d0%b8%d0%be%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> audit_logs (
</span></span><span style=display:flex><span>    id UUID <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> gen_random_uuid(),
</span></span><span style=display:flex><span>    organization_id UUID <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    user_id UUID,
</span></span><span style=display:flex><span>    action VARCHAR(<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    resource_type VARCHAR(<span style=color:#ae81ff>50</span>),
</span></span><span style=display:flex><span>    resource_id UUID,
</span></span><span style=display:flex><span>    metadata JSONB <span style=color:#66d9ef>DEFAULT</span> <span style=color:#e6db74>&#39;{}&#39;</span>,
</span></span><span style=display:flex><span>    ip_address INET,
</span></span><span style=display:flex><span>    user_agent TEXT,
</span></span><span style=display:flex><span>    created_at TIMESTAMPTZ <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> now()
</span></span><span style=display:flex><span>) PARTITION <span style=color:#66d9ef>BY</span> RANGE (created_at);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Создание ежемесячных партиций (автоматически через pg_cron)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> audit_logs_2026_03
</span></span><span style=display:flex><span>    PARTITION <span style=color:#66d9ef>OF</span> audit_logs
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>VALUES</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#e6db74>&#39;2026-03-01&#39;</span>) <span style=color:#66d9ef>TO</span> (<span style=color:#e6db74>&#39;2026-04-01&#39;</span>);
</span></span></code></pre></div><h3 id=индексы-21>Индексы<a href=#%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d1%8b-21 class=anchor>#</a></h3><table><thead><tr><th>Имя индекса</th><th>Поля</th><th>Тип</th><th>Условие (PARTIAL)</th><th>Причина</th></tr></thead><tbody><tr><td>audit_pkey</td><td>(id, created_at)</td><td>BTREE UNIQUE</td><td>—</td><td>PK (включает partition key)</td></tr><tr><td>audit_org_time_idx</td><td>(organization_id, created_at DESC)</td><td>BTREE</td><td>—</td><td>Лог организации за период</td></tr><tr><td>audit_user_idx</td><td>(user_id, created_at DESC)</td><td>BTREE</td><td>WHERE user_id IS NOT NULL</td><td>Действия пользователя</td></tr><tr><td>audit_action_idx</td><td>action</td><td>BTREE</td><td>—</td><td>Поиск по типу действия</td></tr></tbody></table><h3 id=типичные-запросы-18>Типичные запросы<a href=#%d1%82%d0%b8%d0%bf%d0%b8%d1%87%d0%bd%d1%8b%d0%b5-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d1%8b-18 class=anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Аудит-лог организации за последние 7 дней
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> action, resource_type, resource_id, user_id, ip_address, created_at
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> audit_logs
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> organization_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> created_at <span style=color:#f92672>&gt;=</span> now() <span style=color:#f92672>-</span> INTERVAL <span style=color:#e6db74>&#39;7 days&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> created_at <span style=color:#66d9ef>DESC</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>100</span>;
</span></span></code></pre></div><h3 id=связи-21>Связи<a href=#%d1%81%d0%b2%d1%8f%d0%b7%d0%b8-21 class=anchor>#</a></h3><p>Намеренно без FK — для гарантированной записи независимо от удаления связанных сущностей.</p><script lang=js>const innerPages=document.getElementById("inner-pages");innerPages&&innerPages.querySelectorAll("li").forEach(e=>{e.addEventListener("click",()=>{const t=e.innerText.trim();if(openedMenu){if(openedMenu.includes(t)){const e=openedMenu.findIndex(e=>e===t);openedMenu.splice(e,1)}else openedMenu.push(t);localStorage.setItem("openedMenu",JSON.stringify(openedMenu))}else localStorage.setItem("openedMenu","["+t+"]")})})</script><nav class=pagination><a class="nav nav-prev" href=https://example.org/03_backend/01_info_models/ title="Модель данных и базы данных"><i class="fa fa-arrow-left" aria-hidden=true></i> Предыдущее - Модель данных и базы данных</a>
<a class="nav nav-next" href=https://example.org/03_backend/01_info_models/documents/ title="Документные коллекции">Следующее - Документные коллекции <i class="fa fa-arrow-right" aria-hidden=true></i></a></nav></div><div class="column is-sticky is-paddingless" id=tocWrapper><div class=is-paddingless id=tocContainer><div id=tocContent><div class=additionalinfo><span id=method_name>Реляционные таблицы (PostgreSQL)</span>
<strong>Описание:</strong> Детальное описание схемы PostgreSQL 16: таблицы, индексы, ограничения, триггеры.</div><div class=toc-header><h6 class="toc-title is-marginless">Содержание:On this page:</h6><i title="Back to top" id=tocBackToTop class="fa-solid fa-circle-arrow-up"></i></div><div id=toc><nav id=TableOfContents><ul><li><a href=#enum-типы-глобальные>Enum-типы (глобальные)</a></li><li><a href=#таблица-users>Таблица: <code>users</code></a><ul><li><a href=#поля>Поля</a></li><li><a href=#индексы>Индексы</a></li><li><a href=#ограничения>Ограничения</a></li><li><a href=#триггеры>Триггеры</a></li><li><a href=#типичные-запросы>Типичные запросы</a></li><li><a href=#связи>Связи</a></li></ul></li><li><a href=#таблица-organizations>Таблица: <code>organizations</code></a><ul><li><a href=#поля-1>Поля</a></li><li><a href=#индексы-1>Индексы</a></li><li><a href=#ограничения-1>Ограничения</a></li><li><a href=#триггеры-1>Триггеры</a></li><li><a href=#типичные-запросы-1>Типичные запросы</a></li><li><a href=#связи-1>Связи</a></li></ul></li><li><a href=#таблица-organization_members>Таблица: <code>organization_members</code></a><ul><li><a href=#поля-2>Поля</a></li><li><a href=#индексы-2>Индексы</a></li><li><a href=#ограничения-2>Ограничения</a></li><li><a href=#enum-типы>Enum-типы</a></li><li><a href=#типичные-запросы-2>Типичные запросы</a></li><li><a href=#связи-2>Связи</a></li></ul></li><li><a href=#таблица-oauth_connections>Таблица: <code>oauth_connections</code></a><ul><li><a href=#поля-3>Поля</a></li><li><a href=#индексы-3>Индексы</a></li><li><a href=#ограничения-3>Ограничения</a></li><li><a href=#триггеры-2>Триггеры</a></li><li><a href=#типичные-запросы-3>Типичные запросы</a></li><li><a href=#связи-3>Связи</a></li></ul></li><li><a href=#таблица-api_keys>Таблица: <code>api_keys</code></a><ul><li><a href=#поля-4>Поля</a></li><li><a href=#индексы-4>Индексы</a></li><li><a href=#ограничения-4>Ограничения</a></li><li><a href=#типичные-запросы-4>Типичные запросы</a></li><li><a href=#связи-4>Связи</a></li></ul></li><li><a href=#таблица-plans>Таблица: <code>plans</code></a><ul><li><a href=#поля-5>Поля</a></li><li><a href=#индексы-5>Индексы</a></li><li><a href=#типичные-запросы-5>Типичные запросы</a></li><li><a href=#связи-5>Связи</a></li></ul></li><li><a href=#таблица-subscriptions>Таблица: <code>subscriptions</code></a><ul><li><a href=#поля-6>Поля</a></li><li><a href=#индексы-6>Индексы</a></li><li><a href=#ограничения-5>Ограничения</a></li><li><a href=#enum-типы-1>Enum-типы</a></li><li><a href=#триггеры-3>Триггеры</a></li><li><a href=#типичные-запросы-6>Типичные запросы</a></li><li><a href=#связи-6>Связи</a></li></ul></li><li><a href=#таблица-usage_records>Таблица: <code>usage_records</code></a><ul><li><a href=#поля-7>Поля</a></li><li><a href=#индексы-7>Индексы</a></li><li><a href=#ограничения-6>Ограничения</a></li><li><a href=#типичные-запросы-7>Типичные запросы</a></li><li><a href=#связи-7>Связи</a></li></ul></li><li><a href=#таблица-brand_kits>Таблица: <code>brand_kits</code></a><ul><li><a href=#поля-8>Поля</a></li><li><a href=#индексы-8>Индексы</a></li><li><a href=#ограничения-7>Ограничения</a></li><li><a href=#триггеры-4>Триггеры</a></li><li><a href=#типичные-запросы-8>Типичные запросы</a></li><li><a href=#связи-8>Связи</a></li></ul></li><li><a href=#таблица-projects>Таблица: <code>projects</code></a><ul><li><a href=#поля-9>Поля</a></li><li><a href=#индексы-9>Индексы</a></li><li><a href=#ограничения-8>Ограничения</a></li><li><a href=#типичные-запросы-9>Типичные запросы</a></li><li><a href=#связи-9>Связи</a></li></ul></li><li><a href=#таблица-presentations>Таблица: <code>presentations</code></a><ul><li><a href=#поля-10>Поля</a></li><li><a href=#индексы-10>Индексы</a></li><li><a href=#ограничения-9>Ограничения</a></li><li><a href=#enum-типы-2>Enum-типы</a></li><li><a href=#триггеры-5>Триггеры</a></li><li><a href=#типичные-запросы-10>Типичные запросы</a></li><li><a href=#связи-10>Связи</a></li></ul></li><li><a href=#таблица-slides>Таблица: <code>slides</code></a><ul><li><a href=#поля-11>Поля</a></li><li><a href=#индексы-11>Индексы</a></li><li><a href=#ограничения-10>Ограничения</a></li><li><a href=#enum-типы-3>Enum-типы</a></li><li><a href=#триггеры-6>Триггеры</a></li><li><a href=#типичные-запросы-11>Типичные запросы</a></li><li><a href=#связи-11>Связи</a></li></ul></li><li><a href=#таблица-slide_versions>Таблица: <code>slide_versions</code></a><ul><li><a href=#поля-12>Поля</a></li><li><a href=#индексы-12>Индексы</a></li><li><a href=#ограничения-11>Ограничения</a></li><li><a href=#типичные-запросы-12>Типичные запросы</a></li><li><a href=#связи-12>Связи</a></li></ul></li><li><a href=#таблица-presentation_shares>Таблица: <code>presentation_shares</code></a><ul><li><a href=#поля-13>Поля</a></li><li><a href=#индексы-13>Индексы</a></li><li><a href=#ограничения-12>Ограничения</a></li><li><a href=#enum-типы-4>Enum-типы</a></li><li><a href=#типичные-запросы-13>Типичные запросы</a></li><li><a href=#связи-13>Связи</a></li></ul></li><li><a href=#таблица-source_documents>Таблица: <code>source_documents</code></a><ul><li><a href=#поля-14>Поля</a></li><li><a href=#индексы-14>Индексы</a></li><li><a href=#ограничения-13>Ограничения</a></li><li><a href=#enum-типы-5>Enum-типы</a></li><li><a href=#типичные-запросы-14>Типичные запросы</a></li><li><a href=#связи-14>Связи</a></li></ul></li><li><a href=#таблица-presentation_sources>Таблица: <code>presentation_sources</code></a><ul><li><a href=#поля-15>Поля</a></li><li><a href=#индексы-15>Индексы</a></li><li><a href=#ограничения-14>Ограничения</a></li><li><a href=#связи-15>Связи</a></li></ul></li><li><a href=#таблица-document_ingestion_jobs>Таблица: <code>document_ingestion_jobs</code></a><ul><li><a href=#поля-16>Поля</a></li><li><a href=#индексы-16>Индексы</a></li><li><a href=#ограничения-15>Ограничения</a></li><li><a href=#enum-типы-6>Enum-типы</a></li><li><a href=#связи-16>Связи</a></li></ul></li><li><a href=#таблица-generation_jobs>Таблица: <code>generation_jobs</code></a><ul><li><a href=#поля-17>Поля</a></li><li><a href=#индексы-17>Индексы</a></li><li><a href=#ограничения-16>Ограничения</a></li><li><a href=#enum-типы-7>Enum-типы</a></li><li><a href=#триггеры-7>Триггеры</a></li><li><a href=#типичные-запросы-15>Типичные запросы</a></li><li><a href=#связи-17>Связи</a></li></ul></li><li><a href=#таблица-export_jobs>Таблица: <code>export_jobs</code></a><ul><li><a href=#поля-18>Поля</a></li><li><a href=#индексы-18>Индексы</a></li><li><a href=#ограничения-17>Ограничения</a></li><li><a href=#enum-типы-8>Enum-типы</a></li><li><a href=#связи-18>Связи</a></li></ul></li><li><a href=#таблица-webhook_subscriptions>Таблица: <code>webhook_subscriptions</code></a><ul><li><a href=#поля-19>Поля</a></li><li><a href=#индексы-19>Индексы</a></li><li><a href=#ограничения-18>Ограничения</a></li><li><a href=#типичные-запросы-16>Типичные запросы</a></li><li><a href=#связи-19>Связи</a></li></ul></li><li><a href=#таблица-webhook_events>Таблица: <code>webhook_events</code></a><ul><li><a href=#поля-20>Поля</a></li><li><a href=#индексы-20>Индексы</a></li><li><a href=#ограничения-19>Ограничения</a></li><li><a href=#enum-типы-9>Enum-типы</a></li><li><a href=#триггеры-8>Триггеры</a></li><li><a href=#типичные-запросы-17>Типичные запросы</a></li><li><a href=#связи-20>Связи</a></li></ul></li><li><a href=#таблица-audit_logs>Таблица: <code>audit_logs</code></a><ul><li><a href=#поля-21>Поля</a></li><li><a href=#партиционирование>Партиционирование</a></li><li><a href=#индексы-21>Индексы</a></li><li><a href=#типичные-запросы-18>Типичные запросы</a></li><li><a href=#связи-21>Связи</a></li></ul></li></ul></nav></div><ul class=info style="line-height:1.2;list-style-type:none;border:1px solid;border-radius:1px;padding:5px;margin:16px 10px 0;color:#000"></ul><div id=taxonomies><div class=taxonomy-wrapper></div><div class=taxonomy-wrapper></div></div><div class=toc-header><div class=edit-meta></div></div></div></div><div class=is-paddingless id=tocCollapsible title="Collapse/Uncollapse table of contents"><i class="fa-solid fa-angles-right fa-lg"></i></div></div></div></div><script type=text/javascript>const baseUrl="https://example.org/",codeCopyBefore="Copy to clipboard",codeCopyAfter="Copied to clipboard",svgDownloadLabel="Download as SVG",helperLoadingLabel="Loading",searchNoResults="No result found",introNextLabel="Next",introPrevLabel="Previous",introSkipLabel="✗",introDoneLabel="Done",printLabel="Print current page",qrCodeLabel="Show current page QR code",naCommonLabel="Not available"</script><script type=module src=/js/theme/modules/const.min.js></script><script type=module src=/js/theme/modules/helpers.min.js></script><script type=module src=/js/theme/modules/helpersGlobal.min.js></script><script type=module src=/js/theme/init.min.js></script><script type=module src=/js/theme/navbar.min.js></script><script type=module src=/js/theme/print.min.js></script><script type=module src=/js/theme/qrcode.min.js></script><script type=module src=/js/theme/search.min.js></script><script type=module src=/js/theme/shortcuts.min.js></script><script type=module src=/js/theme/sidebar.min.js></script><script type=module src=/js/theme/toc.min.js></script><script type=text/javascript src=/js/external/jquery/jquery-3.6.3.min.js></script><script type=text/javascript src=/js/external/tippy/popper.min.js></script><script type=text/javascript src=/js/external/tippy/tippy-bundle.umd.min.js></script><script type=text/javascript src=/js/external/markmap/markmap-autoloader.min.js></script><script type=text/javascript src=/js/theme/browserCompatibility.min.js></script><script type=text/javascript src=/js/external/flexsearch/flexsearch.bundle.min.js></script><script type=text/javascript src=/js/external/qrious/qrious.min.js></script><script type=text/javascript src=/js/external/overlay-scrollbars/overlayscrollbars.min.js></script><script type=text/javascript src=/js/external/markmap/markmap.min.js></script><script type=text/javascript src=/js/external/readfile/rawdeflate.min.js></script><script type=text/javascript src=/js/external/1ce05b4b.min.js></script><script type=text/javascript src=/js/external/techradar/d3.v4.min.js></script><script type=text/javascript src=/js/external/techradar/radar.min.js></script><script type=text/javascript src=/js/external/bpmn-visualization/bpmn-visualization.min.js></script><script type=text/javascript src=/js/external/sorttable/sorttable.min.js></script><script type=text/javascript src=/js/external/mermaid/svg-pan-zoom.min.js></script><script type=text/javascript src=/js/external/simplesearch/simplesearch.min.js></script><script>$("table").addClass("sortable")</script></body></html>