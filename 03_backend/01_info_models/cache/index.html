<!doctype html><html><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.124.1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Схемы Redis-ключей: сессии, семантический кэш LLM, checkpoint генерации, rate limiting."><title>Кэш и очереди (Redis)</title>
<link rel=icon href="/images/favicon.png?v=1772351355" type=image/x-icon><link rel=stylesheet rel=preload type=text/css href=/css/main.css><link rel=stylesheet type=text/css href=/css/external/all.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-thin.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-solid.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-regular.min.css><link rel=stylesheet type=text/css href=/css/external/sharp-light.min.css><link rel=stylesheet type=text/css href=/css/external/sorttable/sorttable.min.css><link rel=stylesheet type=text/css href=/css/external/tippy/light-border.min.css><link rel=stylesheet type=text/css href=/css/external/techradar/radar.min.css><link rel=stylesheet type=text/css href=/css/external/form-js/form-js.min.css><link rel=stylesheet type=text/css href=/css/external/overlay-scrollbars/overlayscrollbars.min.css><link rel=stylesheet type=text/css href=/css/external/simplesearch/simplesearch.min.css></head><body onload=browserCompatibility()><div id=navbarInfo class="is-hidden modal-container"><div class="modal-content-box modal-text-box"><div class="card modal-title is-radiusless"><div class=card-header><p class="card-header-title is-marginless">About</p></div></div><div class=modal-content-container><div class="modal-content-block is-block"></div></div></div></div><div id=navbarShortcuts class="is-hidden modal-container"><div class="modal-content-box modal-text-box"><div class="card modal-title is-radiusless"><div class=card-header><p class="card-header-title is-marginless">Keyboard shortcuts</p></div></div><div class=modal-content-container><div class=modal-content-block><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>q</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show current page QR code</p></div><div class=modal-content><kbd>Escape</kbd></div><div class=modal-content><p class=has-text-weight-normal>Close modals</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>i</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show website information</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>k</kbd></div><div class=modal-content><p class=has-text-weight-normal>Show shortcuts</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>h</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to homepage</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>f</kbd></div><div class=modal-content><p class=has-text-weight-normal>Find on website</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>m</kbd></div><div class=modal-content><p class=has-text-weight-normal>Collapse/Uncollapse sidebar</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>t</kbd></div><div class=modal-content><p class=has-text-weight-normal>Collapse/Uncollapse table of contents</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>↑</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to the top of the page</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>↓</kbd></div><div class=modal-content><p class=has-text-weight-normal>Go to the bottom of the page</p></div><div class=modal-content><kbd>Shift</kbd><p>+</p><kbd>p</kbd></div><div class=modal-content><p class=has-text-weight-normal>Print current page</p></div></div></div></div></div><div id=modalContainer class="is-hidden modal-container"><div id=modal class=modal-content-box></div></div><nav id=navbar class=navbar role=navigation aria-label="main navigation"><div id=navbarItemsContainer class=navbar-brand><div id=globalLogoContainer class=is-flex><a id=globalLogo class="navbar-item navbar-item-standard is-paddingless" href=/><img id=globalLogoImg alt=Homepage src="/images/logo.png?v=1772351355"><div class=logo-header-container><span>Сервис генерации презентаций</span></div></a><a id=globalTouchLogo class="navbar-item navbar-item-standard is-paddingless" href=/><img alt=Homepage src="/images/logoTouch.png?v=1772351355"></a></div><div id=navbarItems class=is-flex><div id=navbarItemsStart class=is-flex></div><div id=navbarItemsEnd class=is-flex><div class=navbar-item><a id=listDocuments class="button navbar-item-standard" href=/listdocuments/><span class=icon><i class="fa-solid fa-list"></i>
</span><span class=icon-text>&nbsp;Список документов</span></a></div><div class=navbar-item><a id=searchButton class="button navbar-item-standard" href=/search/><span class=icon><i class="fa-solid fa-magnifying-glass"></i>
</span><span class=icon-text>&nbsp;Поиск</span></a></div><div class=navbar-item><a id=printButton class="button navbar-item-standard"><span class=icon-text>Print</span>
<span class=icon><i class="fa-solid fa-print fa-lg"></i></span></a></div></div></div></div></nav><div id=navbarOverlay></div><div class="columns is-mobile is-paddingless is-marginless" id=mainContainer><div id=sidebarContainer class="column is-narrow is-paddingless is-marginless"><div id=sidebarWrapper class=is-fixed><div id=sidebar class=is-marginless><aside class="menu is-paddingless is-marginless"><ul class="menu-list is-marginless is-paddingless"><div class="card is-fs-expandable-icon"><div class=card-header><a href=/00_overview/ class=card-header-title><i class='fa-solid fa-circle-info fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/00_overview/ class=card-header-title title='Описание и артефакты анализа'><i class='fa-solid fa-circle-info fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Описание и артефакты анализа</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/00_overview/01_br/ class=card-header-title title=Требования><i class='fa-solid fa-folder-open'></i><p class="pt-0 pb-0 pr-2 pl-1">Требования</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/01_br/ class=card-header-title title='Бизнес-контекст и БТ'><i class='fa-solid fa-circle-info'></i><p class="pt-0 pb-0 pr-2 pl-1">Бизнес-контекст и БТ</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/02_actors/ class=card-header-title title='Акторы и границы системы'><i class='fa-solid fa-users'></i><p class="pt-0 pb-0 pr-2 pl-1">Акторы и границы системы</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/03_fr_documents/ class=card-header-title title='FR_01: Загрузка и индексация документов'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_01: Загрузка и индексация документов</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/04_fr_rag/ class=card-header-title title='FR_02: RAG-поиск и генерация презентаций'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_02: RAG-поиск и генерация презентаций</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/05_fr_users/ class=card-header-title title='FR_03: Управление пользователями'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_03: Управление пользователями</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/06_fr_admin/ class=card-header-title title='FR_04: Администрирование'><i class='fa-solid fa-list-check'></i><p class="pt-0 pb-0 pr-2 pl-1">FR_04: Администрирование</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/01_br/07_nonfunctional/ class=card-header-title title='Нефункциональные требования'><i class='fa-solid fa-gauge-high'></i><p class="pt-0 pb-0 pr-2 pl-1">Нефункциональные требования</p></a></div></div></li></div></div></ul></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/02_constraints/ class=card-header-title title='Ограничения и допущения'><i class='fa-solid fa-lock'></i><p class="pt-0 pb-0 pr-2 pl-1">Ограничения и допущения</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/03_interfaces/ class=card-header-title title=Интерфейсы><i class='fa-solid fa-plug'></i><p class="pt-0 pb-0 pr-2 pl-1">Интерфейсы</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/00_overview/04_quality_metrics/ class=card-header-title title='Метрики качества и итоговая сводка'><i class='fa-solid fa-chart-bar'></i><p class="pt-0 pb-0 pr-2 pl-1">Метрики качества и итоговая сводка</p></a></div></div></li></div></div></ul></li></div></div><div class="card is-fs-expandable-icon"><div class="card-header is-single-link"><a href=/01_architecture/ class=card-header-title><i class='fa-solid fa-diagram-project fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/01_architecture/ class=card-header-title title=Архитектура><i class='fa-solid fa-diagram-project fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Архитектура</p></a></div></div></li></div></div><div class="card is-fs-expandable-icon is-sidebar-active"><div class=card-header><a href=/03_backend/ class=card-header-title><i class='fa-solid fa-server fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class="is-marginless is-tree-active is-entries-expandable is-entries-expanded"><div class=card><div class=card-header><a href=/03_backend/ class=card-header-title title=Backend><i class='fa-solid fa-server fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Backend</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-expanded"><span class=icon></span></a></div></div><ul class="is-marginless is-tree-active"><div><div><li class="is-marginless is-entries-expandable is-entries-expanded"><div class=card><div class=card-header><a href=/03_backend/01_info_models/ class=card-header-title title='Модель данных и базы данных'><i class='fa-solid fa-database'></i><p class="pt-0 pb-0 pr-2 pl-1">Модель данных и базы данных</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-expanded"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/relational/ class=card-header-title title='Реляционные таблицы (PostgreSQL)'><i class='fa-solid fa-table'></i><p class="pt-0 pb-0 pr-2 pl-1">Реляционные таблицы (PostgreSQL)</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/documents/ class=card-header-title title='Документные коллекции'><i class='fa-solid fa-file-code'></i><p class="pt-0 pb-0 pr-2 pl-1">Документные коллекции</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/01_info_models/vector_store/ class=card-header-title title='Векторное хранилище (Qdrant)'><i class='fa-solid fa-magnifying-glass-chart'></i><p class="pt-0 pb-0 pr-2 pl-1">Векторное хранилище (Qdrant)</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class="card is-sidebar-active" id=sidebarActiveEntry><div class="card-header is-single-link"><a href=/03_backend/01_info_models/cache/ class=card-header-title title='Кэш и очереди (Redis)'><i class='fa-solid fa-bolt'></i><p class="pt-0 pb-0 pr-2 pl-1">Кэш и очереди (Redis)</p></a></div></div></li></div></div></ul></li></div></div><div><div><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/03_backend/02_rest_methods/ class=card-header-title title='REST API'><i class='fa-solid fa-route'></i><p class="pt-0 pb-0 pr-2 pl-1">REST API</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/createproject/ class=card-header-title title='POST /projects'><i class='fa-solid fa-folder-plus'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /projects</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/createpresentation/ class=card-header-title title='POST /presentations'><i class='fa-solid fa-file-powerpoint'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /presentations</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/generateoutline/ class=card-header-title title='POST /presentations/{id}/generate/outline'><i class='fa-solid fa-list-ol'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /presentations/{id}/generate/outline</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/generateslides/ class=card-header-title title='POST /presentations/{id}/generate/slides'><i class='fa-solid fa-wand-magic-sparkles'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /presentations/{id}/generate/slides</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/03_backend/02_rest_methods/regenerateslide/ class=card-header-title title='POST /presentations/{id}/generate/slide/{slide_id}'><i class='fa-solid fa-rotate-right'></i><p class="pt-0 pb-0 pr-2 pl-1">POST /presentations/{id}/generate/slide/{slide_id}</p></a></div></div></li></div></div></ul></li></div></div></ul></li></div></div><div class="card is-fs-expandable-icon"><div class=card-header><a href=/02_frontend/ class=card-header-title><i class='fa-solid fa-display fa-lg'></i></a></div></div><div class=is-expandable><div class=is-sidebar-list-wrapper><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/02_frontend/ class=card-header-title title=Frontend><i class='fa-solid fa-display fa-lg'></i><p class="pt-0 pb-0 pr-2 pl-1">Frontend</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class="is-marginless is-entries-expandable is-entries-shrinked"><div class=card><div class=card-header><a href=/02_frontend/screens/ class=card-header-title title=Экраны><i class='fa-solid fa-window-restore'></i><p class="pt-0 pb-0 pr-2 pl-1">Экраны</p></a><a class="card-header-icon is-icon-expandable is-paddingless is-icon-shrinked"><span class=icon></span></a></div></div><ul class=is-marginless><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/screens/landing/ class=card-header-title title=Лендинг><i class='fa-solid fa-house'></i><p class="pt-0 pb-0 pr-2 pl-1">Лендинг</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/screens/wizard_step1/ class=card-header-title title='Wizard — Шаг 1: Данные и контент'><i class='fa-solid fa-upload'></i><p class="pt-0 pb-0 pr-2 pl-1">Wizard — Шаг 1: Данные и контент</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/screens/wizard_step2/ class=card-header-title title='Wizard — Шаг 2: Аудитория и цель'><i class='fa-solid fa-bullseye'></i><p class="pt-0 pb-0 pr-2 pl-1">Wizard — Шаг 2: Аудитория и цель</p></a></div></div></li></div></div></ul></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/components/ class=card-header-title title='Реестр компонентов'><i class='fa-solid fa-cubes'></i><p class="pt-0 pb-0 pr-2 pl-1">Реестр компонентов</p></a></div></div></li></div></div><div><div><li class=is-marginless><div class=card><div class="card-header is-single-link"><a href=/02_frontend/user_flows/ class=card-header-title title='Пользовательские сценарии'><i class='fa-solid fa-route'></i><p class="pt-0 pb-0 pr-2 pl-1">Пользовательские сценарии</p></a></div></div></li></div></div></ul></li></div></div></ul></aside></div><div id=sidebarCollapsible class=is-marginless><div class="card is-uncollapse-action"><div id=sidebarUncollapse class="card-header is-single-link" title="Collapse/Uncollapse sidebar"><a class=card-header-title><i class="fa-solid fa-angles-right fa-lg"></i></a></div></div><div class="card is-collapse-action"><div id=sidebarCollapse class="card-header is-single-link" title="Collapse/Uncollapse sidebar"><a class=card-header-title><i class="fa-solid fa-angles-left fa-lg"></i><p>Collapse sidebar</p></a></div></div></div></div></div><div id=sidebarMobileWrapper class="column is-narrow is-hidden-desktop"></div><div class="columns is-mobile is-marginless is-scroll-smooth has-toc is-toc-collapsed" id=contentContainer><div class=column id=content data-pagefind-body><style>ul.breadcrumb{padding:10px 15px;list-style:none;background-color:#eee}ul.breadcrumb li{display:inline;font-size:14px}ul.breadcrumb li+li:before{padding:8px;color:#000;content:"/\00a0"}ul.breadcrumb li a{color:#0275d8;text-decoration:none}ul.breadcrumb li a:hover{color:#01447e;text-decoration:underline}</style><ul id=breadcrumbs class=breadcrumb><li><a href=/>Промпт-инжиниринг</a></li><li><a href=/03_backend/>Backend</a></li><li><a href=/03_backend/01_info_models/>Модель данных и базы данных</a></li><li><a href=/03_backend/01_info_models/cache/>Кэш и очереди (Redis)</a></li></ul><div id=contentTitle>Кэш и очереди (Redis)</div><h1 id=redis-7--кэш-и-очереди>Redis 7 — Кэш и очереди<a href=#redis-7--%d0%ba%d1%8d%d1%88-%d0%b8-%d0%be%d1%87%d0%b5%d1%80%d0%b5%d0%b4%d0%b8 class=anchor>#</a></h1><blockquote><p><strong>Конфигурация:</strong> Redis 7 Cluster Mode (3 master + 3 replica)
<strong>Политика вытеснения:</strong> <code>allkeys-lru</code> для кэш-узлов, <code>noeviction</code> для очередей
<strong>Persistence:</strong> AOF (appendonly yes, fsync=everysec) + RDB snapshot каждые 15 мин</p></blockquote><hr><h2 id=ключ-sessionsession_id>Ключ: <code>session:{session_id}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-sessionsession_id class=anchor>#</a></h2><p><strong>Тип Redis:</strong> HASH</p><p><strong>Схема значения:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CachedSession</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>user_id</span>: <span style=color:#66d9ef>string</span>;          <span style=color:#75715e>// UUID пользователя
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>organization_id</span>: <span style=color:#66d9ef>string</span>;  <span style=color:#75715e>// UUID активной организации
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>role</span>: <span style=color:#66d9ef>string</span>;             <span style=color:#75715e>// Роль в организации: admin | editor | viewer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>string</span>;            <span style=color:#75715e>// Email для быстрой идентификации
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>plan</span>: <span style=color:#66d9ef>string</span>;             <span style=color:#75715e>// Тарифный план: free | pro | team | enterprise
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>created_at</span>: <span style=color:#66d9ef>string</span>;       <span style=color:#75715e>// ISO 8601 timestamp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>last_active</span>: <span style=color:#66d9ef>string</span>;      <span style=color:#75715e>// Последняя активность (обновляется при каждом запросе)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>ip</span>: <span style=color:#66d9ef>string</span>;               <span style=color:#75715e>// IP при создании сессии
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><strong>Пример:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;user_id&#34;</span>: <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345678&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;organization_id&#34;</span>: <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345680&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;editor&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;anna@company.ru&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;plan&#34;</span>: <span style=color:#e6db74>&#34;team&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;created_at&#34;</span>: <span style=color:#e6db74>&#34;2026-03-01T10:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;last_active&#34;</span>: <span style=color:#e6db74>&#34;2026-03-01T14:32:00Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;ip&#34;</span>: <span style=color:#e6db74>&#34;95.24.128.55&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>TTL:</strong> 86400 секунд (24 часа) — сдвигается при каждом запросе (<code>EXPIRE session:{id} 86400</code>)</p><p><strong>Инвалидация:</strong> При явном logout — <code>DEL session:{session_id}</code>. При принудительном завершении всех сессий пользователя — Lua-скрипт <code>SCAN + DEL</code> по паттерну с фильтрацией по <code>user_id</code>.</p><p><strong>Причина кэширования:</strong> Исключает запрос к PostgreSQL при каждом HTTP-запросе для проверки аутентификации и RBAC. Снижает нагрузку на БД в 50–100×.</p><p><strong>Риски:</strong> При изменении роли пользователя — stale данные в кэше до истечения TTL (24 ч). <strong>Митигация:</strong> при изменении роли через Admin API — явно удаляем <code>session:*</code> пользователя с помощью вспомогательной структуры <code>user_sessions:{user_id}</code> (SET со списком session_id).</p><hr><h2 id=ключ-user_sessionsuser_id>Ключ: <code>user_sessions:{user_id}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-user_sessionsuser_id class=anchor>#</a></h2><p><strong>Тип Redis:</strong> SET</p><p><strong>Схема значения:</strong> <code>{session_id}</code> — множество активных session_id пользователя</p><p><strong>Пример:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[<span style=color:#e6db74>&#34;sess_abc123&#34;</span>, <span style=color:#e6db74>&#34;sess_def456&#34;</span>, <span style=color:#e6db74>&#34;sess_xyz789&#34;</span>]
</span></span></code></pre></div><p><strong>TTL:</strong> 86400 секунд</p><p><strong>Инвалидация:</strong> Используется для принудительного завершения всех сессий пользователя при смене роли или блокировке:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>revoke_all_user_sessions</span>(user_id: str) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>    session_ids <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> redis<span style=color:#f92672>.</span>smembers(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;user_sessions:</span><span style=color:#e6db74>{</span>user_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> session_ids:
</span></span><span style=display:flex><span>        pipeline <span style=color:#f92672>=</span> redis<span style=color:#f92672>.</span>pipeline()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> sid <span style=color:#f92672>in</span> session_ids:
</span></span><span style=display:flex><span>            pipeline<span style=color:#f92672>.</span>delete(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;session:</span><span style=color:#e6db74>{</span>sid<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        pipeline<span style=color:#f92672>.</span>delete(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;user_sessions:</span><span style=color:#e6db74>{</span>user_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> pipeline<span style=color:#f92672>.</span>execute()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> len(session_ids)
</span></span></code></pre></div><p><strong>Причина кэширования:</strong> Быстрый поиск всех сессий пользователя без сканирования Redis.</p><p><strong>Риски:</strong> Небольшой race condition — сессия может быть создана после SMEMBERS и до DELETE. <strong>Митигация:</strong> После revoke — пользователь всё равно получит 401 при следующем запросе, так как <code>session:{id}</code> уже удалён.</p><hr><h2 id=ключ-gen_checkpointjob_id>Ключ: <code>gen_checkpoint:{job_id}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-gen_checkpointjob_id class=anchor>#</a></h2><p><strong>Тип Redis:</strong> HASH</p><p><strong>Схема значения:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>GenerationCheckpoint</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>job_id</span>: <span style=color:#66d9ef>string</span>;               <span style=color:#75715e>// UUID задачи генерации
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>presentation_id</span>: <span style=color:#66d9ef>string</span>;      <span style=color:#75715e>// UUID презентации
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>string</span>;               <span style=color:#75715e>// running | completed | failed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>outline</span>: <span style=color:#66d9ef>string</span>;              <span style=color:#75715e>// JSON-строка outline презентации
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>slides_completed</span>: <span style=color:#66d9ef>string</span>;     <span style=color:#75715e>// Число завершённых слайдов (строка из-за HASH)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>slides_total</span>: <span style=color:#66d9ef>string</span>;         <span style=color:#75715e>// Всего слайдов
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>completed_slide_ids</span>: <span style=color:#66d9ef>string</span>;  <span style=color:#75715e>// JSON-массив UUID завершённых слайдов
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>last_updated</span>: <span style=color:#66d9ef>string</span>;         <span style=color:#75715e>// ISO 8601 timestamp последнего обновления
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>worker_id</span>: <span style=color:#66d9ef>string</span>;            <span style=color:#75715e>// ID Celery worker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>langgraph_state</span>: <span style=color:#66d9ef>string</span>;      <span style=color:#75715e>// JSON-дамп состояния LangGraph (для recovery)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><strong>Пример:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;job_id&#34;</span>: <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345678&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;presentation_id&#34;</span>: <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345679&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;running&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;outline&#34;</span>: <span style=color:#e6db74>&#34;[{\&#34;slide_number\&#34;:1,\&#34;title\&#34;:\&#34;Рынок\&#34;}...]&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;slides_completed&#34;</span>: <span style=color:#e6db74>&#34;7&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;slides_total&#34;</span>: <span style=color:#e6db74>&#34;15&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;completed_slide_ids&#34;</span>: <span style=color:#e6db74>&#34;[\&#34;uuid1\&#34;,\&#34;uuid2\&#34;...]&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;last_updated&#34;</span>: <span style=color:#e6db74>&#34;2026-03-01T10:15:42Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;worker_id&#34;</span>: <span style=color:#e6db74>&#34;celery@worker-3.pod&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;langgraph_state&#34;</span>: <span style=color:#e6db74>&#34;{\&#34;current_node\&#34;:\&#34;slide_gen_node\&#34;,\&#34;slide_index\&#34;:7...}&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>TTL:</strong> 3600 секунд (1 час) — достаточно для любой генерации; обновляется при каждом checkpoint</p><p><strong>Инвалидация:</strong> При успешном завершении генерации — <code>DEL gen_checkpoint:{job_id}</code> после записи в PostgreSQL. При провале (max retries) — <code>HSET status=failed</code>, TTL не сбрасывается.</p><p><strong>Причина кэширования:</strong> <strong>Checkpoint-based recovery</strong> — если worker умирает после генерации 7 из 15 слайдов, новый worker читает checkpoint и продолжает с 8-го слайда. Без этого — потеря всей генерации и повторные LLM-затраты.</p><p><strong>Риски:</strong> При падении Redis с потерей данных — генерация начнётся сначала. <strong>Митигация:</strong> AOF persistence с fsync=everysec; RPO = 1 секунда. Параллельно ключевые поля (slides_completed) обновляются в PostgreSQL.</p><hr><h2 id=ключ-gen_progressjob_id>Ключ: <code>gen_progress:{job_id}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-gen_progressjob_id class=anchor>#</a></h2><p><strong>Тип Redis:</strong> STREAM</p><p><strong>Схема записи:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>GenerationProgressEvent</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>event_type</span>: <span style=color:#66d9ef>string</span>;      <span style=color:#75715e>// &#39;slide_started&#39; | &#39;slide_completed&#39; | &#39;generation_done&#39; | &#39;error&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>slide_number?</span>: <span style=color:#66d9ef>string</span>;   <span style=color:#75715e>// Номер слайда
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>slide_id?</span>: <span style=color:#66d9ef>string</span>;       <span style=color:#75715e>// UUID слайда
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>slide_title?</span>: <span style=color:#66d9ef>string</span>;    <span style=color:#75715e>// Заголовок слайда
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>progress_pct</span>: <span style=color:#66d9ef>string</span>;    <span style=color:#75715e>// 0–100, процент выполнения
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>string</span>;       <span style=color:#75715e>// Unix timestamp (ms)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>error_message?</span>: <span style=color:#66d9ef>string</span>;  <span style=color:#75715e>// Только для event_type=error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><strong>Пример записи в stream:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>await</span> redis<span style=color:#f92672>.</span>xadd(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;gen_progress:</span><span style=color:#e6db74>{</span>job_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;event_type&#34;</span>: <span style=color:#e6db74>&#34;slide_completed&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;slide_number&#34;</span>: <span style=color:#e6db74>&#34;7&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;slide_id&#34;</span>: <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345681&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;slide_title&#34;</span>: <span style=color:#e6db74>&#34;Рыночная возможность&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;progress_pct&#34;</span>: <span style=color:#e6db74>&#34;46&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;timestamp&#34;</span>: <span style=color:#e6db74>&#34;1740829200000&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    maxlen<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>,    <span style=color:#75715e># Хранить не более 200 событий</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p><strong>TTL:</strong> 7200 секунд (2 часа) — достаточно для завершения генерации + буфер для клиента</p><p><strong>Инвалидация:</strong> <code>DEL gen_progress:{job_id}</code> через 2 часа после <code>generation_done</code>-события (или через TTL).</p><p><strong>Причина кэширования:</strong> WebSocket-стриминг прогресса на клиент. API Service читает stream с последней позиции (<code>XREAD BLOCK 30000 STREAMS gen_progress:{job_id} $</code>) и пушит события в WebSocket без опроса PostgreSQL.</p><p><strong>Риски:</strong> При переподключении клиента — может пропустить события. <strong>Митигация:</strong> Клиент передаёт <code>last_event_id</code>; сервер делает <code>XREAD STREAMS gen_progress:{job_id} {last_event_id}</code>.</p><hr><h2 id=ключ-semantic_cachehash>Ключ: <code>semantic_cache:{hash}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-semantic_cachehash class=anchor>#</a></h2><p><strong>Тип Redis:</strong> STRING (JSON)</p><p><strong>Схема значения:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SemanticCacheEntry</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>query_embedding_hash</span>: <span style=color:#66d9ef>string</span>;   <span style=color:#75715e>// SHA-256 от rounded embedding (для ключа)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>original_query</span>: <span style=color:#66d9ef>string</span>;         <span style=color:#75715e>// Исходный запрос
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>response</span>: <span style=color:#66d9ef>string</span>;               <span style=color:#75715e>// Ответ LLM (JSON-строка)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>tokens_saved</span>: <span style=color:#66d9ef>number</span>;           <span style=color:#75715e>// Токены, сэкономленные при хите
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>llm_provider</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>created_at</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hit_count</span>: <span style=color:#66d9ef>number</span>;              <span style=color:#75715e>// Количество хитов кэша
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><strong>Пример:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;query_embedding_hash&#34;</span>: <span style=color:#e6db74>&#34;a1b2c3d4e5f6...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;original_query&#34;</span>: <span style=color:#e6db74>&#34;Создай outline для питч-дека стартапа в B2B SaaS, аудитория — венчурные инвесторы&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;response&#34;</span>: <span style=color:#e6db74>&#34;[{\&#34;slide_number\&#34;:1,\&#34;title\&#34;:\&#34;Проблема рынка\&#34;...}]&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tokens_saved&#34;</span>: <span style=color:#ae81ff>2100</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;llm_provider&#34;</span>: <span style=color:#e6db74>&#34;claude&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;created_at&#34;</span>: <span style=color:#e6db74>&#34;2026-03-01T09:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;hit_count&#34;</span>: <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Стратегия семантического кэширования:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_or_create_semantic_cache</span>(
</span></span><span style=display:flex><span>    query: str,
</span></span><span style=display:flex><span>    generate_fn,
</span></span><span style=display:flex><span>    threshold: float <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.95</span>,  <span style=color:#75715e># Cosine similarity порог</span>
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 1. Получить embedding запроса</span>
</span></span><span style=display:flex><span>    query_embedding <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> embed(query)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 2. Поиск ближайшего в кэше (через Qdrant semantic cache коллекцию)</span>
</span></span><span style=display:flex><span>    cached <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> qdrant<span style=color:#f92672>.</span>search(
</span></span><span style=display:flex><span>        collection_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;semantic_cache&#34;</span>,
</span></span><span style=display:flex><span>        query_vector<span style=color:#f92672>=</span>query_embedding,
</span></span><span style=display:flex><span>        limit<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        score_threshold<span style=color:#f92672>=</span>threshold,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> cached:
</span></span><span style=display:flex><span>        cache_key <span style=color:#f92672>=</span> cached[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>payload[<span style=color:#e6db74>&#34;redis_key&#34;</span>]
</span></span><span style=display:flex><span>        entry <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> redis<span style=color:#f92672>.</span>get(cache_key)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> entry:
</span></span><span style=display:flex><span>            data <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(entry)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> redis<span style=color:#f92672>.</span>hincrby(cache_key, <span style=color:#e6db74>&#34;hit_count&#34;</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> data[<span style=color:#e6db74>&#34;response&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 3. Cache miss — вызвать LLM</span>
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> generate_fn(query)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 4. Сохранить в кэш</span>
</span></span><span style=display:flex><span>    cache_key <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;semantic_cache:</span><span style=color:#e6db74>{</span>hashlib<span style=color:#f92672>.</span>sha256(query_embedding_bytes)<span style=color:#f92672>.</span>hexdigest()[:<span style=color:#ae81ff>32</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> redis<span style=color:#f92672>.</span>setex(
</span></span><span style=display:flex><span>        cache_key,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>86400</span>,  <span style=color:#75715e># TTL 24 часа</span>
</span></span><span style=display:flex><span>        json<span style=color:#f92672>.</span>dumps({
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;original_query&#34;</span>: query,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;response&#34;</span>: response,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;created_at&#34;</span>: datetime<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>isoformat(),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;hit_count&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response
</span></span></code></pre></div><p><strong>TTL:</strong> 86400 секунд (24 часа) — outline-запросы актуальны в течение дня</p><p><strong>Инвалидация:</strong> По TTL. Принудительная инвалидация не предусмотрена (данные stateless).</p><p><strong>Причина кэширования:</strong> Согласно архитектуре, похожие outline-запросы (cosine > 0.95) отдаются из кэша без вызова LLM. Экономия: ~$0.01 на хит кэша × 1000 похожих запросов = $10/день.</p><p><strong>Риски:</strong> stale outline при изменении источников данных. <strong>Митигация:</strong> Ключ кэша включает хеш source_document_ids — при добавлении нового документа ключ меняется автоматически.</p><hr><h2 id=ключ-ratelimitapi_key_idminute>Ключ: <code>ratelimit:{api_key_id}:{minute}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-ratelimitapi_key_idminute class=anchor>#</a></h2><p><strong>Тип Redis:</strong> STRING (счётчик)</p><p><strong>Схема значения:</strong> Целое число — количество запросов в текущую минуту</p><p><strong>Пример:</strong> <code>42</code> (42 запроса из 60 разрешённых за текущую минуту)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_rate_limit</span>(api_key_id: str, limit_per_minute: int) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>    now <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>    window_key <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ratelimit:</span><span style=color:#e6db74>{</span>api_key_id<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>now<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#39;%Y%m</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>%H%M&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pipeline <span style=color:#f92672>=</span> redis<span style=color:#f92672>.</span>pipeline()
</span></span><span style=display:flex><span>    pipeline<span style=color:#f92672>.</span>incr(window_key)
</span></span><span style=display:flex><span>    pipeline<span style=color:#f92672>.</span>expire(window_key, <span style=color:#ae81ff>120</span>)  <span style=color:#75715e># TTL 2 минуты — гарантия очистки</span>
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> pipeline<span style=color:#f92672>.</span>execute()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_count <span style=color:#f92672>=</span> results[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> current_count <span style=color:#f92672>&lt;=</span> limit_per_minute
</span></span></code></pre></div><p><strong>TTL:</strong> 120 секунд (2 минуты) — скользящее окно в 1 минуту + буфер</p><p><strong>Инвалидация:</strong> Автоматически по TTL (ключ включает минуту).</p><p><strong>Причина кэширования:</strong> Низкая latency rate limiting без обращения к БД. Sliding window per API key per minute согласно: Free — 10 req/min, Pro — 60 req/min, Enterprise — custom.</p><p><strong>Риски:</strong> Race condition при высоком параллелизме — INCR атомарен в Redis, race condition отсутствует. Потеря данных при Redis failover — небольшой всплеск запросов до восстановления (допустимо).</p><hr><h2 id=ключ-ratelimituseruser_idminute>Ключ: <code>ratelimit:user:{user_id}:{minute}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-ratelimituseruser_idminute class=anchor>#</a></h2><p><strong>Тип Redis:</strong> STRING (счётчик)</p><p><strong>Назначение:</strong> Rate limiting на уровне пользователя для WebUI (не API-ключей).</p><p><strong>TTL:</strong> 120 секунд</p><p><strong>Причина кэширования:</strong> Защита от злоупотребления (abuse prevention) без нагрузки на PostgreSQL.</p><hr><h2 id=ключ-plan_limitsorganization_id>Ключ: <code>plan_limits:{organization_id}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-plan_limitsorganization_id class=anchor>#</a></h2><p><strong>Тип Redis:</strong> HASH</p><p><strong>Схема значения:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>PlanLimitsCache</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plan_name</span>: <span style=color:#66d9ef>string</span>;                  <span style=color:#75715e>// free | pro | team | enterprise
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>max_presentations_per_month</span>: <span style=color:#66d9ef>string</span>; <span style=color:#75715e>// число или &#39;unlimited&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>max_file_size_mb</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ai_tokens_per_month</span>: <span style=color:#66d9ef>string</span>;        <span style=color:#75715e>// число или &#39;unlimited&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>storage_gb</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>features</span>: <span style=color:#66d9ef>string</span>;                   <span style=color:#75715e>// JSON-строка feature-flags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>subscription_status</span>: <span style=color:#66d9ef>string</span>;        <span style=color:#75715e>// active | trialing | past_due
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>period_end</span>: <span style=color:#66d9ef>string</span>;                 <span style=color:#75715e>// ISO 8601
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><strong>Пример:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;plan_name&#34;</span>: <span style=color:#e6db74>&#34;team&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;max_presentations_per_month&#34;</span>: <span style=color:#e6db74>&#34;100&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;max_file_size_mb&#34;</span>: <span style=color:#e6db74>&#34;50&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;ai_tokens_per_month&#34;</span>: <span style=color:#e6db74>&#34;5000000&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;storage_gb&#34;</span>: <span style=color:#e6db74>&#34;50&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;features&#34;</span>: <span style=color:#e6db74>&#34;{\&#34;brand_kit\&#34;:true,\&#34;api_access\&#34;:true,\&#34;webhooks\&#34;:true}&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;subscription_status&#34;</span>: <span style=color:#e6db74>&#34;active&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;period_end&#34;</span>: <span style=color:#e6db74>&#34;2026-04-01T00:00:00Z&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>TTL:</strong> 300 секунд (5 минут)</p><p><strong>Инвалидация:</strong> При изменении тарифа через Admin API — <code>DEL plan_limits:{organization_id}</code>.</p><p><strong>Причина кэширования:</strong> Лимиты проверяются при каждом запросе на генерацию/загрузку. JOIN <code>subscriptions + plans</code> заменяется одним HGETALL.</p><p><strong>Риски:</strong> 5-минутная задержка применения нового тарифа. <strong>Митигация:</strong> При апгрейде плана — немедленная инвалидация; при даунгрейде — 5 минут некритичны.</p><hr><h2 id=ключ-usageorganization_idperiod>Ключ: <code>usage:{organization_id}:{period}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-usageorganization_idperiod class=anchor>#</a></h2><p><strong>Тип Redis:</strong> HASH</p><p><strong>Схема значения:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UsageCounters</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>presentations</span>: <span style=color:#66d9ef>string</span>;   <span style=color:#75715e>// Счётчик презентаций в текущем периоде
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>slides</span>: <span style=color:#66d9ef>string</span>;          <span style=color:#75715e>// Счётчик слайдов
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>tokens</span>: <span style=color:#66d9ef>string</span>;          <span style=color:#75715e>// Счётчик токенов
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>cost_cents</span>: <span style=color:#66d9ef>string</span>;      <span style=color:#75715e>// Стоимость в центах (для точности)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><strong>Пример:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;presentations&#34;</span>: <span style=color:#e6db74>&#34;23&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;slides&#34;</span>: <span style=color:#e6db74>&#34;312&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tokens&#34;</span>: <span style=color:#e6db74>&#34;4500000&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;cost_cents&#34;</span>: <span style=color:#e6db74>&#34;1340&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Атомарное увеличение счётчиков после генерации</span>
</span></span><span style=display:flex><span>period <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m&#34;</span>)
</span></span><span style=display:flex><span>pipe <span style=color:#f92672>=</span> redis<span style=color:#f92672>.</span>pipeline()
</span></span><span style=display:flex><span>pipe<span style=color:#f92672>.</span>hincrby(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;usage:</span><span style=color:#e6db74>{</span>org_id<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>period<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;presentations&#34;</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>pipe<span style=color:#f92672>.</span>hincrby(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;usage:</span><span style=color:#e6db74>{</span>org_id<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>period<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;slides&#34;</span>, slides_count)
</span></span><span style=display:flex><span>pipe<span style=color:#f92672>.</span>hincrby(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;usage:</span><span style=color:#e6db74>{</span>org_id<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>period<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;tokens&#34;</span>, tokens_used)
</span></span><span style=display:flex><span>pipe<span style=color:#f92672>.</span>hincrby(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;usage:</span><span style=color:#e6db74>{</span>org_id<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>period<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;cost_cents&#34;</span>, int(cost_usd <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>pipe<span style=color:#f92672>.</span>expire(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;usage:</span><span style=color:#e6db74>{</span>org_id<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>period<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>90</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>3600</span>)  <span style=color:#75715e># 90 дней</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> pipe<span style=color:#f92672>.</span>execute()
</span></span></code></pre></div><p><strong>TTL:</strong> 90 дней (7776000 секунд) — хранить счётчики за 3 прошлых месяца</p><p><strong>Инвалидация:</strong> Не инвалидируется вручную; по TTL. Периодически (раз в час) flush в <code>usage_records</code> PostgreSQL.</p><p><strong>Причина кэширования:</strong> Atomic HINCRBY без блокировок. Счётчики обновляются после каждой генерации без JOIN-запросов к PostgreSQL.</p><p><strong>Риски:</strong> При потере Redis — потеря счётчиков с момента последнего flush. <strong>Митигация:</strong> Flush каждые 15 минут в PostgreSQL через Celery beat; возможен пересчёт из <code>generation_jobs</code>.</p><hr><h2 id=ключ-celery_queuegeneration>Ключ: <code>celery_queue:generation</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-celery_queuegeneration class=anchor>#</a></h2><p><strong>Тип Redis:</strong> LIST (используется Celery)</p><p><strong>Назначение:</strong> Очередь задач генерации презентаций.</p><p><strong>Схема значения:</strong> JSON-encoded Celery task message</p><p><strong>Пример:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-celery-000000000001&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;task&#34;</span>: <span style=color:#e6db74>&#34;tasks.generation.generate_presentation&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;args&#34;</span>: [<span style=color:#e6db74>&#34;018e9a1f-b3c2-7654-9abc-def012345678&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;kwargs&#34;</span>: {},
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;retries&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;eta&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires&#34;</span>: <span style=color:#e6db74>&#34;2026-03-01T11:15:00Z&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>TTL:</strong> без TTL (Celery управляет жизненным циклом)</p><p><strong>Инвалидация:</strong> Celery worker делает LPOP при получении задачи. При revoke задачи — специальный CELERY_REVOKES set.</p><p><strong>Причина кэширования:</strong> Асинхронная очередь задач. Разделение API (приём запроса) и Worker (выполнение) — ключ паттерна.</p><p><strong>Риски:</strong> При потере Redis — потеря необработанных задач. <strong>Митигация:</strong> Persistence (AOF + RDB); <code>CELERY_TASK_TRACK_STARTED=True</code>; при старте системы — переопубликовать задачи в статусе <code>pending</code> из PostgreSQL.</p><hr><h2 id=ключ-celery_queueingestion>Ключ: <code>celery_queue:ingestion</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-celery_queueingestion class=anchor>#</a></h2><p><strong>Тип Redis:</strong> LIST</p><p><strong>Назначение:</strong> Очередь задач индексации документов (chunking + embedding). Выделена отдельно от <code>generation</code> чтобы большие файлы не блокировали генерацию.</p><p><strong>TTL:</strong> без TTL</p><hr><h2 id=ключ-celery_queueexport>Ключ: <code>celery_queue:export</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-celery_queueexport class=anchor>#</a></h2><p><strong>Тип Redis:</strong> LIST</p><p><strong>Назначение:</strong> Очередь задач экспорта (PPTX/PDF/Google Slides).</p><p><strong>TTL:</strong> без TTL</p><hr><h2 id=ключ-ws_connectionsuser_id>Ключ: <code>ws_connections:{user_id}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-ws_connectionsuser_id class=anchor>#</a></h2><p><strong>Тип Redis:</strong> SET</p><p><strong>Схема значения:</strong> Множество <code>{server_id}:{connection_id}</code> — идентификаторы WebSocket соединений пользователя (на каких Pod)</p><p><strong>Пример:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[<span style=color:#e6db74>&#34;api-pod-1:ws_abc123&#34;</span>, <span style=color:#e6db74>&#34;api-pod-1:ws_def456&#34;</span>]
</span></span></code></pre></div><p><strong>TTL:</strong> 300 секунд (обновляется при каждом heartbeat)</p><p><strong>Причина кэширования:</strong> При горизонтальном масштабировании (несколько API pod) — нужно знать, на каком pod висит WebSocket соединение пользователя для push-уведомлений (Celery worker → Pub/Sub → нужный pod → WebSocket).</p><p><strong>Инвалидация:</strong> При disconnect — SREM. По TTL при потере соединения без корректного disconnect.</p><hr><h2 id=ключ-pubsubgen_progress>Ключ: <code>pubsub:gen_progress</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-pubsubgen_progress class=anchor>#</a></h2><p><strong>Тип Redis:</strong> PUB/SUB Channel</p><p><strong>Назначение:</strong> Broadcast событий генерации от Celery workers к API pods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Worker публикует</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> redis<span style=color:#f92672>.</span>publish(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;pubsub:gen_progress&#34;</span>,
</span></span><span style=display:flex><span>    json<span style=color:#f92672>.</span>dumps({
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;job_id&#34;</span>: job_id,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;user_id&#34;</span>: user_id,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;event&#34;</span>: progress_event,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># API pod подписан и пушит в WebSocket</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_pubsub</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> redis<span style=color:#f92672>.</span>pubsub() <span style=color:#66d9ef>as</span> pubsub:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> pubsub<span style=color:#f92672>.</span>subscribe(<span style=color:#e6db74>&#34;pubsub:gen_progress&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>for</span> message <span style=color:#f92672>in</span> pubsub<span style=color:#f92672>.</span>listen():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> message[<span style=color:#e6db74>&#34;type&#34;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;message&#34;</span>:
</span></span><span style=display:flex><span>                data <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(message[<span style=color:#e6db74>&#34;data&#34;</span>])
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> data[<span style=color:#e6db74>&#34;user_id&#34;</span>] <span style=color:#f92672>in</span> local_connections:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>await</span> send_websocket(data[<span style=color:#e6db74>&#34;user_id&#34;</span>], data[<span style=color:#e6db74>&#34;event&#34;</span>])
</span></span></code></pre></div><p><strong>TTL:</strong> без TTL (pub/sub канал, не хранит данные)</p><hr><h2 id=ключ-presentation_view_countpresentation_id>Ключ: <code>presentation_view_count:{presentation_id}</code><a href=#%d0%ba%d0%bb%d1%8e%d1%87-presentation_view_countpresentation_id class=anchor>#</a></h2><p><strong>Тип Redis:</strong> STRING (счётчик)</p><p><strong>Назначение:</strong> Счётчик просмотров публичных ссылок (для быстрого отображения в UI).</p><p><strong>Пример:</strong> <code>847</code></p><p><strong>TTL:</strong> без TTL (постоянный счётчик)</p><p><strong>Инвалидация:</strong> Периодически (раз в минуту) sync в <code>presentation_shares.view_count</code> через GETSET + PostgreSQL UPDATE.</p><p><strong>Причина кэширования:</strong> INCR атомарен и O(1); исключает UPDATE-транзакции при каждом просмотре под нагрузкой.</p><p><strong>Риски:</strong> При перезапуске Redis — потеря счётчиков за период с последнего sync. <strong>Митигация:</strong> Sync каждую минуту; потеря ≤ 60 секунд просмотров — допустимо.</p><hr><h2 id=сводная-таблица-redis-ключей>Сводная таблица Redis-ключей<a href=#%d1%81%d0%b2%d0%be%d0%b4%d0%bd%d0%b0%d1%8f-%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-redis-%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%b9 class=anchor>#</a></h2><table><thead><tr><th>Ключ</th><th>Тип</th><th>TTL</th><th>Назначение</th></tr></thead><tbody><tr><td><code>session:{id}</code></td><td>HASH</td><td>24ч</td><td>Данные сессии пользователя</td></tr><tr><td><code>user_sessions:{user_id}</code></td><td>SET</td><td>24ч</td><td>Список сессий для revoke</td></tr><tr><td><code>gen_checkpoint:{job_id}</code></td><td>HASH</td><td>1ч</td><td>Checkpoint генерации (recovery)</td></tr><tr><td><code>gen_progress:{job_id}</code></td><td>STREAM</td><td>2ч</td><td>Прогресс для WebSocket</td></tr><tr><td><code>semantic_cache:{hash}</code></td><td>STRING</td><td>24ч</td><td>Кэш LLM-ответов</td></tr><tr><td><code>ratelimit:{key_id}:{min}</code></td><td>STRING</td><td>2мин</td><td>Rate limiting API keys</td></tr><tr><td><code>ratelimit:user:{uid}:{min}</code></td><td>STRING</td><td>2мин</td><td>Rate limiting UI users</td></tr><tr><td><code>plan_limits:{org_id}</code></td><td>HASH</td><td>5мин</td><td>Лимиты тарифа организации</td></tr><tr><td><code>usage:{org_id}:{period}</code></td><td>HASH</td><td>90д</td><td>Счётчики использования</td></tr><tr><td><code>celery_queue:generation</code></td><td>LIST</td><td>—</td><td>Очередь генерации</td></tr><tr><td><code>celery_queue:ingestion</code></td><td>LIST</td><td>—</td><td>Очередь индексации</td></tr><tr><td><code>celery_queue:export</code></td><td>LIST</td><td>—</td><td>Очередь экспорта</td></tr><tr><td><code>ws_connections:{user_id}</code></td><td>SET</td><td>5мин</td><td>WebSocket соединения пользователя</td></tr><tr><td><code>pubsub:gen_progress</code></td><td>PUB/SUB</td><td>—</td><td>Broadcast прогресса</td></tr><tr><td><code>presentation_view_count:{id}</code></td><td>STRING</td><td>—</td><td>Счётчик просмотров</td></tr></tbody></table><script lang=js>const innerPages=document.getElementById("inner-pages");innerPages&&innerPages.querySelectorAll("li").forEach(e=>{e.addEventListener("click",()=>{const t=e.innerText.trim();if(openedMenu){if(openedMenu.includes(t)){const e=openedMenu.findIndex(e=>e===t);openedMenu.splice(e,1)}else openedMenu.push(t);localStorage.setItem("openedMenu",JSON.stringify(openedMenu))}else localStorage.setItem("openedMenu","["+t+"]")})})</script><nav class=pagination><a class="nav nav-prev" href=https://example.org/03_backend/01_info_models/vector_store/ title="Векторное хранилище (Qdrant)"><i class="fa fa-arrow-left" aria-hidden=true></i> Предыдущее - Векторное хранилище (Qdrant)</a>
<a class="nav nav-next" href=https://example.org/03_backend/02_rest_methods/ title="REST API">Следующее - REST API <i class="fa fa-arrow-right" aria-hidden=true></i></a></nav></div><div class="column is-sticky is-paddingless" id=tocWrapper><div class=is-paddingless id=tocContainer><div id=tocContent><div class=additionalinfo><span id=method_name>Кэш и очереди (Redis)</span>
<strong>Описание:</strong> Схемы Redis-ключей: сессии, семантический кэш LLM, checkpoint генерации, rate limiting.</div><div class=toc-header><h6 class="toc-title is-marginless">Содержание:On this page:</h6><i title="Back to top" id=tocBackToTop class="fa-solid fa-circle-arrow-up"></i></div><div id=toc><nav id=TableOfContents><ul><li><a href=#ключ-sessionsession_id>Ключ: <code>session:{session_id}</code></a></li><li><a href=#ключ-user_sessionsuser_id>Ключ: <code>user_sessions:{user_id}</code></a></li><li><a href=#ключ-gen_checkpointjob_id>Ключ: <code>gen_checkpoint:{job_id}</code></a></li><li><a href=#ключ-gen_progressjob_id>Ключ: <code>gen_progress:{job_id}</code></a></li><li><a href=#ключ-semantic_cachehash>Ключ: <code>semantic_cache:{hash}</code></a></li><li><a href=#ключ-ratelimitapi_key_idminute>Ключ: <code>ratelimit:{api_key_id}:{minute}</code></a></li><li><a href=#ключ-ratelimituseruser_idminute>Ключ: <code>ratelimit:user:{user_id}:{minute}</code></a></li><li><a href=#ключ-plan_limitsorganization_id>Ключ: <code>plan_limits:{organization_id}</code></a></li><li><a href=#ключ-usageorganization_idperiod>Ключ: <code>usage:{organization_id}:{period}</code></a></li><li><a href=#ключ-celery_queuegeneration>Ключ: <code>celery_queue:generation</code></a></li><li><a href=#ключ-celery_queueingestion>Ключ: <code>celery_queue:ingestion</code></a></li><li><a href=#ключ-celery_queueexport>Ключ: <code>celery_queue:export</code></a></li><li><a href=#ключ-ws_connectionsuser_id>Ключ: <code>ws_connections:{user_id}</code></a></li><li><a href=#ключ-pubsubgen_progress>Ключ: <code>pubsub:gen_progress</code></a></li><li><a href=#ключ-presentation_view_countpresentation_id>Ключ: <code>presentation_view_count:{presentation_id}</code></a></li><li><a href=#сводная-таблица-redis-ключей>Сводная таблица Redis-ключей</a></li></ul></nav></div><ul class=info style="line-height:1.2;list-style-type:none;border:1px solid;border-radius:1px;padding:5px;margin:16px 10px 0;color:#000"></ul><div id=taxonomies><div class=taxonomy-wrapper></div><div class=taxonomy-wrapper></div></div><div class=toc-header><div class=edit-meta></div></div></div></div><div class=is-paddingless id=tocCollapsible title="Collapse/Uncollapse table of contents"><i class="fa-solid fa-angles-right fa-lg"></i></div></div></div></div><script type=text/javascript>const baseUrl="https://example.org/",codeCopyBefore="Copy to clipboard",codeCopyAfter="Copied to clipboard",svgDownloadLabel="Download as SVG",helperLoadingLabel="Loading",searchNoResults="No result found",introNextLabel="Next",introPrevLabel="Previous",introSkipLabel="✗",introDoneLabel="Done",printLabel="Print current page",qrCodeLabel="Show current page QR code",naCommonLabel="Not available"</script><script type=module src=/js/theme/modules/const.min.js></script><script type=module src=/js/theme/modules/helpers.min.js></script><script type=module src=/js/theme/modules/helpersGlobal.min.js></script><script type=module src=/js/theme/init.min.js></script><script type=module src=/js/theme/navbar.min.js></script><script type=module src=/js/theme/print.min.js></script><script type=module src=/js/theme/qrcode.min.js></script><script type=module src=/js/theme/search.min.js></script><script type=module src=/js/theme/shortcuts.min.js></script><script type=module src=/js/theme/sidebar.min.js></script><script type=module src=/js/theme/toc.min.js></script><script type=text/javascript src=/js/external/jquery/jquery-3.6.3.min.js></script><script type=text/javascript src=/js/external/tippy/popper.min.js></script><script type=text/javascript src=/js/external/tippy/tippy-bundle.umd.min.js></script><script type=text/javascript src=/js/external/markmap/markmap-autoloader.min.js></script><script type=text/javascript src=/js/theme/browserCompatibility.min.js></script><script type=text/javascript src=/js/external/flexsearch/flexsearch.bundle.min.js></script><script type=text/javascript src=/js/external/qrious/qrious.min.js></script><script type=text/javascript src=/js/external/overlay-scrollbars/overlayscrollbars.min.js></script><script type=text/javascript src=/js/external/markmap/markmap.min.js></script><script type=text/javascript src=/js/external/readfile/rawdeflate.min.js></script><script type=text/javascript src=/js/external/1ce05b4b.min.js></script><script type=text/javascript src=/js/external/techradar/d3.v4.min.js></script><script type=text/javascript src=/js/external/techradar/radar.min.js></script><script type=text/javascript src=/js/external/bpmn-visualization/bpmn-visualization.min.js></script><script type=text/javascript src=/js/external/sorttable/sorttable.min.js></script><script type=text/javascript src=/js/external/mermaid/svg-pan-zoom.min.js></script><script type=text/javascript src=/js/external/simplesearch/simplesearch.min.js></script><script>$("table").addClass("sortable")</script></body></html>