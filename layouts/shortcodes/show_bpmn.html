{{ $file := .Get 0 }}
{{ $containerName := print "id" (index (shuffle (seq 0 1999)) 0) }}

<!--script type="text/javascript" src="/01_overview/bpmn-visualization.js"></script-->

<button id="btn-reset-{{ $containerName }}" title="Исходная позиция" class="btn btn-primary has-icon-right">
  <span>Показать всю диаграмму </span><span class="icon icon-refresh mb-1"></span>
</button>
<button id="btn-toggle-scrollbars-{{ $containerName }}" title="Показать Scrollbars"
  class="btn btn-secondary has-icon-right">
  <span>Показать Scrollbars </span><span class="icon icon-apps mb-1"></span>
</button>

{{- $noticeType := "info" -}}

<div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg">
    <symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">
      <path
        d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z" />
    </symbol>
    <symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">
      <path
        d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z" />
    </symbol>
    <symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet">
      <path
        d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z" />
    </symbol>
    <symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">
      <path
        d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z" />
    </symbol>
  </svg></div>
<div class="notice {{ $noticeType }}" {{ if len .Params | eq 2 }} id="{{ .Get 1 }}" {{ end }}>
  <p class="first notice-title"><span class="icon-notice baseline"><svg>
        <use href="#{{- $noticeType -}}-notice"></use>
      </svg></span>{{- i18n $noticeType -}}</p>
  <ul>
    <li>Для масштабирования диаграммы нажмите кнопку <strong>Ctrl</strong> и крутите колесо мыши.</li>
    <li>Удерживая нажатой левую кнопку мыши на диаграмме - можно перемещать диаграмму.</li>
  </ul>
</div>

<script type='text/javascript'>

  window.addEventListener('DOMContentLoaded', (event) => {

    const file = '{{ $file }}';
    const containerName = '{{ $containerName }}';
    const bpmnContainer = document.getElementById(containerName);
    const bpmnVisualization = new bpmnvisu.BpmnVisualization({
      container: bpmnContainer,
      navigation: { enabled: true },
      renderer: { ignoreBpmnColors: false }
    });

    var rawFile = new XMLHttpRequest();
    rawFile.open("GET", file, false);

    rawFile.onreadystatechange = function () {
      if (rawFile.readyState === 4) {
        if (rawFile.status === 200 || rawFile.status == 0) {
          bpmnVisualization.load(rawFile.responseText, { fit: { type: 'Center', margin: 10 } });
        }
      }
    }

    rawFile.send(null);
    let displayScrollBars = false;

    document.getElementById('btn-reset-' + containerName).onclick = function () {
      bpmnVisualization.navigation.fit({ type: bpmnvisu.FitType.Center });
      displayScrollBars && bpmnContainer.scrollTo(0, 0);
    };

    document.getElementById('btn-toggle-scrollbars-' + containerName).onclick = function () {
      displayScrollBars = !displayScrollBars;
      bpmnContainer.style.overflow = displayScrollBars ? 'auto' : 'hidden';
    };

    const registeredBpmnElements = new Map();
    const bpmnElementsRegistry = bpmnVisualization.bpmnElementsRegistry;
    const headerKeys = ['name', 'url', 'urlDescription', 'comment'];
    const bpmnSemanticConversionMap = new Map([['isShape', { transformedKey: 'representation', transformFunction: (bpmnSemantic) => bpmnSemantic.isShape ? 'Shape' : 'Edge' }]]);

    tippy.setDefaultProps({
      content: 'Загрузка...',
      allowHTML: true,
      arrow: false,
      onShow(instance) {
        instance.setContent(getBpmnElementInfoAsHtml(instance.reference));
      },
      onHidden(instance) {
        instance.setContent('Загрузка...');
      },

      popperOptions: {
        positionFixed: true,
      },

      sticky: 'popper',
      maxWidth: 275,

      // Don't consider `data-tippy-*` attributes on the reference element as we fully manage tippy with JavaScript
      // and we cannot update the reference here as it is generated by bpmn-visualization
      ignoreAttributes: true,

      // Нужно для возможности копировать данные из окна со свойствами узла bpmn диаграммы
      interactive: true,
    });

    // Можно использовать константы:
    // ShapeBpmnElementKind.TASK_SCRIPT, ShapeBpmnElementKind.GATEWAY_EXCLUSIVE, ShapeBpmnElementKind.TASK_SERVICE
    // вместо строк:
    // "scriptTask", "exclusiveGateway", "serviceTask", "userTask", "task", "callActivity"
    const elementsWithPopover = bpmnElementsRegistry.getElementsByKinds(["scriptTask", "exclusiveGateway", "serviceTask", "userTask", "task", "callActivity", "sendTask", "receiveTask"]);
    
    addPopover(elementsWithPopover);

    function addPopover(bpmnElements) {

      registerBpmnElements(bpmnElements);
      bpmnVisualization.bpmnElementsRegistry.addCssClasses(bpmnElements.map(element => element.bpmnSemantic.id), 'c-hand');
      const htmlElements = bpmnElements.map(elt => elt.htmlElement);
      const popoverContainer = document.getElementById("tocContent");

      tippy(htmlElements, {
        appendTo: popoverContainer,
        sticky: 'reference',
        duration: 0,
        delay: [0, 0],
        theme: 'light-border',
        trigger: 'click',
        getReferenceClientRect: () => ({
          /*
          width: 100,
          height: 100,
          left: 0,
          right: 200,
          */
          top: 600,
          // bottom: 200,
        }),
      });
    }

    function registerBpmnElements(bpmnElements) {
      bpmnElements.forEach(elt => registeredBpmnElements.set(elt.htmlElement, elt.bpmnSemantic));
    }

    function getBpmnElementInfoAsHtml(htmlElement) {
      const bpmnSemantic = registeredBpmnElements.get(htmlElement);
      const secondaryKeys = Object.keys(bpmnSemantic).filter(key => !headerKeys.includes(key));
      return `<div class="bpmn-popover">
        <strong>Информация об узле</strong>
        <hr>
        ${computeBpmnInfoForPopover(headerKeys, bpmnSemantic)}
        </div>`;
    }

    // <hr>
    // ${computeBpmnInfoForPopover(secondaryKeys, bpmnSemantic, true, true)}

    function computeBpmnInfoForPopover(keys, bpmnSemantic, sort = false, filterUndefinedValue = true) {
      return keys.map(key => getConvertedBpmnSemanticValue(key, bpmnSemantic))
        .sort((a, b) => sort ? a.key.localeCompare(b.key) : 0)
        .filter(obj => filterUndefinedValue ? obj.value !== 'N/A' : true)
        .map(obj => `<b>${obj.key}</b>: ${obj.value}`)
        .join('<br>\n');
    }

    function getConvertedBpmnSemanticValue(key, bpmnSemantic) {
      const convertedBpmnSemantic = bpmnSemanticConversionMap.get(key) || { transformedKey: key, transformFunction: (bpmnSemantic) => bpmnSemantic[key] || 'N/A' };
      return { key: convertedBpmnSemantic.transformedKey, value: convertedBpmnSemantic.transformFunction(bpmnSemantic) }
    }
  });
</script>

<a href="{{ $file }}" download>Скачать исходный файл диаграммы JSON</a>
<div id="{{ $containerName }}" class="bpmn-container"></div>